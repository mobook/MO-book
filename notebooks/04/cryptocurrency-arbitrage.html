

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Cryptocurrency arbitrage search &#8212; Companion Notebooks for Data-Driven Optimization in Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-DVQ7NZ8CYZ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DVQ7NZ8CYZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/04/cryptocurrency-arbitrage';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Extra material: Shortest path in real life" href="shortest-path-road-networks.html" />
    <link rel="prev" title="Gasoline distribution" href="gasoline-distribution.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo-02.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/logo-02.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Data-Driven Mathematical Optimization in Python
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/01.00.html">1. Mathematical Optimization</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/production-planning.html">A Production Planning Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/production-planning-basic.html">A Basic Pyomo Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/production-planning-advanced.html">A Data-Driven Pyomo Model</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/02.00.html">2. Linear Optimization</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/bim.html">BIM production</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/lad-regression.html">LAD Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/mad-portfolio-optimization.html">MAD portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/L1-regression-wine-quality.html">Wine quality prediction with L1 regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/bim-maxmin.html">BIM production for worst case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/bim-fractional.html">BIM production variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/bim-rawmaterialplanning.html">BIM production using demand forecasts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/multiproductionfaciliity_worstcase.html">Extra material: Multi-product facility production</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../03/03.00.html">3. Mixed Integer Linear Programming</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../03/bim-perturbed.html">BIM production with perturbed data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/shift-scheduling.html">Workforce shift scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/simple-production-model-gdp.html">Production model using disjunctions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/machine-scheduling.html">Machine Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/recharging-electric-vehicle.html">Recharging strategy for an electric vehicle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/bim-production-revisited.html">BIM production revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/cryptarithms.html">Extra material: Cryptarithms puzzle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/strip-packing.html">Extra material: Strip packing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/job-shop-scheduling.html">Extra material: Job shop scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/maintenance-planning.html">Extra material: Maintenance planning</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="04.00.html">4. Network Optimization</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dinner-seat-allocation.html">Dinner seating arrangement</a></li>

<li class="toctree-l2"><a class="reference internal" href="gasoline-distribution.html">Gasoline distribution</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Cryptocurrency arbitrage search</a></li>
<li class="toctree-l2"><a class="reference internal" href="shortest-path-road-networks.html">Extra material: Shortest path in real life</a></li>



<li class="toctree-l2"><a class="reference internal" href="power-network.html">Extra material: Energy dispatch problem</a></li>




</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../05/05.00.html">5. Convex Optimization</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../05/milk-pooling.html">Milk pooling and blending</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/ols-regression.html">Ordinary Least Squares (OLS) Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/markowitz_portfolio.html">Markowitz portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/svm-linear.html">Support Vector Machines for Binary Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/refinery-production.html">Extra material: Refinery production and shadow pricing</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../06/06.00.html">6. Conic Optimization</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../06/economic-order-quantity.html">Economic Order Quantity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/kelly-criterion.html">The Kelly Criterion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/markowitz_portfolio_revisited.html">Markowitz portfolio optimization revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/building-insulation.html">Optimal Design of Multilayered Building Insulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/investment-wheel.html">Extra material: Luenberger’s Investment Wheel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/optimal-growth-portfolios.html">Extra material: Optimal Growth Portfolios</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../07/07.00.html">7. Accounting for Uncertainty: Optimization Meets Reality</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../07/fleet-assignment.html">Fleet assignment problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/bim-robustness-analysis.html">Robustness analysis of BIM production plan via simulations</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../08/08.00.html">8. Robust Optimization - Single Stage Problems</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../08/bim-robust-optimization.html">Robust BIM microchip production problem</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../09/09.00.html">9. Stochastic Optimization - Single Stage Problems</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../09/pop-up_shop.html">Pop-up shop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/markowitz_portfolio_with_chance_constraint.html">Markowitz portfolio optimization with chance constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/seafood.html">Stock optimization for seafood distribution center</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../10/10.00.html">10. Two-Stage Problems</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../10/airline-seating.html">Airline seat allocation problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/farmer.html">The Farmer’s Problem and Variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/opf-wind-curtailment.html">Two-stage energy dispatch optimization with wind curtailment</a></li>

<li class="toctree-l2"><a class="reference internal" href="../10/opf-ldr.html">Two-stage energy dispatch optimization using linear decision rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/ccg.html">Two-stage Production Planning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../pyomo_style_guide.html">Appendix: Pyomo style guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/mobook/MO-book/blob/main/notebooks/04/cryptocurrency-arbitrage.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mobook/MO-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mobook/MO-book/issues/new?title=Issue%20on%20page%20%2Fnotebooks/04/cryptocurrency-arbitrage.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/04/cryptocurrency-arbitrage.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cryptocurrency arbitrage search</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installations-and-imports">Installations and Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-and-solvers">Pyomo and Solvers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ccxt">CCXT</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#networkx">Networkx</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cryptocurrency-exchanges">Cryptocurrency exchanges</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-an-exchange-as-a-directed-graph">Representing an exchange as a directed graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exchange-order-book">Exchange order book</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelling-the-arbitrage-search-problem-as-a-graph">Modelling the arbitrage search problem as a graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trading-and-arbitrage">Trading and Arbitrage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-order-books-that-demonstrate-arbitrage-opportunities">Find order books that demonstrate arbitrage opportunities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#brute-force-search-arbitrage-with-simple-cycles">Brute force search arbitrage with simple cycles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-model-for-arbitrage-with-capacity-constraints">Pyomo Model for Arbitrage with Capacity Constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-to-the-user">Questions to the user</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-time-downloads-of-order-books-from-an-exchange">Real Time Downloads of Order Books from an Exchange</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <span class="target" id="index-0"></span><span class="target" id="index-1"></span><span class="target" id="index-2"></span><span class="target" id="index-3"></span><span class="target" id="index-4"></span><section class="tex2jax_ignore mathjax_ignore" id="cryptocurrency-arbitrage-search">
<span id="index-5"></span><h1>Cryptocurrency arbitrage search<a class="headerlink" href="#cryptocurrency-arbitrage-search" title="Permalink to this heading">#</a></h1>
<p>Cryptocurrency exchanges are web services that enable the purchase, sale, and exchange of cryptocurrencies. These exchanges provide liquidity for owners and establish the relative value of these currencies. Joining an exchange enables a user to maintain multiple currencies in a digital wallet, buy and sell currencies, and to use cryptocurrencies for financial transactions.</p>
<p>In this example, we explore the efficiency of cryptocurrency exchanges by testing for arbitrage opportunities. An arbitrage exists if a customer can realize a net profit through a sequence of risk-free trades. The efficient market hypothesis assumes arbitrage opportunities are quickly identified and exploited by investors. As a result of their trading, prices reach a new equilibrium so that any arbitrage opportunities would be small and fleeting in an efficient market. The question here is whether it is possible, with real-time data and rapid execution, for a trader to profit from these fleeting arbitrage opportunities.</p>
<section id="installations-and-imports">
<h2>Installations and Imports<a class="headerlink" href="#installations-and-imports" title="Permalink to this heading">#</a></h2>
<section id="pyomo-and-solvers">
<h3>Pyomo and Solvers<a class="headerlink" href="#pyomo-and-solvers" title="Permalink to this heading">#</a></h3>
<p>First we import Pyomo and necessary solvers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># install Pyomo and solvers</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/mobook/MO-book/main/python/helper.py&quot;</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="s2">&quot;helper&quot;</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">helper</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

<span class="n">helper</span><span class="o">.</span><span class="n">install_pyomo</span><span class="p">()</span>
<span class="n">helper</span><span class="o">.</span><span class="n">install_cbc</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pyomo was previously installed
cbc was previously installed
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="ccxt">
<h3>CCXT<a class="headerlink" href="#ccxt" title="Permalink to this heading">#</a></h3>
<p>In addition to Pyomo and other standard Python libraries, this notebook uses the <a class="reference external" href="https://github.com/ccxt/ccxt">open-source library <code class="docutils literal notranslate"><span class="pre">ccxt</span></code></a>. <code class="docutils literal notranslate"><span class="pre">ccxt</span></code> supports the real-time APIs of the largest and most common exchanges on which cryptocurrencies are traded. The library can be installed with</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>!pip install ccxt
</pre></div>
</div>
<p>Here we import all needed libraries and <code class="docutils literal notranslate"><span class="pre">ccxt</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyomo.environ</span> <span class="k">as</span> <span class="nn">pyo</span>
<span class="kn">import</span> <span class="nn">ccxt</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="networkx">
<h3>Networkx<a class="headerlink" href="#networkx" title="Permalink to this heading">#</a></h3>
<p>This notebook uses the <a class="reference external" href="https://networkx.org/">networkx</a> library to display exchange and market data. Networkx has been updated recently to version 3.0, but that update has not yet propogated through common Python distributions. If the code that follows in this notebook may generate errors on displaying networkx diagrams, it may be necessary to update the networkx library. This can be done with the following command executed in a new cell.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>!pip install networkx --upgrade
</pre></div>
</div>
</section>
</section>
<section id="cryptocurrency-exchanges">
<h2>Cryptocurrency exchanges<a class="headerlink" href="#cryptocurrency-exchanges" title="Permalink to this heading">#</a></h2>
<p>Cryptocurrency exchanges are digital marketplaces for buying and trading cryptocurrencies. Joining an exchange enables a member to maintain multiple currencies in a digital wallet, to buy and sell currencies, and to use cryptocurrencies for financial transactions.  Here we import the library and list current exchanges supported by <code class="docutils literal notranslate"><span class="pre">ccxt</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available exchanges:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ccxt</span><span class="o">.</span><span class="n">exchanges</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">exchange</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Available exchanges:

  1) ace                   2) alpaca                3) ascendex              4) bequant             
  5) bigone                6) binance               7) binancecoinm          8) binanceus           
  9) binanceusdm          10) bit2c                11) bitbank              12) bitbay              
 13) bitbns               14) bitcoincom           15) bitfinex             16) bitfinex2           
 17) bitflyer             18) bitforex             19) bitget               20) bithumb             
 21) bitmart              22) bitmex               23) bitopro              24) bitpanda            
 25) bitrue               26) bitso                27) bitstamp             28) bitstamp1           
 29) bittrex              30) bitvavo              31) bkex                 32) bl3p                
 33) blockchaincom        34) btcalpha             35) btcbox               36) btcex               
 37) btcmarkets           38) btctradeua           39) btcturk              40) buda                
 41) bybit                42) cex                  43) coinbase             44) coinbaseprime       
 45) coinbasepro          46) coincheck            47) coinex               48) coinfalcon          
 49) coinmate             50) coinone              51) coinspot             52) cryptocom           
 53) currencycom          54) delta                55) deribit              56) digifinex           
 57) exmo                 58) flowbtc              59) fmfwio               60) gate                
 61) gateio               62) gemini               63) hitbtc               64) hitbtc3             
 65) hollaex              66) huobi                67) huobijp              68) huobipro            
 69) idex                 70) independentreserve   71) indodax              72) itbit               
 73) kraken               74) krakenfutures        75) kucoin               76) kucoinfutures       
 77) kuna                 78) latoken              79) lbank                80) lbank2              
 81) luno                 82) lykke                83) mercado              84) mexc                
 85) mexc3                86) ndax                 87) novadax              88) oceanex             
 89) okcoin               90) okex                 91) okex5                92) okx                 
 93) paymium              94) phemex               95) poloniex             96) poloniexfutures     
 97) probit               98) ripio                99) stex                100) tidex               
101) timex               102) tokocrypto          103) upbit               104) wavesexchange       
105) wazirx              106) whitebit            107) woo                 108) yobit               
109) zaif                110) zb                  111) zonda               
</pre></div>
</div>
</div>
</div>
</section>
<section id="representing-an-exchange-as-a-directed-graph">
<h2>Representing an exchange as a directed graph<a class="headerlink" href="#representing-an-exchange-as-a-directed-graph" title="Permalink to this heading">#</a></h2>
<p>First, we need some terminology. Trading between two specific currencies is called a market, with each exchange hosting multiple markets. <code class="docutils literal notranslate"><span class="pre">ccxt</span></code> labels each market with a symbol common across exchanges. The market symbol is an upper-case string with abbreviations for a pair of traded currencies separated by a slash (<span class="math notranslate nohighlight">\(/\)</span>). The first abbreviation is the base currency, the second is the quote currency. Prices for the base currency are denominated in units of the quote currency. As an example, <span class="math notranslate nohighlight">\(ETH/BTC\)</span> refers to a market for the base currency Ethereum (ETH) quoted in units of the Bitcoin (BTC). The same market symbol can refer to an offer to sell the base currency (a ‘bid’) or to an offer to sell the base currency (an ‘ask’). For example, <span class="math notranslate nohighlight">\(x\)</span> ETH/BTC means you can buy <span class="math notranslate nohighlight">\(x\)</span> units of BTC with one unit of ETH.</p>
<p>An exchange can be represented by a directed graph constructed from the market symbols available on that exchange. There, currencies correspond to nodes on the directed graph. Market symbols correspond to edges in the directed graph, with the source indicating the quote currency and the destination indicating the base currency. The following code develops such a sample graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># global variables used in subsequent cells</span>

<span class="c1"># create an exchange object</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binanceus</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_dg</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">minimum_in_degree</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a directed graph constructed from the market symbols on a specified exchange.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">markets</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">load_markets</span><span class="p">()</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="n">markets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="c1"># create an edge for all market symbols</span>
    <span class="n">dg</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="ow">in</span> <span class="p">[</span><span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">]:</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># remove base currencies with in_degree less than minimum_in_degree</span>
    <span class="n">remove_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">dg</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dg</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_in_degree</span><span class="p">]</span>
    <span class="n">dg</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">remove_nodes</span><span class="p">)</span>
    
    <span class="c1"># color quote currencies in gold</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gold&quot;</span> <span class="k">if</span> <span class="n">dg</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;lightblue&quot;</span>

    <span class="k">return</span> <span class="n">dg</span>

<span class="k">def</span> <span class="nf">draw_dg</span><span class="p">(</span><span class="n">dg</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw directed graph of markets symbols.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_nodes</span><span class="p">))</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
        <span class="n">dg</span><span class="p">,</span> 
        <span class="n">pos</span><span class="p">,</span>
        <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">node_color</span><span class="o">=</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">()],</span>
        <span class="n">edge_color</span><span class="o">=</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">],</span>
        <span class="n">node_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">arrowsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">connectionstyle</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;arc3, rad=</span><span class="si">{</span><span class="n">rad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span><span class="n">dg</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">edge_labels</span><span class="o">=</span><span class="p">{(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">()})</span>

    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

<span class="n">minimum_in_degree</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">dg</span> <span class="o">=</span> <span class="n">get_dg</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">minimum_in_degree</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">draw_dg</span><span class="p">(</span><span class="n">dg</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">exchange</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Minimum in Degree (Base Currencies) = </span><span class="si">{</span><span class="n">minimum_in_degree</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of nodes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of edges = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of nodes =  15
Number of edges =  60
</pre></div>
</div>
<img alt="../../_images/2e88cc470b57d774981e3146ff922cee37a1236bdad1b48462959f1d27c41d87.png" src="../../_images/2e88cc470b57d774981e3146ff922cee37a1236bdad1b48462959f1d27c41d87.png" />
</div>
</div>
</section>
<section id="exchange-order-book">
<h2>Exchange order book<a class="headerlink" href="#exchange-order-book" title="Permalink to this heading">#</a></h2>
<p>The order book for a currency exchange is the real-time inventory of trading orders.</p>
<p>A <strong>bid</strong> is an offer to buy up to a specified amount of the base currency at the price not exceeding the ‘bid price’ in the quote currency.  An <strong>ask</strong> is an offer to sell up to a specified amount of the base currency at a price no less than a value specified given in the quote currency.</p>
<p>The exchange attempts to match the bid to ask order at a price less than or equal to the bid price. If a transaction occurs, the  buyer will receive an amount of base currency less than or equal to the bid volume and the ask volume, at a price less than or equal to the bid price and no less than the specified value.</p>
<p>The order book for currency exchange is the real-time inventory of orders. The exchange order book maintains a list of all active orders for symbols traded on the exchange. Incoming bids above the lowest ask or incoming asks below the highest bid will be immediately matched and transactions executed following the rules of the exchange.</p>
<p>The following cell reads and displays a previously saved order book.  Cells at the end of this notebook demonstrate how to retrieve an order book from an exchange and save it as a Pandas DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>

<span class="c1"># find all previously saved order books</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*orderbook*&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)))</span>
<span class="n">fname</span> <span class="o">=</span> <span class="n">fnames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># read the oldest</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reading: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading: Binance_US_orderbook_saved.csv
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>timestamp</th>
      <th>base</th>
      <th>quote</th>
      <th>bid_price</th>
      <th>bid_volume</th>
      <th>ask_price</th>
      <th>ask_volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ETH/BTC</td>
      <td>2023-03-02 15:36:06.529</td>
      <td>ETH</td>
      <td>BTC</td>
      <td>0.069735</td>
      <td>0.012000</td>
      <td>0.069759</td>
      <td>0.050000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BNB/BTC</td>
      <td>2023-03-02 15:36:06.583</td>
      <td>BNB</td>
      <td>BTC</td>
      <td>0.012743</td>
      <td>0.050000</td>
      <td>0.012755</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ADA/BTC</td>
      <td>2023-03-02 15:36:06.637</td>
      <td>ADA</td>
      <td>BTC</td>
      <td>0.000015</td>
      <td>2.000000</td>
      <td>0.000015</td>
      <td>2168.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SOL/BTC</td>
      <td>2023-03-02 15:36:06.690</td>
      <td>SOL</td>
      <td>BTC</td>
      <td>0.000935</td>
      <td>1.420000</td>
      <td>0.000936</td>
      <td>15.120000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MATIC/BTC</td>
      <td>2023-03-02 15:36:06.750</td>
      <td>MATIC</td>
      <td>BTC</td>
      <td>0.000052</td>
      <td>26.200000</td>
      <td>0.000052</td>
      <td>150.200000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>MANA/BTC</td>
      <td>2023-03-02 15:36:06.848</td>
      <td>MANA</td>
      <td>BTC</td>
      <td>0.000027</td>
      <td>831.000000</td>
      <td>0.000027</td>
      <td>1409.000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>TRX/BTC</td>
      <td>2023-03-02 15:36:06.905</td>
      <td>TRX</td>
      <td>BTC</td>
      <td>0.000003</td>
      <td>4.000000</td>
      <td>0.000003</td>
      <td>25352.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>ADA/ETH</td>
      <td>2023-03-02 15:36:06.960</td>
      <td>ADA</td>
      <td>ETH</td>
      <td>0.000214</td>
      <td>994.900000</td>
      <td>0.000214</td>
      <td>891.600000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>BTC/USDT</td>
      <td>2023-03-02 15:36:07.012</td>
      <td>BTC</td>
      <td>USDT</td>
      <td>23373.920000</td>
      <td>0.118619</td>
      <td>23376.000000</td>
      <td>0.045275</td>
    </tr>
    <tr>
      <th>9</th>
      <td>ETH/USDT</td>
      <td>2023-03-02 15:36:07.065</td>
      <td>ETH</td>
      <td>USDT</td>
      <td>1630.200000</td>
      <td>0.950000</td>
      <td>1630.770000</td>
      <td>0.500000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>BNB/USDT</td>
      <td>2023-03-02 15:36:07.118</td>
      <td>BNB</td>
      <td>USDT</td>
      <td>297.857700</td>
      <td>0.800000</td>
      <td>297.891900</td>
      <td>0.800000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>ADA/USDT</td>
      <td>2023-03-02 15:36:07.172</td>
      <td>ADA</td>
      <td>USDT</td>
      <td>0.348630</td>
      <td>1100.000000</td>
      <td>0.348750</td>
      <td>511.200000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>BUSD/USDT</td>
      <td>2023-03-02 15:36:07.226</td>
      <td>BUSD</td>
      <td>USDT</td>
      <td>0.999500</td>
      <td>293433.930000</td>
      <td>0.999600</td>
      <td>317175.730000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>SOL/USDT</td>
      <td>2023-03-02 15:36:07.288</td>
      <td>SOL</td>
      <td>USDT</td>
      <td>21.857000</td>
      <td>22.870000</td>
      <td>21.863500</td>
      <td>23.000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>USDC/USDT</td>
      <td>2023-03-02 15:36:07.342</td>
      <td>USDC</td>
      <td>USDT</td>
      <td>1.000100</td>
      <td>307657.000000</td>
      <td>1.000200</td>
      <td>299181.000000</td>
    </tr>
    <tr>
      <th>15</th>
      <td>MATIC/USDT</td>
      <td>2023-03-02 15:36:07.394</td>
      <td>MATIC</td>
      <td>USDT</td>
      <td>1.203000</td>
      <td>1664.600000</td>
      <td>1.205000</td>
      <td>5405.600000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>MANA/USDT</td>
      <td>2023-03-02 15:36:07.447</td>
      <td>MANA</td>
      <td>USDT</td>
      <td>0.631000</td>
      <td>157.000000</td>
      <td>0.632200</td>
      <td>571.000000</td>
    </tr>
    <tr>
      <th>17</th>
      <td>TRX/USDT</td>
      <td>2023-03-02 15:36:07.501</td>
      <td>TRX</td>
      <td>USDT</td>
      <td>0.069280</td>
      <td>10824.900000</td>
      <td>0.069330</td>
      <td>10818.600000</td>
    </tr>
    <tr>
      <th>18</th>
      <td>BTC/BUSD</td>
      <td>2023-03-02 15:36:07.612</td>
      <td>BTC</td>
      <td>BUSD</td>
      <td>23371.440000</td>
      <td>0.021500</td>
      <td>23376.830000</td>
      <td>0.021500</td>
    </tr>
    <tr>
      <th>19</th>
      <td>BNB/BUSD</td>
      <td>2023-03-02 15:36:07.665</td>
      <td>BNB</td>
      <td>BUSD</td>
      <td>297.763000</td>
      <td>1.670000</td>
      <td>297.952500</td>
      <td>1.340000</td>
    </tr>
    <tr>
      <th>20</th>
      <td>ETH/BUSD</td>
      <td>2023-03-02 15:36:07.719</td>
      <td>ETH</td>
      <td>BUSD</td>
      <td>1630.210000</td>
      <td>0.510000</td>
      <td>1630.760000</td>
      <td>0.255000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>MATIC/BUSD</td>
      <td>2023-03-02 15:36:07.772</td>
      <td>MATIC</td>
      <td>BUSD</td>
      <td>1.203410</td>
      <td>623.100000</td>
      <td>1.204540</td>
      <td>415.000000</td>
    </tr>
    <tr>
      <th>22</th>
      <td>USDC/BUSD</td>
      <td>2023-03-02 15:36:07.893</td>
      <td>USDC</td>
      <td>BUSD</td>
      <td>0.999900</td>
      <td>329027.800000</td>
      <td>1.000000</td>
      <td>279879.620000</td>
    </tr>
    <tr>
      <th>23</th>
      <td>MANA/BUSD</td>
      <td>2023-03-02 15:36:07.950</td>
      <td>MANA</td>
      <td>BUSD</td>
      <td>0.630700</td>
      <td>343.000000</td>
      <td>0.632100</td>
      <td>3054.000000</td>
    </tr>
    <tr>
      <th>24</th>
      <td>ADA/BUSD</td>
      <td>2023-03-02 15:36:08.003</td>
      <td>ADA</td>
      <td>BUSD</td>
      <td>0.348000</td>
      <td>6582.900000</td>
      <td>0.349000</td>
      <td>997.000000</td>
    </tr>
    <tr>
      <th>25</th>
      <td>SOL/BUSD</td>
      <td>2023-03-02 15:36:08.056</td>
      <td>SOL</td>
      <td>BUSD</td>
      <td>21.830000</td>
      <td>1.390000</td>
      <td>21.900000</td>
      <td>181.090000</td>
    </tr>
    <tr>
      <th>26</th>
      <td>TRX/BUSD</td>
      <td>2023-03-02 15:36:08.114</td>
      <td>TRX</td>
      <td>BUSD</td>
      <td>0.069290</td>
      <td>10823.900000</td>
      <td>0.069390</td>
      <td>25220.400000</td>
    </tr>
    <tr>
      <th>27</th>
      <td>BTC/USDC</td>
      <td>2023-03-02 15:36:08.170</td>
      <td>BTC</td>
      <td>USDC</td>
      <td>23371.660000</td>
      <td>0.020000</td>
      <td>23376.990000</td>
      <td>0.051000</td>
    </tr>
    <tr>
      <th>28</th>
      <td>ETH/USDC</td>
      <td>2023-03-02 15:36:08.228</td>
      <td>ETH</td>
      <td>USDC</td>
      <td>1630.160000</td>
      <td>0.100000</td>
      <td>1630.810000</td>
      <td>0.215000</td>
    </tr>
    <tr>
      <th>29</th>
      <td>SOL/USDC</td>
      <td>2023-03-02 15:36:08.298</td>
      <td>SOL</td>
      <td>USDC</td>
      <td>21.830000</td>
      <td>343.520000</td>
      <td>21.880000</td>
      <td>201.080000</td>
    </tr>
    <tr>
      <th>30</th>
      <td>ADA/USDC</td>
      <td>2023-03-02 15:36:08.368</td>
      <td>ADA</td>
      <td>USDC</td>
      <td>0.348200</td>
      <td>8615.400000</td>
      <td>0.349400</td>
      <td>2433.100000</td>
    </tr>
    <tr>
      <th>31</th>
      <td>BTC/DAI</td>
      <td>2023-03-02 15:36:08.433</td>
      <td>BTC</td>
      <td>DAI</td>
      <td>23366.440000</td>
      <td>0.049540</td>
      <td>23394.360000</td>
      <td>0.049500</td>
    </tr>
    <tr>
      <th>32</th>
      <td>ETH/DAI</td>
      <td>2023-03-02 15:36:08.485</td>
      <td>ETH</td>
      <td>DAI</td>
      <td>1629.890000</td>
      <td>0.497400</td>
      <td>1631.810000</td>
      <td>1.490000</td>
    </tr>
    <tr>
      <th>33</th>
      <td>BTC/USD</td>
      <td>2023-03-02 15:36:08.623</td>
      <td>BTC</td>
      <td>USD</td>
      <td>23373.010000</td>
      <td>0.007463</td>
      <td>23376.720000</td>
      <td>0.048805</td>
    </tr>
    <tr>
      <th>34</th>
      <td>ETH/USD</td>
      <td>2023-03-02 15:36:08.675</td>
      <td>ETH</td>
      <td>USD</td>
      <td>1630.490000</td>
      <td>2.564550</td>
      <td>1630.740000</td>
      <td>0.580700</td>
    </tr>
    <tr>
      <th>35</th>
      <td>USDT/USD</td>
      <td>2023-03-02 15:36:08.730</td>
      <td>USDT</td>
      <td>USD</td>
      <td>1.000000</td>
      <td>10407.870000</td>
      <td>1.000100</td>
      <td>954839.680000</td>
    </tr>
    <tr>
      <th>36</th>
      <td>BNB/USD</td>
      <td>2023-03-02 15:36:08.782</td>
      <td>BNB</td>
      <td>USD</td>
      <td>297.900200</td>
      <td>2.100000</td>
      <td>297.952500</td>
      <td>1.342000</td>
    </tr>
    <tr>
      <th>37</th>
      <td>ADA/USD</td>
      <td>2023-03-02 15:36:08.835</td>
      <td>ADA</td>
      <td>USD</td>
      <td>0.348800</td>
      <td>1500.000000</td>
      <td>0.348900</td>
      <td>3000.000000</td>
    </tr>
    <tr>
      <th>38</th>
      <td>BUSD/USD</td>
      <td>2023-03-02 15:36:08.942</td>
      <td>BUSD</td>
      <td>USD</td>
      <td>0.999500</td>
      <td>79157.800000</td>
      <td>0.999900</td>
      <td>795593.480000</td>
    </tr>
    <tr>
      <th>39</th>
      <td>MATIC/USD</td>
      <td>2023-03-02 15:36:08.998</td>
      <td>MATIC</td>
      <td>USD</td>
      <td>1.204000</td>
      <td>937.600000</td>
      <td>1.204500</td>
      <td>937.500000</td>
    </tr>
    <tr>
      <th>40</th>
      <td>USDC/USD</td>
      <td>2023-03-02 15:36:09.051</td>
      <td>USDC</td>
      <td>USD</td>
      <td>0.999900</td>
      <td>5050.300000</td>
      <td>1.000000</td>
      <td>517682.170000</td>
    </tr>
    <tr>
      <th>41</th>
      <td>MANA/USD</td>
      <td>2023-03-02 15:36:09.102</td>
      <td>MANA</td>
      <td>USD</td>
      <td>0.631000</td>
      <td>372.340000</td>
      <td>0.631600</td>
      <td>572.340000</td>
    </tr>
    <tr>
      <th>42</th>
      <td>DAI/USD</td>
      <td>2023-03-02 15:36:09.155</td>
      <td>DAI</td>
      <td>USD</td>
      <td>0.999100</td>
      <td>4534.660000</td>
      <td>1.000100</td>
      <td>7591.820000</td>
    </tr>
    <tr>
      <th>43</th>
      <td>SOL/USD</td>
      <td>2023-03-02 15:36:09.217</td>
      <td>SOL</td>
      <td>USD</td>
      <td>21.858100</td>
      <td>55.730000</td>
      <td>21.865900</td>
      <td>18.290000</td>
    </tr>
    <tr>
      <th>44</th>
      <td>TRX/USD</td>
      <td>2023-03-02 15:36:09.270</td>
      <td>TRX</td>
      <td>USD</td>
      <td>0.069200</td>
      <td>225602.200000</td>
      <td>0.069400</td>
      <td>224245.500000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="modelling-the-arbitrage-search-problem-as-a-graph">
<h2>Modelling the arbitrage search problem as a graph<a class="headerlink" href="#modelling-the-arbitrage-search-problem-as-a-graph" title="Permalink to this heading">#</a></h2>
<p>Our goal will be to find arbitrage opportunities, i.e., the possibility to start from a given currency and, through a sequence of executed trades, arrive back at the same currency with a higher balance than at the beginning. We will model this problem as a network one.</p>
<p>A bid appearing in the order book for market symbol <span class="math notranslate nohighlight">\(b/q\)</span> is an order from a prospective counter party to purchase an amount of the base currency <span class="math notranslate nohighlight">\(b\)</span> at a bid price given in a quote currency <span class="math notranslate nohighlight">\(q\)</span>. For a currency trader, a bid in the order book is an opportunity to convert the base currency <span class="math notranslate nohighlight">\(b\)</span> into the quote currency <span class="math notranslate nohighlight">\(q\)</span>.</p>
<p>The order book can be represented as a directed graph where nodes correspond to individual currencies. A directed edge <span class="math notranslate nohighlight">\(b\rightarrow q\)</span> from node <span class="math notranslate nohighlight">\(b\)</span> to node <span class="math notranslate nohighlight">\(q\)</span> describes an opportunity for us to convert currency <span class="math notranslate nohighlight">\(b\)</span> into units of currency <span class="math notranslate nohighlight">\(q\)</span>. Let <span class="math notranslate nohighlight">\(V_b\)</span> and <span class="math notranslate nohighlight">\(V_q\)</span> denote the amounts of each currency held by us, and let <span class="math notranslate nohighlight">\(x_{b\rightarrow q}\)</span> denote the amount of currency <span class="math notranslate nohighlight">\(b\)</span> exchanged for currency <span class="math notranslate nohighlight">\(j\)</span>. Following the transaction <span class="math notranslate nohighlight">\(x_{b\rightarrow q}\)</span> we have the following changes to the currency holdings
$<span class="math notranslate nohighlight">\(
\begin{align*}
    \Delta V_b &amp; = - x_{b\rightarrow q} \\
    \Delta V_q &amp; = a_{b\rightarrow q} x_{b\rightarrow q},
\end{align*}
\)</span><span class="math notranslate nohighlight">\(
where \)</span>a_{b\rightarrow q}<span class="math notranslate nohighlight">\( is a *conversion coefficient* equal to the price of \)</span>b<span class="math notranslate nohighlight">\( expressed in terms of currency \)</span>q<span class="math notranslate nohighlight">\(. The capacity \)</span>c_{b\rightarrow q}<span class="math notranslate nohighlight">\( of an trading along edge \)</span>b\rightarrow q$ is specified by a relationship</p>
<div class="math notranslate nohighlight">
\[
    x_{b\rightarrow q} \leq c_{b\rightarrow q}.
\]</div>
<p>Because the arcs in our graph correspond to two types of orders - bid and ask - we need to build a consistent way of expressing them in our  <span class="math notranslate nohighlight">\(a_{b\rightarrow q}\)</span>, <span class="math notranslate nohighlight">\(c_{b\rightarrow q}\)</span> notation. So now, imagine that we are the party that accepts the buy and ask bids existing in the graph.</p>
<p>For bid orders, we have a chance to convert the base currency <span class="math notranslate nohighlight">\(b\)</span> into the quote currency <span class="math notranslate nohighlight">\(q\)</span>, for which we will use the following notation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
a_{b\rightarrow q} &amp; = \text{bid price} \\
c_{b\rightarrow q} &amp; = \text{bid volume}
\end{align*}
\end{split}\]</div>
<p>An ask order for symbol <span class="math notranslate nohighlight">\(b/q\)</span> is an order to sell the base currency at price not less than the ‘ask’ price given in terms of the quote currency. The ask volume is the amount of base currency to be sold. For us, a sell order is an opportunity to convert the quoted currency into the base currency such that</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
a_{q\rightarrow b} &amp; = \frac{1}{\text{ask price}} \\
c_{q\rightarrow b} &amp; = \text{ask volume} \times \text{ask volume}
\end{align*}
\end{split}\]</div>
<p>The following cell creates a directed graph using data from an exchange order book. To distinguish between different order types, we will highlight the big orders with green color, and ask orders with red color.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an order book dataframe into a directed graph using the NetworkX library.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    order_book : pandas.DataFrame</span>
<span class="sd">        A dataframe containing the order book information.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dg_order_book : networkx.DiGraph</span>
<span class="sd">        A directed graph representing the order book.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># create a dictionary of edges index by (src, dst)</span>
    <span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    
    <span class="c1"># loop over each order in the order book dataframe</span>
    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">order_book</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="c1"># if the order is a &#39;bid&#39;, i.e., an order to purchase the base currency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_volume&quot;</span><span class="p">]):</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">]</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;quote&quot;</span><span class="p">]</span>
            <span class="c1"># add an edge to the graph with the relevant attributes</span>
            <span class="n">dg_order_book</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;bid&quot;</span><span class="p">,</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_price&quot;</span><span class="p">],</span>
                <span class="n">capacity</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_volume&quot;</span><span class="p">],</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_price&quot;</span><span class="p">]),</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># if the order is an &#39;ask&#39;, i.e., an order to sell the base currency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_volume&quot;</span><span class="p">]):</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;quote&quot;</span><span class="p">]</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">]</span>
            <span class="c1"># add an edge to the graph with the relevant attributes</span>
            <span class="n">dg_order_book</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;ask&quot;</span><span class="p">,</span>
                <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_price&quot;</span><span class="p">],</span>
                <span class="n">capacity</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_volume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_price&quot;</span><span class="p">],</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_price&quot;</span><span class="p">]),</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># loop over each node in the graph and set the color attribute to &quot;lightblue&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lightblue&quot;</span>

    <span class="k">return</span> <span class="n">dg_order_book</span>

<span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First, we simply print the content of the order book as a list of arcs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display contents of the directed graph</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;src   --&gt; dst    kind            a                c&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;------------------------------------------------------&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">:</span><span class="s2">5s</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">:</span><span class="s2">5s</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2"> 16f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s1">&#39;capacity&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2"> 16f</span><span class="si">}</span><span class="s2">    &quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>src   --&gt; dst    kind            a                c
------------------------------------------------------
ETH   --&gt; BTC     bid        0.069735         0.012000    
ETH   --&gt; ADA     ask     4668.534080         0.190981    
ETH   --&gt; USDT    bid     1630.200000         0.950000    
ETH   --&gt; BUSD    bid     1630.210000         0.510000    
ETH   --&gt; USDC    bid     1630.160000         0.100000    
ETH   --&gt; DAI     bid     1629.890000         0.497400    
ETH   --&gt; USD     bid     1630.490000         2.564550    
BTC   --&gt; ETH     ask       14.335068         0.003488    
BTC   --&gt; BNB     ask       78.403701         0.038263    
BTC   --&gt; ADA     ask    66844.919786         0.032433    
BTC   --&gt; SOL     ask     1068.261938         0.014154    
BTC   --&gt; MATIC   ask    19391.118868         0.007746    
BTC   --&gt; MANA    ask    36968.576710         0.038113    
BTC   --&gt; TRX     ask   335570.469799         0.075549    
BTC   --&gt; USDT    bid    23373.920000         0.118619    
BTC   --&gt; BUSD    bid    23371.440000         0.021500    
BTC   --&gt; USDC    bid    23371.660000         0.020000    
BTC   --&gt; DAI     bid    23366.440000         0.049540    
BTC   --&gt; USD     bid    23373.010000         0.007463    
BNB   --&gt; BTC     bid        0.012743         0.050000    
BNB   --&gt; USDT    bid      297.857700         0.800000    
BNB   --&gt; BUSD    bid      297.763000         1.670000    
BNB   --&gt; USD     bid      297.900200         2.100000    
ADA   --&gt; BTC     bid        0.000015         2.000000    
ADA   --&gt; ETH     bid        0.000214       994.900000    
ADA   --&gt; USDT    bid        0.348630      1100.000000    
ADA   --&gt; BUSD    bid        0.348000      6582.900000    
ADA   --&gt; USDC    bid        0.348200      8615.400000    
ADA   --&gt; USD     bid        0.348800      1500.000000    
SOL   --&gt; BTC     bid        0.000935         1.420000    
SOL   --&gt; USDT    bid       21.857000        22.870000    
SOL   --&gt; BUSD    bid       21.830000         1.390000    
SOL   --&gt; USDC    bid       21.830000       343.520000    
SOL   --&gt; USD     bid       21.858100        55.730000    
MATIC --&gt; BTC     bid        0.000052        26.200000    
MATIC --&gt; USDT    bid        1.203000      1664.600000    
MATIC --&gt; BUSD    bid        1.203410       623.100000    
MATIC --&gt; USD     bid        1.204000       937.600000    
MANA  --&gt; BTC     bid        0.000027       831.000000    
MANA  --&gt; USDT    bid        0.631000       157.000000    
MANA  --&gt; BUSD    bid        0.630700       343.000000    
MANA  --&gt; USD     bid        0.631000       372.340000    
TRX   --&gt; BTC     bid        0.000003         4.000000    
TRX   --&gt; USDT    bid        0.069280     10824.900000    
TRX   --&gt; BUSD    bid        0.069290     10823.900000    
TRX   --&gt; USD     bid        0.069200    225602.200000    
USDT  --&gt; BTC     ask        0.000043      1058.348400    
USDT  --&gt; ETH     ask        0.000613       815.385000    
USDT  --&gt; BNB     ask        0.003357       238.313520    
USDT  --&gt; ADA     ask        2.867384       178.281000    
USDT  --&gt; BUSD    ask        1.000400    317048.859708    
USDT  --&gt; SOL     ask        0.045738       502.860500    
USDT  --&gt; USDC    ask        0.999800    299240.836200    
USDT  --&gt; MATIC   ask        0.829876      6513.748000    
USDT  --&gt; MANA    ask        1.581778       360.986200    
USDT  --&gt; TRX     ask       14.423770       750.053538    
USDT  --&gt; USD     bid        1.000000     10407.870000    
BUSD  --&gt; USDT    bid        0.999500    293433.930000    
BUSD  --&gt; BTC     ask        0.000043       502.601845    
BUSD  --&gt; BNB     ask        0.003356       399.256350    
BUSD  --&gt; ETH     ask        0.000613       415.843800    
BUSD  --&gt; MATIC   ask        0.830192       499.884100    
BUSD  --&gt; USDC    ask        1.000000    279879.620000    
BUSD  --&gt; MANA    ask        1.582028      1930.433400    
BUSD  --&gt; ADA     ask        2.865330       347.953000    
BUSD  --&gt; SOL     ask        0.045662      3965.871000    
BUSD  --&gt; TRX     ask       14.411298      1750.043556    
BUSD  --&gt; USD     bid        0.999500     79157.800000    
USDC  --&gt; USDT    bid        1.000100    307657.000000    
USDC  --&gt; BUSD    bid        0.999900    329027.800000    
USDC  --&gt; BTC     ask        0.000043      1192.226490    
USDC  --&gt; ETH     ask        0.000613       350.624150    
USDC  --&gt; SOL     ask        0.045704      4399.630400    
USDC  --&gt; ADA     ask        2.862049       850.125140    
USDC  --&gt; USD     bid        0.999900      5050.300000    
DAI   --&gt; BTC     ask        0.000043      1158.020820    
DAI   --&gt; ETH     ask        0.000613      2431.396900    
DAI   --&gt; USD     bid        0.999100      4534.660000    
USD   --&gt; BTC     ask        0.000043      1140.900820    
USD   --&gt; ETH     ask        0.000613       946.970718    
USD   --&gt; USDT    ask        0.999900    954935.163968    
USD   --&gt; BNB     ask        0.003356       399.852255    
USD   --&gt; ADA     ask        2.866151      1046.700000    
USD   --&gt; BUSD    ask        1.000100    795513.920652    
USD   --&gt; MATIC   ask        0.830220      1129.218750    
USD   --&gt; USDC    ask        1.000000    517682.170000    
USD   --&gt; MANA    ask        1.583281       361.489944    
USD   --&gt; DAI     ask        0.999900      7592.579182    
USD   --&gt; SOL     ask        0.045733       399.927311    
USD   --&gt; TRX     ask       14.409222     15562.637700    
</pre></div>
</div>
</div>
</div>
<p>Next, we draw the graph itself.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">draw_dg</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../../_images/68d5a1dea54d4d97bd0b922039f64526cfd34a122b33a1d972517ab01a6eec61.png" src="../../_images/68d5a1dea54d4d97bd0b922039f64526cfd34a122b33a1d972517ab01a6eec61.png" />
</div>
</div>
</section>
<section id="trading-and-arbitrage">
<h2>Trading and Arbitrage<a class="headerlink" href="#trading-and-arbitrage" title="Permalink to this heading">#</a></h2>
<p>With the unified treatment of the bid and ask orders, we are ready to pose the mathematical problem of finding an arbitrage opportunity. An arbitrage exists if it is possible to find a closed path and a sequence of transactions in the directed graph that results in a net increase in currency holdings. Given a path</p>
<p>\begin{align*}
i_0 \rightarrow i_1 \rightarrow i_2 \rightarrow \cdots \rightarrow i_{n-1} \rightarrow i_n
\end{align*}</p>
<p>the path is closed if <span class="math notranslate nohighlight">\(i_n = i_0\)</span>. The path has finite capacity if each edge in the path has a non-zero capacity. For a sufficiently small holding <span class="math notranslate nohighlight">\(w_{i_0}\)</span> of currency <span class="math notranslate nohighlight">\(i_0\)</span> (because of the capacity constraints), a closed path with <span class="math notranslate nohighlight">\(i_0 = i_n\)</span> represents an arbitrage opportunity if</p>
<p>\begin{equation}
\prod_{k=0}^{n-1} a_{i_k\rightarrow i_{k+1}} &gt; 1.
\end{equation}</p>
<p>If all we care about is simply finding an arbitrage cycle, regardless of the volume traded, we can use one of the many shortest path algorithms from the <code class="docutils literal notranslate"><span class="pre">networkx</span></code> library. To convert the problem of finding a path meeting  the above condition into a sum-of-terms to be minimized, we can take the negative logarithm of both sides to obtain the condition:</p>
<p>\begin{align*}
-\log(\prod_{k=0}^{n-1} a_{i_k\rightarrow i_{k+1}}) = - \sum\limits_{k = 0}^{n-1} \log (a_{i_k\rightarrow i_{k+1}}) &lt; 0,
\end{align*}</p>
<p>In other words, if we assign the negative logarithm as the weight of arcs in a graph, then our problem just became translated into the problem of searching for a cycle with a total sum of weights along it to be negative.</p>
</section>
<section id="find-order-books-that-demonstrate-arbitrage-opportunities">
<h2>Find order books that demonstrate arbitrage opportunities<a class="headerlink" href="#find-order-books-that-demonstrate-arbitrage-opportunities" title="Permalink to this heading">#</a></h2>
<p>A simple cycle is a closed path where no node appears twice. Simple cycles are distinct if they are not cyclic permutations (essentially, rewriting the same path but with a different start=end point) of each other. One could check for arbitrage opportunities by checking if there are any negative simple cycles in the graph.</p>
<p>However, looking for a negative-weight cycle through searching for an arbitrage opportunity can be a daunting task - a brute force search over all simple cycles has complexity <span class="math notranslate nohighlight">\((n + e)(c + 1)\)</span> which is impractical for larger scale applications. A more efficient search based on the Bellman-Ford algorithm is embedded in the NetworkX function <a class="reference external" href="https://networkx.org/documentation/networkx-1.10/reference/generated/networkx.algorithms.shortest_paths.weighted.negative_edge_cycle.html"><code class="docutils literal notranslate"><span class="pre">negative_edge_cycle</span></code></a> that returns a logical True if a negative cycle exists in a directed graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">negative_edge_cycle</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">heuristic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">negative_edge_cycle</span></code> s fast, but it only indicates if there is a negative cycle or not, and we don’t even know what kind of a cycle is it so it would be hard to use that information to perform an arbitrage.</p>
<p>Luckily, the <code class="docutils literal notranslate"><span class="pre">networkx</span></code> library includes the function <a class="reference external" href="https://networkx.org/documentation/stable/reference/algorithms/generated/networkx.algorithms.shortest_paths.weighted.find_negative_cycle.html"><code class="docutils literal notranslate"><span class="pre">find_negative_cycle</span></code> that locates a single negative edge cycle</a> if one exists. We can use this to demonstrate the existence of an arbitrage opportunity, and to highlight that opportunity on the directed graph of all possible trades. The following cell reports the cycle found and the trading return measured in basis points (1 bp = 0.01%), and marks it with thicker arcs i the graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the sum of weights given a list of nodes</span>
<span class="k">def</span> <span class="nf">sum_weights</span><span class="p">(</span><span class="n">cycle</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cycle</span><span class="p">[:</span><span class="mi">1</span><span class="p">])])</span>

<span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
<span class="n">arb</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">find_negative_cycle</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trading cycle: </span><span class="si">{</span><span class="n">arb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">bp</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sum_weights</span><span class="p">(</span><span class="n">arb</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bp</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> basis points&quot;</span><span class="p">)</span>
    
<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arb</span><span class="p">,</span> <span class="n">arb</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">arb</span><span class="p">[:</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">dg_order_book</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">dst</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    
<span class="n">ax</span> <span class="o">=</span> <span class="n">draw_dg</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Candidate Trading Cycle </span><span class="si">{</span><span class="n">bp</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> basis points return&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trading cycle: [&#39;USDC&#39;, &#39;USDT&#39;, &#39;BUSD&#39;]
5.002 basis points
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Candidate Trading Cycle 5.002 basis points return&#39;)
</pre></div>
</div>
<img alt="../../_images/51eef945837cc3b9c6d5693d799326e7930fa69f6f2f3111fcadeb3edd0ba13e.png" src="../../_images/51eef945837cc3b9c6d5693d799326e7930fa69f6f2f3111fcadeb3edd0ba13e.png" />
</div>
</div>
<p>Note this may or may not the trading cycle with maximum return. There may be other cycles with higher or lower returns, and that allow higher or lower trading volumes.</p>
</section>
<section id="brute-force-search-arbitrage-with-simple-cycles">
<h2>Brute force search arbitrage with simple cycles<a class="headerlink" href="#brute-force-search-arbitrage-with-simple-cycles" title="Permalink to this heading">#</a></h2>
<p>Not all arbitrage cycles are the same - some yield a higher relative return (per dollar invested) than the others, and some yield a higher absolute return (maximum amount of money to be made risk-free) than others. This is because the amount of money that flows throught a negative cycle is upper bounded by the size of the smallest order in that cycle. Thus, if one is looking for the best possible arbitrage sequence of trades, finding just ‘a cycle’ might not be enough.</p>
<p>A crude way to search for a good arbitrage opportunity would be to enumerate all possible simple cycles in a graph and pick the one that’s best according to whatever criterion we pick. A brute force search over for all simple cycles has order <span class="math notranslate nohighlight">\((N_{nodes} + N_{edges})(N_{cycles} + 1)\)</span> complexity, which is prohibitive for large order books. Nevertheless, we explore this option here to better understand the problem of finding and valuing arbitrage opportunities.</p>
<p>In the following cell, we compute the loss function for all simple cycles that can be constructed within a directed graph using the function <a class="reference external" href="https://networkx.org/documentation/stable/reference/algorithms/generated/networkx.algorithms.cycles.simple_cycles.html"><code class="docutils literal notranslate"><span class="pre">simple_cycles</span></code></a> from the <code class="docutils literal notranslate"><span class="pre">networkx</span></code> library to construct a dictionary of all distinct simple cycles in the order book. Each cycle is represented by an ordered list of nodes. For each cycle, the financial return is computed, and a histogram is constructed to show the distribution of potential returns. Several paths with the highest return are then overlaid on the graph of the order book.</p>
<p>Again, note that no account is taken of the trading capacity available on each path.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This cell iterates over all simple cycles in a directed graph. This</span>
<span class="c1"># can a long time for a large, well connected graph. </span>

<span class="c1"># convert order book to a directed graph</span>
<span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>

<span class="c1"># compute the sum of weights given a list of nodes</span>
<span class="k">def</span> <span class="nf">sum_weights</span><span class="p">(</span><span class="n">cycle</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cycle</span><span class="p">[:</span><span class="mi">1</span><span class="p">])])</span>

<span class="c1"># create a dictionary of all simple cycles and sum of weights</span>
<span class="n">cycles</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cycle</span><span class="p">):</span> <span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sum_weights</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">)}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span><span class="si">}</span><span class="s2"> distinct simple cycles in the order book.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="nb">len</span><span class="p">([</span><span class="n">cycle</span> <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span> <span class="k">if</span> <span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> of the cycles have positive return.&quot;</span><span class="p">)</span>

<span class="c1"># create histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cycles</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">))))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Basis Points&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of Returns for all Simple Cycles&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 203147 distinct simple cycles in the order book.
   974 of the cycles have positive return.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.lines.Line2D at 0x7ff5e059c8b0&gt;
</pre></div>
</div>
<img alt="../../_images/1eb10722187e9ddd4cc2ebf0c02ad2e00397cc46823d8a5e46ef0605a78477b0.png" src="../../_images/1eb10722187e9ddd4cc2ebf0c02ad2e00397cc46823d8a5e46ef0605a78477b0.png" />
</div>
</div>
<p>Next, we sort out the negative cycles from this list and present them along with their basis-points (1% is 100 basis points) return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arbitrage</span> <span class="o">=</span> <span class="p">[</span><span class="n">cycle</span> <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cycles</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">cycles</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">n_cycles_to_list</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top </span><span class="si">{</span><span class="n">n_cycles_to_list</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Basis Points             Arbitrage Cycle&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">arbitrage</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cycles_to_list</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arbitrage</span><span class="p">))]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span><span class="si">:</span><span class="s2">6.3f</span><span class="si">}</span><span class="s2">         </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2"> trades: </span><span class="si">{</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 5

Basis Points             Arbitrage Cycle
14.774         8 trades: USDC -&gt; USDT -&gt; ADA -&gt; BTC -&gt; ETH -&gt; USD -&gt; BUSD -&gt; USDC
14.747         8 trades: TRX -&gt; BTC -&gt; ETH -&gt; USD -&gt; BUSD -&gt; USDC -&gt; USDT -&gt; TRX
14.699         7 trades: USDC -&gt; USDT -&gt; ADA -&gt; BTC -&gt; USD -&gt; BUSD -&gt; USDC
14.673         7 trades: TRX -&gt; BTC -&gt; USD -&gt; BUSD -&gt; USDC -&gt; USDT -&gt; TRX
13.772         7 trades: USDC -&gt; USDT -&gt; ADA -&gt; BTC -&gt; ETH -&gt; USD -&gt; USDC
</pre></div>
</div>
</div>
</div>
<p>In the end, we draw an example arbitrage cycle on our graph to illustrate the route that the money must travel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cycles_to_show</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">arbitrage</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cycles_to_show</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arbitrage</span><span class="p">))]:</span>

    <span class="c1"># get fresh graph to color nodes</span>
    <span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
    
    <span class="c1"># color nodes red</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">:</span>
        <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    
    <span class="c1"># makes lines wide</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cycle</span><span class="p">[:</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        
    <span class="n">ax</span> <span class="o">=</span> <span class="n">draw_dg</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2"> trades: </span><span class="si">{</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2"> Return = </span><span class="si">{</span><span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span><span class="si">:</span><span class="s2">6.3f</span><span class="si">}</span><span class="s2"> basis points &quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/561dcb950dfd3811671cf34ad7417a028020b8724f0f608835387fa9dd9cad76.png" src="../../_images/561dcb950dfd3811671cf34ad7417a028020b8724f0f608835387fa9dd9cad76.png" />
</div>
</div>
</section>
<section id="pyomo-model-for-arbitrage-with-capacity-constraints">
<h2>Pyomo Model for Arbitrage with Capacity Constraints<a class="headerlink" href="#pyomo-model-for-arbitrage-with-capacity-constraints" title="Permalink to this heading">#</a></h2>
<p>The preceding analysis shows that depending on generic network algorithms to find arbitrage in an exchange order book has some practical limitations:</p>
<ul class="simple">
<li><p>Since there can be multiple negative cycles, there may be more than one opportunity for arbitrage. Which opportunity offers the greatest potential for profit?</p></li>
<li><p>Shortest path algorithms do not account for capacity constraints. The network algorithms are restricted to investments small enough to satisfy all capacity constraints on every edge.</p></li>
</ul>
<p>Instead, we can formulate the problem of searching for a maximum-gain arbitrage via linear programming. We assume we are given a directed graph where each edge <span class="math notranslate nohighlight">\(i\rightarrow j\)</span> is labeled with a ‘multiplier’ <span class="math notranslate nohighlight">\(a_{i\rightarrow j}\)</span> indicating how many units of currency <span class="math notranslate nohighlight">\(j\)</span> will be received for one unit of currency <span class="math notranslate nohighlight">\(i\)</span>, and a ‘capacity’ <span class="math notranslate nohighlight">\(c_{i\rightarrow j}\)</span> indicating how many units of currency <span class="math notranslate nohighlight">\(i\)</span> can be converted to currency <span class="math notranslate nohighlight">\(j\)</span>.</p>
<p>We will break the trading process down into steps indexed by <span class="math notranslate nohighlight">\(t = 1, 2, \ldots, T\)</span>, where currencies are exchanged between two adjacent nodes within a single step. We shall denote by <span class="math notranslate nohighlight">\(x_{i\rightarrow j}(t)\)</span> the currency amount traded from node <span class="math notranslate nohighlight">\(i\)</span> to <span class="math notranslate nohighlight">\(j\)</span> in step <span class="math notranslate nohighlight">\(t\)</span>. In this way, we start with the amount <span class="math notranslate nohighlight">\(w_{USD}(0)\)</span> at time <span class="math notranslate nohighlight">\(0\)</span> and aim to maximize the amount <span class="math notranslate nohighlight">\(w_{USD}(T)\)</span> at time <span class="math notranslate nohighlight">\(T\)</span>. Denote by <span class="math notranslate nohighlight">\(O_j\)</span> the set of nodes to which outgoing arcs from <span class="math notranslate nohighlight">\(j\)</span> lead, and by <span class="math notranslate nohighlight">\(I_j\)</span> the set of nodes from which incoming arcs lead.</p>
<p>A single transaction converts <span class="math notranslate nohighlight">\(x_{i\rightarrow j}(t)\)</span> units of currency <span class="math notranslate nohighlight">\(i\)</span> to currency <span class="math notranslate nohighlight">\(j\)</span>. Following the all transactions at event <span class="math notranslate nohighlight">\(t\)</span>, the trader will hold <span class="math notranslate nohighlight">\(v_j(t)\)</span> units of currency <span class="math notranslate nohighlight">\(j\)</span> where</p>
<div class="math notranslate nohighlight">
\[v_{j}(t) = v_{j}(t-1) + \sum_{i\in I_j} a_{i\rightarrow j}x_{i\rightarrow j}(t) - \sum_{k\in O_j} x_{j\rightarrow k}(t)\]</div>
<p>For every edge <span class="math notranslate nohighlight">\(i\rightarrow j\)</span>, the sum of all transactions must satisfy</p>
<div class="math notranslate nohighlight">
\[\sum_{t=1}^T x_{j\rightarrow k}(t) \leq c_{j\rightarrow k}\]</div>
<p>The objective of the optimization model is to find a sequence of currency transactions the increase holdings of a reference currency. The solution is constrained by assuming the trader cannot short sell any currency. The resulting model is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\max \quad &amp; v_{USD}(T) \\
\\
\text{s.t.} \quad &amp; v_{USD}(0) = v_0 \\ 
\\
&amp; v_{j}(t) = v_{j}(t-1) + \sum_{i\in I_j} a_{i\rightarrow j}x_{i\rightarrow j}(t) - \sum_{k\in O_k} x_{j\rightarrow k}(t) &amp; \forall j\in NODES, t=1, 2, \ldots, T \\
&amp; v_j(t-1) \geq \sum_{k\in O_j} x_{j\rightarrow k}(t) &amp; \forall j\in NODES, t = 1, 2, \ldots, T  \\
&amp; \sum_{t=1}^T x_{j\rightarrow k}(t) \leq c_{j\rightarrow k} &amp; \forall (j, k) \in EDGES,  t = 1, 2, \ldots, T \\
&amp; v_{j}(t), x_{i\rightarrow j}(t) \geq 0,  \label{ch4eq:problem.con5} &amp;&amp; \forall t
\end{align*}
\end{split}\]</div>
<p>where the subsequent constraints are the:</p>
<ul class="simple">
<li><p>initial amount condition,</p></li>
<li><p>balance equations linking the state of the given node in the previous and subsequent time periods,</p></li>
<li><p>constraint that we cannot trade at time step <span class="math notranslate nohighlight">\(t\)</span> more of a given currency that we had in this currency from time step <span class="math notranslate nohighlight">\(t - 1\)</span>. This constraint ‘enforces’ the time order of trades, i.e., we cannot trade in time period <span class="math notranslate nohighlight">\(t\)</span> units which have been received in the same time period.</p></li>
<li><p>the capacity constraints related to the maximum allowed trade volumes,</p></li>
<li><p>non-negativity constraints.</p></li>
</ul>
<p>The following Python code illustrates this formulation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyomo.environ</span> <span class="k">as</span> <span class="nn">pyo</span>

<span class="k">def</span> <span class="nf">crypto_model</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">):</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s2"> arbitrage&quot;</span><span class="p">)</span>

    <span class="c1"># length of the trading chain</span>
    <span class="n">m</span><span class="o">.</span><span class="n">T0</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">RangeSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">RangeSet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

    <span class="c1"># currency nodes and trading edges</span>
    <span class="n">m</span><span class="o">.</span><span class="n">NODES</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">))</span>

    <span class="c1"># currency on hand at each node</span>
    <span class="n">m</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># amount traded on each edge at each trade</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># total amount traded on each edge over all trades</span>
    <span class="n">m</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># &quot;multiplier&quot; on each trading edge</span>
    <span class="nd">@m</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;capacity&quot;</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wealth</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">total_traded</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">])</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">edge_capacity</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span>

    <span class="c1"># initial assignment of 100 units on a selected currency</span>
    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">no_shorting</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">out_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">dst</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">out_nodes</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">balances</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">in_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="k">if</span> <span class="n">dst</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
        <span class="n">out_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">dst</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">node</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">in_nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">out_nodes</span><span class="p">)</span> 

    <span class="n">solver</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="s2">&quot;cbc&quot;</span><span class="p">)</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<p>Using this function, we are able to compute the optimal (absolute) return from an order book while respecting the order capacities and optimally using all the arbitrage opportunities inside it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>

<span class="n">v0</span> <span class="o">=</span> <span class="mf">10000.0</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">crypto_model</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>
<span class="n">vT</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">wealth</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting wealth = </span><span class="si">{</span><span class="n">v0</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> USD&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weath after </span><span class="si">{</span><span class="n">T</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2"> transactions = </span><span class="si">{</span><span class="n">vT</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> USD&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return = </span><span class="si">{</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">vT</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span><span class="o">/</span><span class="n">v0</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> basis points&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting wealth = 10000.00 USD
Weath after  8 transactions = 10009.01 USD
Return = 9.007 basis points
</pre></div>
</div>
</div>
</div>
<p>To track the evolution of the trades throughout time, the script in the following cell illustrates, for each currency (rows) the amount of money held in that currency at each of the time steps <span class="math notranslate nohighlight">\(t = 0, \dots, 8\)</span>. It is visible from this scheme that the sequence of trades is not a simple cycle, but rather a more sophisticated sequence of trades which we would not have discovered with simple-cycle exploration alone, especially not when considering also the arc capacities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="si">:</span><span class="s2">5s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span><span class="si">:</span><span class="s2">11.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ETH       0.00000     0.00000     0.00000     0.00000    -0.00000     0.00000     0.00000     0.00000     0.00000
BTC       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00004     0.00000
BNB       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
ADA       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     2.00000     0.00000     0.00000
SOL       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
MATIC     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
MANA      0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
TRX       0.00000     0.00000     0.00000    -0.00000     0.00000    -0.00000     4.00000     0.00000     0.00000
USDT      0.00000  9998.02600     0.97433    -0.00000 10003.02700     0.97482     0.00000 10008.03000     0.00000
BUSD      0.00000    -0.00000 10002.02700     0.97472     0.00000 10007.03000    -0.00000     0.00000     0.00000
USDC      0.00000     0.97424    -0.00000 10002.02700     0.97472     0.00000 10007.03000    -0.00000     0.00000
DAI       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
USD   10000.00000    -0.00000    -0.00000     0.00000     0.00000     0.00000     0.00000     0.00000 10009.00700
</pre></div>
</div>
</div>
</div>
<p>To be even more specific, the following cell lists the sequence of transcations executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transaction Events&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">src</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span><span class="si">:</span><span class="s2">14.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span><span class="si">:</span><span class="s2">14.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Transaction Events
t = 1
 USD      -&gt; USDT    :    9999.025800    9998.025997
 USD      -&gt; USDC    :       0.974235       0.974235

t = 2
 USDT     -&gt; BUSD    :    9998.026000   10002.026811
 USDC     -&gt; USDT    :       0.974235       0.974333

t = 3
 USDT     -&gt; BUSD    :       0.974333       0.974723
 BUSD     -&gt; USDC    :   10002.027000   10002.027000

t = 4
 BUSD     -&gt; USDC    :       0.974723       0.974723
 USDC     -&gt; USDT    :   10002.027000   10003.027203

t = 5
 USDT     -&gt; BUSD    :   10003.027000   10007.029812
 USDC     -&gt; USDT    :       0.974723       0.974820

t = 6
 USDT     -&gt; ADA     :       0.697500       2.000000
 USDT     -&gt; TRX     :       0.277320       4.000000
 BUSD     -&gt; USDC    :   10007.030000   10007.030000

t = 7
 ADA      -&gt; BTC     :       2.000000       0.000030
 TRX      -&gt; BTC     :       4.000000       0.000012
 USDC     -&gt; USDT    :   10007.030000   10008.030703

t = 8
 BTC      -&gt; USD     :       0.000042       0.976057
 USDT     -&gt; USD     :   10008.030000   10008.030000
</pre></div>
</div>
</div>
</div>
<p>We next illustrate the arbitrage strategy in the graph by marking all the correspondings arcs thicker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add comment in the text to remind the reader about bids and asks</span>
<span class="c1"># for each currency we took only one ask and one bid, this is why we are unique between each pair of nodes</span>

<span class="c1"># report what orders to issue</span>
<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">0.0000002</span><span class="p">:</span> 
        <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">dst</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="n">dg_order_book</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">dst</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                
<span class="n">draw_dg</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
<img alt="../../_images/6d97eb23e757e0570f420d36dd325eea388568466a7926d5d2e84873b8d8b764.png" src="../../_images/6d97eb23e757e0570f420d36dd325eea388568466a7926d5d2e84873b8d8b764.png" />
</div>
</div>
<p>If we want to be even more precise about the execution of the trading strategy, we can formulate a printout of the list of orders that we, as the counterparty to the orders stated in the order book, should issue for our strategy to take place.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># report what orders to issue</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trading Summary for the Order Book&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Order Book   Type    Capacity         Traded&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">0.0000002</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">)][</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">:</span><span class="s2">&gt;5s</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">:</span><span class="s2">&lt;5s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span><span class="si">:</span><span class="s2">12.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span><span class="si">:</span><span class="s2">14.5f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  &gt;&gt;&gt;  &quot;</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;ask&quot;</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">dst</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="n">src</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">quote</span>
            <span class="n">price</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span> <span class="o">/</span> <span class="n">price</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;sell </span><span class="si">{</span><span class="n">volume</span><span class="si">:</span><span class="s2">15.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s2">11s</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;bid&quot;</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">src</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="n">dst</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">quote</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">]()</span> 
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;buy </span><span class="si">{</span><span class="n">volume</span><span class="si">:</span><span class="s2">16.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s2">11s</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2">&quot;</span>  
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trading Summary for the Order Book
  Order Book   Type    Capacity         Traded
  BTC -&gt; USD   bid      0.00746        0.00004  &gt;&gt;&gt;  buy         0.000042 BTC/USD     at 23373.010000
  ADA -&gt; BTC   bid      2.00000        2.00000  &gt;&gt;&gt;  buy         2.000000 ADA/BTC     at     0.000015
  TRX -&gt; BTC   bid      4.00000        4.00000  &gt;&gt;&gt;  buy         4.000000 TRX/BTC     at     0.000003
 USDT -&gt; ADA   ask    178.28100        0.69750  &gt;&gt;&gt;  sell        2.000000 ADA/USDT    at     0.348750
 USDT -&gt; BUSD  ask 317048.85971    20002.02700  &gt;&gt;&gt;  sell    20010.031012 BUSD/USDT   at     0.999600
 USDT -&gt; TRX   ask    750.05354        0.27732  &gt;&gt;&gt;  sell        4.000000 TRX/USDT    at     0.069330
 USDT -&gt; USD   bid  10407.87000    10008.03000  &gt;&gt;&gt;  buy     10008.030000 USDT/USD    at     1.000000
 BUSD -&gt; USDC  ask 279879.62000    20010.03100  &gt;&gt;&gt;  sell    20010.031000 USDC/BUSD   at     1.000000
 USDC -&gt; USDT  bid 307657.00000    20011.00600  &gt;&gt;&gt;  buy     20011.006000 USDC/USDT   at     1.000100
  USD -&gt; USDT  ask 954935.16397     9999.02580  &gt;&gt;&gt;  sell     9998.025997 USDT/USD    at     1.000100
  USD -&gt; USDC  ask 517682.17000        0.97424  &gt;&gt;&gt;  sell        0.974235 USDC/USD    at     1.000000
</pre></div>
</div>
</div>
</div>
<p>Along with that, we can print out the list of transactions that occur for our strategy to succeed, at different steps in time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transaction Events&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">0.0000002</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span><span class="si">:</span><span class="s2">14.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Transaction Events
t = 1
USD      -&gt; USDT    :    9999.025800
USD      -&gt; USDC    :       0.974235

t = 2
USDT     -&gt; BUSD    :    9998.026000
USDC     -&gt; USDT    :       0.974235

t = 3
USDT     -&gt; BUSD    :       0.974333
BUSD     -&gt; USDC    :   10002.027000

t = 4
BUSD     -&gt; USDC    :       0.974723
USDC     -&gt; USDT    :   10002.027000

t = 5
USDT     -&gt; BUSD    :   10003.027000
USDC     -&gt; USDT    :       0.974723

t = 6
USDT     -&gt; ADA     :       0.697500
USDT     -&gt; TRX     :       0.277320
BUSD     -&gt; USDC    :   10007.030000

t = 7
ADA      -&gt; BTC     :       2.000000
TRX      -&gt; BTC     :       4.000000
USDC     -&gt; USDT    :   10007.030000

t = 8
BTC      -&gt; USD     :       0.000042
USDT     -&gt; USD     :   10008.030000
</pre></div>
</div>
</div>
</div>
<p>In the end, we can illustrate the time-journey of our balances in different currencies using time-indexed bar charts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display currency balances</span>
<span class="n">balances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0000002</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">:</span>
            <span class="n">balances</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span>

<span class="n">balances</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Transaction&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Currency Units&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/186678cb7ca709eb97722e62e4ed769233881b4f8a82ed7f8338296ff18572e3.png" src="../../_images/186678cb7ca709eb97722e62e4ed769233881b4f8a82ed7f8338296ff18572e3.png" />
</div>
</div>
</section>
<section id="questions-to-the-user">
<h2>Questions to the user<a class="headerlink" href="#questions-to-the-user" title="Permalink to this heading">#</a></h2>
<p>In the preceding notebook cells, we have relied silently on some assumptions. The first one was that between each pair of currencies in an exchange, we have at most one bid and at most one ask order. It corresponded simply to the number of orders per each pair that we downloaded from the online database, but in real life, there might be more orders. How would the presence of more such orders per pair would impact the way our graph formulation looks like? How would you modify the MILP formulation of our problem to take that into account?</p>
<p>Another aspect was that we only considered trading currencies within one exchange. In real life, however, nothing prohibits us from trading across multiple exchanges. How would you modify the graph-based problem formulation to fit this situation?</p>
</section>
<section id="real-time-downloads-of-order-books-from-an-exchange">
<h2>Real Time Downloads of Order Books from an Exchange<a class="headerlink" href="#real-time-downloads-of-order-books-from-an-exchange" title="Permalink to this heading">#</a></h2>
<p>The goal of this notebook was to show how network algorithms and optimization can be utilized to detect arbitrage opportunities within an order book that has been obtained from a cryptocurrency exchange.</p>
<p>The subsequent cell in the notebook utilizes <code class="docutils literal notranslate"><span class="pre">ccxt.exchange.fetch_order_book</span></code> to obtain the highest bid and lowest ask orders from an exchange for market symbols that meet the criteria of having a minimum in-degree for their base currencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">get_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dg</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_orders</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return order book data for a specified symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">]),</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;asks&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bids&quot;</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;quote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="p">,</span> <span class="n">quote</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">milliseconds</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bid_price&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bid_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ask_price&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ask_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;asks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># fetch order book data and store in a dictionary</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">get_orders</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">)</span> <span class="k">for</span> <span class="n">quote</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">()])</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
    <span class="n">order_book</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">order_book</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">order_book</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span> <span class="s1">&#39;bid_price&#39;</span><span class="p">,</span> <span class="s1">&#39;bid_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;ask_price&#39;</span><span class="p">,</span> <span class="s1">&#39;ask_volume&#39;</span><span class="p">]]</span>


<span class="n">minimum_in_degree</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># graph of market symbols with mininum_in_degree for base currencies</span>
<span class="n">dg</span> <span class="o">=</span> <span class="n">get_dg</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">minimum_in_degree</span><span class="p">)</span>

<span class="c1"># retrieve order book for all markets in the graph</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="n">get_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dg</span><span class="p">)</span>

<span class="c1"># find trades</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mf">10000.0</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">crypto_model</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>
<span class="n">wT</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">wealth</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential Return = </span><span class="si">{</span><span class="mi">10000</span><span class="o">*</span><span class="p">(</span><span class="n">vT</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span><span class="o">/</span><span class="n">v0</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> basis points&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Potential Return = 9.007 basis points
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>timestamp</th>
      <th>base</th>
      <th>quote</th>
      <th>bid_price</th>
      <th>bid_volume</th>
      <th>ask_price</th>
      <th>ask_volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ETH/BTC</td>
      <td>2023-03-09 04:21:54.764</td>
      <td>ETH</td>
      <td>BTC</td>
      <td>0.070771</td>
      <td>1.01850</td>
      <td>0.070804</td>
      <td>1.300000e+00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BNB/BTC</td>
      <td>2023-03-09 04:21:54.833</td>
      <td>BNB</td>
      <td>BTC</td>
      <td>0.013320</td>
      <td>3.00000</td>
      <td>0.013331</td>
      <td>3.294000e+00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ADA/BTC</td>
      <td>2023-03-09 04:21:54.903</td>
      <td>ADA</td>
      <td>BTC</td>
      <td>0.000015</td>
      <td>8.10000</td>
      <td>0.000015</td>
      <td>9.571000e+02</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SOL/BTC</td>
      <td>2023-03-09 04:21:54.968</td>
      <td>SOL</td>
      <td>BTC</td>
      <td>0.000851</td>
      <td>15.03000</td>
      <td>0.000853</td>
      <td>1.504000e+01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MATIC/BTC</td>
      <td>2023-03-09 04:21:55.048</td>
      <td>MATIC</td>
      <td>BTC</td>
      <td>0.000049</td>
      <td>5.70000</td>
      <td>0.000049</td>
      <td>6.458000e+02</td>
    </tr>
    <tr>
      <th>5</th>
      <td>MANA/BTC</td>
      <td>2023-03-09 04:21:55.126</td>
      <td>MANA</td>
      <td>BTC</td>
      <td>0.000025</td>
      <td>1.00000</td>
      <td>0.000025</td>
      <td>1.029000e+03</td>
    </tr>
    <tr>
      <th>6</th>
      <td>TRX/BTC</td>
      <td>2023-03-09 04:21:55.194</td>
      <td>TRX</td>
      <td>BTC</td>
      <td>0.000003</td>
      <td>4723.00000</td>
      <td>0.000003</td>
      <td>1.472500e+04</td>
    </tr>
    <tr>
      <th>7</th>
      <td>ADA/ETH</td>
      <td>2023-03-09 04:21:55.275</td>
      <td>ADA</td>
      <td>ETH</td>
      <td>0.000206</td>
      <td>998.70000</td>
      <td>0.000207</td>
      <td>4.000000e-01</td>
    </tr>
    <tr>
      <th>8</th>
      <td>BTC/USDT</td>
      <td>2023-03-09 04:21:55.340</td>
      <td>BTC</td>
      <td>USDT</td>
      <td>21740.300000</td>
      <td>0.02866</td>
      <td>21742.490000</td>
      <td>1.508000e-02</td>
    </tr>
    <tr>
      <th>9</th>
      <td>ETH/USDT</td>
      <td>2023-03-09 04:21:55.404</td>
      <td>ETH</td>
      <td>USDT</td>
      <td>1538.830000</td>
      <td>2.40000</td>
      <td>1539.360000</td>
      <td>5.000000e-01</td>
    </tr>
    <tr>
      <th>10</th>
      <td>BNB/USDT</td>
      <td>2023-03-09 04:21:55.476</td>
      <td>BNB</td>
      <td>USDT</td>
      <td>289.600000</td>
      <td>7.85500</td>
      <td>289.700000</td>
      <td>1.900000e+00</td>
    </tr>
    <tr>
      <th>11</th>
      <td>ADA/USDT</td>
      <td>2023-03-09 04:21:55.541</td>
      <td>ADA</td>
      <td>USDT</td>
      <td>0.318400</td>
      <td>3933.10000</td>
      <td>0.318600</td>
      <td>2.540000e+03</td>
    </tr>
    <tr>
      <th>12</th>
      <td>BUSD/USDT</td>
      <td>2023-03-09 04:21:55.609</td>
      <td>BUSD</td>
      <td>USDT</td>
      <td>0.999600</td>
      <td>327823.00000</td>
      <td>1.000100</td>
      <td>3.252770e+05</td>
    </tr>
    <tr>
      <th>13</th>
      <td>SOL/USDT</td>
      <td>2023-03-09 04:21:55.675</td>
      <td>SOL</td>
      <td>USDT</td>
      <td>18.520000</td>
      <td>98.50000</td>
      <td>18.530000</td>
      <td>3.500000e+01</td>
    </tr>
    <tr>
      <th>14</th>
      <td>USDC/USDT</td>
      <td>2023-03-09 04:21:55.746</td>
      <td>USDC</td>
      <td>USDT</td>
      <td>1.000000</td>
      <td>282130.00000</td>
      <td>1.000400</td>
      <td>2.917270e+05</td>
    </tr>
    <tr>
      <th>15</th>
      <td>MATIC/USDT</td>
      <td>2023-03-09 04:21:55.816</td>
      <td>MATIC</td>
      <td>USDT</td>
      <td>1.060100</td>
      <td>927.40000</td>
      <td>1.061400</td>
      <td>2.033000e+02</td>
    </tr>
    <tr>
      <th>16</th>
      <td>MANA/USDT</td>
      <td>2023-03-09 04:21:55.883</td>
      <td>MANA</td>
      <td>USDT</td>
      <td>0.549100</td>
      <td>159.00000</td>
      <td>0.550400</td>
      <td>5.900000e+02</td>
    </tr>
    <tr>
      <th>17</th>
      <td>TRX/USDT</td>
      <td>2023-03-09 04:21:55.951</td>
      <td>TRX</td>
      <td>USDT</td>
      <td>0.065720</td>
      <td>11412.40000</td>
      <td>0.065780</td>
      <td>1.140270e+04</td>
    </tr>
    <tr>
      <th>18</th>
      <td>BTC/BUSD</td>
      <td>2023-03-09 04:21:56.086</td>
      <td>BTC</td>
      <td>BUSD</td>
      <td>21737.540000</td>
      <td>0.02500</td>
      <td>21742.670000</td>
      <td>4.599000e-02</td>
    </tr>
    <tr>
      <th>19</th>
      <td>BNB/BUSD</td>
      <td>2023-03-09 04:21:56.153</td>
      <td>BNB</td>
      <td>BUSD</td>
      <td>289.500000</td>
      <td>8.25200</td>
      <td>289.800000</td>
      <td>5.176000e+00</td>
    </tr>
    <tr>
      <th>20</th>
      <td>ETH/BUSD</td>
      <td>2023-03-09 04:21:56.218</td>
      <td>ETH</td>
      <td>BUSD</td>
      <td>1538.400000</td>
      <td>0.29000</td>
      <td>1539.210000</td>
      <td>5.800000e-01</td>
    </tr>
    <tr>
      <th>21</th>
      <td>MATIC/BUSD</td>
      <td>2023-03-09 04:21:56.286</td>
      <td>MATIC</td>
      <td>BUSD</td>
      <td>1.060700</td>
      <td>424.20000</td>
      <td>1.061400</td>
      <td>2.355000e+02</td>
    </tr>
    <tr>
      <th>22</th>
      <td>USDC/BUSD</td>
      <td>2023-03-09 04:21:56.356</td>
      <td>USDC</td>
      <td>BUSD</td>
      <td>0.999600</td>
      <td>272795.26000</td>
      <td>0.999900</td>
      <td>3.276466e+05</td>
    </tr>
    <tr>
      <th>23</th>
      <td>MANA/BUSD</td>
      <td>2023-03-09 04:21:56.422</td>
      <td>MANA</td>
      <td>BUSD</td>
      <td>0.548200</td>
      <td>1859.00000</td>
      <td>0.552000</td>
      <td>4.479000e+03</td>
    </tr>
    <tr>
      <th>24</th>
      <td>ADA/BUSD</td>
      <td>2023-03-09 04:21:56.494</td>
      <td>ADA</td>
      <td>BUSD</td>
      <td>0.318100</td>
      <td>3923.20000</td>
      <td>0.318800</td>
      <td>1.201570e+04</td>
    </tr>
    <tr>
      <th>25</th>
      <td>SOL/BUSD</td>
      <td>2023-03-09 04:21:56.562</td>
      <td>SOL</td>
      <td>BUSD</td>
      <td>18.490000</td>
      <td>15.10000</td>
      <td>18.550000</td>
      <td>2.191000e+02</td>
    </tr>
    <tr>
      <th>26</th>
      <td>TRX/BUSD</td>
      <td>2023-03-09 04:21:56.631</td>
      <td>TRX</td>
      <td>BUSD</td>
      <td>0.065710</td>
      <td>7989.40000</td>
      <td>0.065780</td>
      <td>1.706660e+04</td>
    </tr>
    <tr>
      <th>27</th>
      <td>BTC/USDC</td>
      <td>2023-03-09 04:21:56.702</td>
      <td>BTC</td>
      <td>USDC</td>
      <td>21735.910000</td>
      <td>0.02850</td>
      <td>21740.950000</td>
      <td>5.700000e-02</td>
    </tr>
    <tr>
      <th>28</th>
      <td>ETH/USDC</td>
      <td>2023-03-09 04:21:56.773</td>
      <td>ETH</td>
      <td>USDC</td>
      <td>1538.290000</td>
      <td>0.20000</td>
      <td>1539.120000</td>
      <td>2.500000e-01</td>
    </tr>
    <tr>
      <th>29</th>
      <td>SOL/USDC</td>
      <td>2023-03-09 04:21:56.843</td>
      <td>SOL</td>
      <td>USDC</td>
      <td>18.500000</td>
      <td>405.34000</td>
      <td>18.540000</td>
      <td>1.888200e+02</td>
    </tr>
    <tr>
      <th>30</th>
      <td>ADA/USDC</td>
      <td>2023-03-09 04:21:56.911</td>
      <td>ADA</td>
      <td>USDC</td>
      <td>0.318200</td>
      <td>9427.50000</td>
      <td>0.318700</td>
      <td>8.473900e+03</td>
    </tr>
    <tr>
      <th>31</th>
      <td>BTC/DAI</td>
      <td>2023-03-09 04:21:56.975</td>
      <td>BTC</td>
      <td>DAI</td>
      <td>21726.440000</td>
      <td>0.12133</td>
      <td>21764.090000</td>
      <td>4.476000e-02</td>
    </tr>
    <tr>
      <th>32</th>
      <td>ETH/DAI</td>
      <td>2023-03-09 04:21:57.046</td>
      <td>ETH</td>
      <td>DAI</td>
      <td>1537.740000</td>
      <td>1.21270</td>
      <td>1540.830000</td>
      <td>4.515000e-01</td>
    </tr>
    <tr>
      <th>33</th>
      <td>BTC/USD</td>
      <td>2023-03-09 04:21:57.181</td>
      <td>BTC</td>
      <td>USD</td>
      <td>21737.380000</td>
      <td>0.01039</td>
      <td>21741.750000</td>
      <td>4.756000e-02</td>
    </tr>
    <tr>
      <th>34</th>
      <td>ETH/USD</td>
      <td>2023-03-09 04:21:57.250</td>
      <td>ETH</td>
      <td>USD</td>
      <td>1538.880000</td>
      <td>2.59280</td>
      <td>1539.110000</td>
      <td>1.819300e+00</td>
    </tr>
    <tr>
      <th>35</th>
      <td>USDT/USD</td>
      <td>2023-03-09 04:21:57.319</td>
      <td>USDT</td>
      <td>USD</td>
      <td>0.999800</td>
      <td>199911.00000</td>
      <td>1.000000</td>
      <td>1.134335e+06</td>
    </tr>
    <tr>
      <th>36</th>
      <td>BNB/USD</td>
      <td>2023-03-09 04:21:57.400</td>
      <td>BNB</td>
      <td>USD</td>
      <td>289.600000</td>
      <td>4.37900</td>
      <td>289.700000</td>
      <td>5.220000e+00</td>
    </tr>
    <tr>
      <th>37</th>
      <td>ADA/USD</td>
      <td>2023-03-09 04:21:57.474</td>
      <td>ADA</td>
      <td>USD</td>
      <td>0.318400</td>
      <td>3800.00000</td>
      <td>0.318500</td>
      <td>2.180600e+03</td>
    </tr>
    <tr>
      <th>38</th>
      <td>BUSD/USD</td>
      <td>2023-03-09 04:21:57.542</td>
      <td>BUSD</td>
      <td>USD</td>
      <td>0.999700</td>
      <td>505415.00000</td>
      <td>0.999900</td>
      <td>1.052909e+06</td>
    </tr>
    <tr>
      <th>39</th>
      <td>MATIC/USD</td>
      <td>2023-03-09 04:21:57.609</td>
      <td>MATIC</td>
      <td>USD</td>
      <td>1.060800</td>
      <td>740.60000</td>
      <td>1.061200</td>
      <td>5.358000e+02</td>
    </tr>
    <tr>
      <th>40</th>
      <td>USDC/USD</td>
      <td>2023-03-09 04:21:57.675</td>
      <td>USDC</td>
      <td>USD</td>
      <td>0.999900</td>
      <td>26805.03000</td>
      <td>1.000000</td>
      <td>2.263540e+05</td>
    </tr>
    <tr>
      <th>41</th>
      <td>MANA/USD</td>
      <td>2023-03-09 04:21:57.739</td>
      <td>MANA</td>
      <td>USD</td>
      <td>0.549700</td>
      <td>330.00000</td>
      <td>0.550300</td>
      <td>5.900000e+02</td>
    </tr>
    <tr>
      <th>42</th>
      <td>DAI/USD</td>
      <td>2023-03-09 04:21:57.803</td>
      <td>DAI</td>
      <td>USD</td>
      <td>0.995600</td>
      <td>11915.87000</td>
      <td>1.000200</td>
      <td>4.036386e+04</td>
    </tr>
    <tr>
      <th>43</th>
      <td>SOL/USD</td>
      <td>2023-03-09 04:21:57.869</td>
      <td>SOL</td>
      <td>USD</td>
      <td>18.520000</td>
      <td>2.69000</td>
      <td>18.530000</td>
      <td>5.374100e+02</td>
    </tr>
    <tr>
      <th>44</th>
      <td>TRX/USD</td>
      <td>2023-03-09 04:21:57.934</td>
      <td>TRX</td>
      <td>USD</td>
      <td>0.065720</td>
      <td>2541.00000</td>
      <td>0.065760</td>
      <td>3.263600e+03</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The following cell can be used to download additional order book data sets for testing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="n">search_time</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">search_time</span>

<span class="c1"># wait for arbitrage opportunity</span>
<span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">timeout</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="n">get_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dg</span><span class="p">)</span>
    <span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">negative_edge_cycle</span><span class="p">(</span><span class="n">dg_order_book</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">heuristic</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;arbitrage found!&quot;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s2"> orderbook </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H_%M_%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">order_book</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;order book saved to: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no arbitrage found in </span><span class="si">{search_time}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.arbitrage found!
order book saved to: Binance_US_orderbook_20230309_04_22_02.csv
</pre></div>
</div>
</div>
</div>
<p>How would the reader extend the current model to having more than one trade (i, j)?</p>
<p>How to combine multiple exchanges?</p>
<!---

## Bibliographic Notes

Crytocurrency markets are relatively new compared to other markets, and relatively few academic papers are available that specifically address arbitrage on those markets. Early studies, such as the following, reported periods of large, recurrent arbitrage opportunities that exist across exchanges, and that can persist for several days or weeks.

> Makarov, I., & Schoar, A. (2020). Trading and arbitrage in cryptocurrency markets. Journal of Financial Economics, 135(2), 293-319.

Subsequent work reports these prices differentials do exist, but only at a fraction of the values previously reported, and only for fleeting periods of time. 

> Crépellière, T., & Zeisberger, S. (2020). Arbitrage in the Market for Cryptocurrencies. Available at SSRN 3606053.  https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3606053

The use of network algorithms to identify cross-exchange arbitrage has appeared in the academic literature, and in numerous web sites demonstrating optimization and network applications. Representative examples are cited below.

> Peduzzi, G., James, J., & Xu, J. (2021, September). JACK THE RIPPLER: Arbitrage on the Decentralized Exchange of the XRP Ledger. In 2021 3rd Conference on Blockchain Research & Applications for Innovative Networks and Services (BRAINS) (pp. 1-2). IEEE. https://arxiv.org/pdf/2106.16158.pdf

> Bruzgė, R., & Šapkauskienė, A. (2022). Network analysis on Bitcoin arbitrage opportunities. The North American Journal of Economics and Finance, 59, 101562. https://doi.org/10.1016/j.najef.2021.101562

> Bruzgė, R., & Šapkauskienė, A. (2022). Dataset for Bitcoin arbitrage in different cryptocurrency exchanges. Data in Brief, 40, 107731. 

The work in this notebook is related to materials found in the following web resources.

> https://anilpai.medium.com/currency-arbitrage-using-bellman-ford-algorithm-8938dcea56ea

> [Crypto Trading and Arbitrage Identification Strategies](https://nbviewer.org/github/rcroessmann/sharing_public/blob/master/arbitrage_identification.ipynb)

A more complete analysis of trading and exploiting arbitrage opportunities in decentralized finance markets is available in the following paper and thesis.

> Byrne, S. An Exploration of Novel Trading and Arbitrage Methods within Decentralised Finance. https://www.scss.tcd.ie/Donal.OMahony/bfg/202021/StephenByrneDissertation.pdf

> Levus, R., Berko, A., Chyrun, L., Panasyuk, V., & Hrubel, M. (2021). Intelligent System for Arbitrage Situations Searching in the Cryptocurrency Market. In CEUR Workshop Proceedings (pp. 407-440). http://ceur-ws.org/Vol-2917/paper32.pdf

In addition to the analysis of arbitrage opportunities, convex optimization may also have an important role in the developing of trading algorithms for crypocurrency exchanges.

> Angeris, G., Agrawal, A., Evans, A., Chitra, T., & Boyd, S. (2021). Constant function market makers: Multi-asset trades via convex optimization. arXiv preprint arXiv:2107.12484. https://baincapitalcrypto.com/constant-function-market-makers-multi-asset-trades-via-convex-optimization/ and https://arxiv.org/pdf/2107.12484.pdf

---></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/04"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="gasoline-distribution.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Gasoline distribution</p>
      </div>
    </a>
    <a class="right-next"
       href="shortest-path-road-networks.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Extra material: Shortest path in real life</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installations-and-imports">Installations and Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-and-solvers">Pyomo and Solvers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ccxt">CCXT</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#networkx">Networkx</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cryptocurrency-exchanges">Cryptocurrency exchanges</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-an-exchange-as-a-directed-graph">Representing an exchange as a directed graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exchange-order-book">Exchange order book</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelling-the-arbitrage-search-problem-as-a-graph">Modelling the arbitrage search problem as a graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trading-and-arbitrage">Trading and Arbitrage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-order-books-that-demonstrate-arbitrage-opportunities">Find order books that demonstrate arbitrage opportunities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#brute-force-search-arbitrage-with-simple-cycles">Brute force search arbitrage with simple cycles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-model-for-arbitrage-with-capacity-constraints">Pyomo Model for Arbitrage with Capacity Constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-to-the-user">Questions to the user</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-time-downloads-of-order-books-from-an-exchange">Real Time Downloads of Order Books from an Exchange</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The MO Book Group
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>