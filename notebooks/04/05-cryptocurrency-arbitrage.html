
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4.5 Cryptocurrency arbitrage search &#8212; Companion code for the book &#34;Hands-On Mathematical Optimization with Python&#34;</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-DVQ7NZ8CYZ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DVQ7NZ8CYZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DVQ7NZ8CYZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/04/05-cryptocurrency-arbitrage';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Extra material: Energy dispatch problem" href="06-power-network.html" />
    <link rel="prev" title="4.4 Exam room scheduling" href="04-exam-room-scheduling.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cover.jpg" class="logo__image only-light" alt="Companion code for the book "Hands-On Mathematical Optimization with Python" - Home"/>
    <script>document.write(`<img src="../../_static/cover.jpg" class="logo__image only-dark" alt="Companion code for the book "Hands-On Mathematical Optimization with Python" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Hands-On Mathematical Optimization with Python
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/01.00.html">1. Mathematical Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/01-production-planning.html">1.1 A first production planning problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/02-production-planning-basic.html">1.2 A basic Pyomo model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/03-production-planning-advanced.html">1.3 A data-driven Pyomo Model</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/02.00.html">2. Linear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/01-bim.html">2.1 BIM production planning using linear optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/02-lad-regression.html">2.2 Least Absolute Deviation (LAD) Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/03-mad-portfolio-optimization.html">2.3 Mean Absolute Deviation (MAD) portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/04-bim-maxmin.html">2.4 BIM production for worst case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/05-bim-fractional.html">2.5 BIM production variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/06-bim-dual.html">2.6 Dual of the BIM production problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/07-bim-demand-forecast.html">2.7 BIM production using demand forecasts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/08-L1-regression-wine-quality.html">Extra material: Wine quality prediction with <span class="math notranslate nohighlight">\(L_1\)</span> regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/09-production-facility-worst-case.html">Extra material: Multi-product facility production</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../03/03.00.html">3. Mixed Integer Linear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03/01-bim-perturbed.html">3.1 BIM production with perturbed data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/02-shift-scheduling.html">3.2 Workforce shift scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/03-recharging-electric-vehicle.html">3.3 Recharging strategy for an electric vehicle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/04-simple-production-model-gdp.html">3.4 Production model using disjunctions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/05-machine-scheduling.html">3.5 Machine Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/06-facility-location.html">3.6 Facility location problem</a></li>


<li class="toctree-l2"><a class="reference internal" href="../03/07-bim-production-revisited.html">3.7 BIM production revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/08-cryptarithms.html">Extra material: Cryptarithms puzzle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/09-strip-packing.html">Extra material: Strip packing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/10-job-shop-scheduling.html">Extra material: Job shop scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/11-maintenance-planning.html">Extra material: Maintenance planning</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="04.00.html">4. Network Optimization</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01-dinner-seat-allocation.html">4.1 Dinner seating arrangement</a></li>

<li class="toctree-l2"><a class="reference internal" href="02-mincost-flow.html">4.2 Minimum-Cost Flow Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-gasoline-distribution.html">4.3 Gasoline distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-exam-room-scheduling.html">4.4 Exam room scheduling</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">4.5 Cryptocurrency arbitrage search</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-power-network.html">Extra material: Energy dispatch problem</a></li>



<li class="toctree-l2"><a class="reference internal" href="07-forex-arbitrage.html">Extra material: Forex Arbitrage</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-traveling-salesman-problem.html">Extra material: Traveling Salesman Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-shortest-path-road-networks.html">Extra material: Shortest path problem in real life</a></li>


</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../05/05.00.html">5. Convex Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../05/01-milk-pooling.html">5.1 Milk pooling and blending</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/02-ols-regression.html">5.2 Ordinary Least Squares (OLS) Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/03-markowitz-portfolio.html">5.3 Markowitz portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/04-svm-binary-classification.html">5.4 Support Vector Machines for binary classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/05-refinery-production.html">Extra material: Refinery production and shadow pricing with CVXPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/06-cutting-stock.html">Extra Material: Cutting Stock</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../06/06.00.html">6. Conic Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06/01-economic-order-quantity.html">6.1 Economic Order Quantity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/02-kelly-criterion.html">6.2 The Kelly criterion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/03-markowitz-portfolio-revisited.html">6.3 Markowitz portfolio optimization revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/04-building-insulation.html">6.4 Optimal Design of Multilayered Building Insulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/05-svm-conic.html">Extra material: Support Vector Machines with conic optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/06-investment-wheel.html">Extra material: Luenberger’s Investment Wheel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/07-optimal-growth-portfolios.html">Extra material: Optimal Growth Portfolios with Risk Aversion</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../07/07.00.html">7. Accounting for Uncertainty: Optimization Meets Reality</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07/01-fleet-assignment.html">7.1 Fleet assignment problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/02-bim-robustness-analysis.html">7.2 Robustness analysis of BIM production plan via simulations</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../08/08.00.html">8. Robust Optimization - Single Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08/01-bim-robust-optimization.html">8.1 Robust BIM microchip production problem</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../09/09.00.html">9. Stochastic Optimization - Single Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09/01-markowitz-portfolio-with-chance-constraint.html">9.1 Markowitz portfolio optimization with chance constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/02-pop-up-shop.html">9.2 Pop-up shop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/03-seafood-distribution-center.html">9.3 Stock optimization for seafood distribution center</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/04-economic-dispatch.html">9.4 Economic dispatch in renewable energy systems using chance constraints</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../10/10.00.html">10. Two-Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../10/01-aircraft-seat-allocation.html">10.1 Aircraft seat allocation problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/02-two-stage-production-planning.html">10.2 Two-stage production planning using constraint and column generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/03-opf-linear-decision-rule.html">10.3 Optimal power flow problem with recourse actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/04-farmer-problem.html">Extra: The farmer’s problem and its variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/05-opf-wind-curtailment.html">Extra: Two-stage energy dispatch optimization with wind curtailment</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../appendix/appendix.html">Appendix: Working with Pyomo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../appendix/pyomo-style-guide.html">Pyomo style guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../appendix/functional-programming-pyomo.html">Functional Programming with Pyomo</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/mobook/MO-book/blob/main/notebooks/04/05-cryptocurrency-arbitrage.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mobook/MO-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mobook/MO-book/issues/new?title=Issue%20on%20page%20%2Fnotebooks/04/05-cryptocurrency-arbitrage.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/04/05-cryptocurrency-arbitrage.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>4.5 Cryptocurrency arbitrage search</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installations-and-imports">Installations and Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble-install-pyomo-and-a-solver">Preamble: Install Pyomo and a solver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-description">Problem description</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-libraries-needed-networkx-and-ccxt">Additional libraries needed: NetworkX and CCXT</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-cryptocurrency-exchanges">Available cryptocurrency exchanges</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-an-exchange-as-a-directed-graph">Representing an exchange as a directed graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exchange-order-book">Exchange order book</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelling-the-arbitrage-search-problem-as-a-graph">Modelling the arbitrage search problem as a graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trading-and-arbitrage">Trading and arbitrage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-order-books-that-have-arbitrage-opportunities">Find order books that have arbitrage opportunities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#brute-force-search-arbitrage-with-simple-cycles">Brute force search arbitrage with simple cycles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-model-for-arbitrage-with-capacity-constraints">Pyomo model for arbitrage with capacity constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-for-the-reader">Exercises for the reader</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-time-downloads-of-order-books-from-an-exchange">Real Time Downloads of Order Books from an Exchange</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliographic-notes">Bibliographic Notes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="cryptocurrency-arbitrage-search">
<span id="index-5"></span><span id="index-4"></span><span id="index-3"></span><span id="index-2"></span><span id="index-1"></span><span id="index-0"></span><h1>4.5 Cryptocurrency arbitrage search<a class="headerlink" href="#cryptocurrency-arbitrage-search" title="Link to this heading">#</a></h1>
<section id="installations-and-imports">
<h2>Installations and Imports<a class="headerlink" href="#installations-and-imports" title="Link to this heading">#</a></h2>
</section>
<section id="preamble-install-pyomo-and-a-solver">
<h2>Preamble: Install Pyomo and a solver<a class="headerlink" href="#preamble-install-pyomo-and-a-solver" title="Link to this heading">#</a></h2>
<p>The following cell sets and verifies a global SOLVER for the notebook. If run on Google Colab, the cell installs Pyomo and the HiGHS solver, while, if run elsewhere, it assumes Pyomo and HiGHS have been previously installed. It then sets to use HiGHS as solver via the appsi module and a test is performed to verify that it is available. The solver interface is stored in a global object <code class="docutils literal notranslate"><span class="pre">SOLVER</span></code> for later use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
 
<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">%</span><span class="k">pip</span> install pyomo &gt;/dev/null 2&gt;/dev/null
    <span class="o">%</span><span class="k">pip</span> install highspy &gt;/dev/null 2&gt;/dev/null
 
<span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;appsi_highs&#39;</span>
 
<span class="kn">import</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span>
<span class="n">SOLVER</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">SOLVER</span><span class="o">.</span><span class="n">available</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Solver </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> is not available.&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-description">
<h2>Problem description<a class="headerlink" href="#problem-description" title="Link to this heading">#</a></h2>
<p>Cryptocurrency exchanges are web services that enable the purchase, sale, and exchange of cryptocurrencies. These exchanges provide liquidity for owners and establish the relative value of these currencies. Joining an exchange enables a user to maintain multiple currencies in a digital wallet, buy and sell currencies, and use cryptocurrencies for financial transactions.</p>
<p>In this notebook, we explore the efficiency of cryptocurrency exchanges by testing for arbitrage opportunities. An arbitrage exists if a customer can realize a net profit through a sequence of risk-free trades. The efficient market hypothesis assumes arbitrage opportunities are quickly identified and exploited by investors. As a result of their trading, prices reach a new equilibrium so that any arbitrage opportunities would be small and fleeting in an efficient market. The question here is whether it is possible, with real-time data and rapid execution, for a trader to profit from these fleeting arbitrage opportunities.</p>
<section id="additional-libraries-needed-networkx-and-ccxt">
<h3>Additional libraries needed: NetworkX and CCXT<a class="headerlink" href="#additional-libraries-needed-networkx-and-ccxt" title="Link to this heading">#</a></h3>
<p>This notebook uses two additional libraries: NetworkX and CCXT.</p>
<p><a class="reference external" href="https://networkx.org/">NetworkX</a> is a Python library for the creation, manipulation, and study of the structure, dynamics, and functions of complex networks, which is installed by deafult on Google Colab.</p>
<p><a class="reference external" href="https://github.com/ccxt/ccxt">CCXT</a> is an open-source library for connecting to cryptocurrency exchanges. The CCXT library is not installed by default in Google Colab, so it must be installed with the following command.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>%pip install ccxt
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install ccxt
</pre></div>
</div>
</div>
</div>
<p>We import all the libraries we need for this notebook in the following cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ccxt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="available-cryptocurrency-exchanges">
<h3>Available cryptocurrency exchanges<a class="headerlink" href="#available-cryptocurrency-exchanges" title="Link to this heading">#</a></h3>
<p>Here we use the <code class="docutils literal notranslate"><span class="pre">ccxt</span></code> library and list current exchanges supported by <code class="docutils literal notranslate"><span class="pre">ccxt</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available exchanges:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ccxt</span><span class="o">.</span><span class="n">exchanges</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">exchange</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Available exchanges:

  1) ace                   2) alpaca                3) ascendex              4) bequant             
  5) bigone                6) binance               7) binancecoinm          8) binanceus           
  9) binanceusdm          10) bit2c                11) bitbank              12) bitbay              
 13) bitbns               14) bitcoincom           15) bitfinex             16) bitfinex2           
 17) bitflyer             18) bitforex             19) bitget               20) bithumb             
 21) bitmart              22) bitmex               23) bitopro              24) bitpanda            
 25) bitrue               26) bitso                27) bitstamp             28) bitstamp1           
 29) bittrex              30) bitvavo              31) bkex                 32) bl3p                
 33) blockchaincom        34) btcalpha             35) btcbox               36) btcmarkets          
 37) btctradeua           38) btcturk              39) bybit                40) cex                 
 41) coinbase             42) coinbaseprime        43) coinbasepro          44) coincheck           
 45) coinex               46) coinfalcon           47) coinmate             48) coinone             
 49) coinsph              50) coinspot             51) cryptocom            52) currencycom         
 53) delta                54) deribit              55) digifinex            56) exmo                
 57) fmfwio               58) gate                 59) gateio               60) gemini              
 61) hitbtc               62) hitbtc3              63) hollaex              64) huobi               
 65) huobijp              66) huobipro             67) idex                 68) independentreserve  
 69) indodax              70) kraken               71) krakenfutures        72) kucoin              
 73) kucoinfutures        74) kuna                 75) latoken              76) lbank               
 77) lbank2               78) luno                 79) lykke                80) mercado             
 81) mexc                 82) mexc3                83) ndax                 84) novadax             
 85) oceanex              86) okcoin               87) okex                 88) okex5               
 89) okx                  90) paymium              91) phemex               92) poloniex            
 93) poloniexfutures      94) probit               95) tidex                96) timex               
 97) tokocrypto           98) upbit                99) wavesexchange       100) wazirx              
101) whitebit            102) woo                 103) yobit               104) zaif                
105) zonda               
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="representing-an-exchange-as-a-directed-graph">
<h2>Representing an exchange as a directed graph<a class="headerlink" href="#representing-an-exchange-as-a-directed-graph" title="Link to this heading">#</a></h2>
<p>First, we need some terminology. Trading between two specific currencies is called a market, with each exchange hosting multiple markets. <code class="docutils literal notranslate"><span class="pre">ccxt</span></code> labels each market with a symbol common across exchanges. The market symbol is an upper-case string with abbreviations for a pair of traded currencies separated by a slash (<span class="math notranslate nohighlight">\(/\)</span>). The first abbreviation is the base currency, the second is the quote currency. Prices for the base currency are denominated in units of the quote currency. As an example, <span class="math notranslate nohighlight">\(ETH/BTC\)</span> refers to a market for the base currency Ethereum (ETH) quoted in units of the Bitcoin (BTC). The same market symbol can refer to an offer to sell the base currency (a ‘bid’) or to an offer to sell the base currency (an ‘ask’). For example, <span class="math notranslate nohighlight">\(x\)</span> ETH/BTC means you can buy <span class="math notranslate nohighlight">\(x\)</span> units of BTC with one unit of ETH.</p>
<p>An exchange can be represented by a directed graph constructed from the market symbols available on that exchange. In such a graph currencies correspond to nodes on the directed graph. Market symbols correspond to edges in the directed graph, with the source indicating the quote currency and the destination indicating the base currency. The following code develops such a sample graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create an exchange object</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binanceus</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_exchange_dg</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">minimum_in_degree</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">markets</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">load_markets</span><span class="p">()</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="n">markets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="c1"># create an edge for all market symbols</span>
    <span class="n">dg</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="ow">in</span> <span class="p">[</span><span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">]:</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># remove base currencies with in_degree less than minimum_in_degree</span>
    <span class="n">remove_nodes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">node</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span>
        <span class="k">if</span> <span class="n">dg</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dg</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_in_degree</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">dg</span><span class="p">))):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">remove_nodes</span><span class="p">:</span>
            <span class="n">dg</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># color quote currencies in gold</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gold&quot;</span> <span class="k">if</span> <span class="n">dg</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;lightblue&quot;</span>

    <span class="k">return</span> <span class="n">dg</span>


<span class="k">def</span><span class="w"> </span><span class="nf">draw_dg</span><span class="p">(</span><span class="n">dg</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="n">n_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_nodes</span><span class="p">))</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span>
        <span class="n">dg</span><span class="p">,</span>
        <span class="n">pos</span><span class="p">,</span>
        <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">node_color</span><span class="o">=</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">()],</span>
        <span class="n">edge_color</span><span class="o">=</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">],</span>
        <span class="n">node_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">arrowsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">connectionstyle</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;arc3, rad=</span><span class="si">{</span><span class="n">rad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span>
        <span class="n">dg</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">edge_labels</span><span class="o">=</span><span class="p">{(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">dg</span><span class="o">.</span><span class="n">edges</span><span class="p">()}</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>


<span class="n">minimum_in_degree</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">exchange_dg</span> <span class="o">=</span> <span class="n">get_exchange_dg</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">minimum_in_degree</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">draw_dg</span><span class="p">(</span><span class="n">exchange_dg</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="n">exchange</span><span class="o">.</span><span class="n">name</span>
    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; - Network obtained filtering for minimum indegree (Base Currencies) = </span><span class="si">{</span><span class="n">minimum_in_degree</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of nodes = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exchange_dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of edges = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exchange_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Binance US - Network obtained filtering for minimum indegree (Base Currencies) = 10
Number of nodes = 155
Number of edges = 449
</pre></div>
</div>
<img alt="../../_images/331e0c01101d7ba15285fdc6bd15ab5c93717fb08397a2be205230b90d946bb0.png" src="../../_images/331e0c01101d7ba15285fdc6bd15ab5c93717fb08397a2be205230b90d946bb0.png" />
</div>
</div>
</section>
<section id="exchange-order-book">
<h2>Exchange order book<a class="headerlink" href="#exchange-order-book" title="Link to this heading">#</a></h2>
<p>The order book for a currency exchange is the real-time inventory of trading orders.</p>
<p>A <strong>bid</strong> is an offer to buy up to a specified amount of the base currency at the price not exceeding the ‘bid price’ in the quote currency.  An <strong>ask</strong> is an offer to sell up to a specified amount of the base currency at a price no less than a value specified given in the quote currency.</p>
<p>The exchange attempts to match the bid to ask order at a price less than or equal to the bid price. If a transaction occurs, the buyer will receive an amount of base currency less than or equal to the bid volume and the ask volume, at a price less than or equal to the bid price and no less than the specified value.</p>
<p>The order book for currency exchange is the real-time inventory of orders. The exchange order book maintains a list of all active orders for symbols traded on the exchange. Incoming bids above the lowest ask or incoming asks below the highest bid will be immediately matched and transactions executed following the rules of the exchange.</p>
<p>The following cell reads and displays a previously saved order book. Cells at the end of this notebook demonstrate how to retrieve an order book from an exchange and save it as a Pandas DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;Binance_US_orderbook_saved.csv&quot;</span>
<span class="k">if</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="s2">&quot;https://raw.githubusercontent.com/mobook/MO-book/main/notebooks/04/data/&quot;</span>
        <span class="o">+</span> <span class="n">filename</span><span class="p">,</span>
        <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>timestamp</th>
      <th>base</th>
      <th>quote</th>
      <th>bid_price</th>
      <th>bid_volume</th>
      <th>ask_price</th>
      <th>ask_volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ETH/BTC</td>
      <td>2023-03-02 15:36:06.529</td>
      <td>ETH</td>
      <td>BTC</td>
      <td>0.069735</td>
      <td>0.012000</td>
      <td>0.069759</td>
      <td>0.050000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BNB/BTC</td>
      <td>2023-03-02 15:36:06.583</td>
      <td>BNB</td>
      <td>BTC</td>
      <td>0.012743</td>
      <td>0.050000</td>
      <td>0.012755</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ADA/BTC</td>
      <td>2023-03-02 15:36:06.637</td>
      <td>ADA</td>
      <td>BTC</td>
      <td>0.000015</td>
      <td>2.000000</td>
      <td>0.000015</td>
      <td>2168.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SOL/BTC</td>
      <td>2023-03-02 15:36:06.690</td>
      <td>SOL</td>
      <td>BTC</td>
      <td>0.000935</td>
      <td>1.420000</td>
      <td>0.000936</td>
      <td>15.120000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MATIC/BTC</td>
      <td>2023-03-02 15:36:06.750</td>
      <td>MATIC</td>
      <td>BTC</td>
      <td>0.000052</td>
      <td>26.200000</td>
      <td>0.000052</td>
      <td>150.200000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>MANA/BTC</td>
      <td>2023-03-02 15:36:06.848</td>
      <td>MANA</td>
      <td>BTC</td>
      <td>0.000027</td>
      <td>831.000000</td>
      <td>0.000027</td>
      <td>1409.000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>TRX/BTC</td>
      <td>2023-03-02 15:36:06.905</td>
      <td>TRX</td>
      <td>BTC</td>
      <td>0.000003</td>
      <td>4.000000</td>
      <td>0.000003</td>
      <td>25352.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>ADA/ETH</td>
      <td>2023-03-02 15:36:06.960</td>
      <td>ADA</td>
      <td>ETH</td>
      <td>0.000214</td>
      <td>994.900000</td>
      <td>0.000214</td>
      <td>891.600000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>BTC/USDT</td>
      <td>2023-03-02 15:36:07.012</td>
      <td>BTC</td>
      <td>USDT</td>
      <td>23373.920000</td>
      <td>0.118619</td>
      <td>23376.000000</td>
      <td>0.045275</td>
    </tr>
    <tr>
      <th>9</th>
      <td>ETH/USDT</td>
      <td>2023-03-02 15:36:07.065</td>
      <td>ETH</td>
      <td>USDT</td>
      <td>1630.200000</td>
      <td>0.950000</td>
      <td>1630.770000</td>
      <td>0.500000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>BNB/USDT</td>
      <td>2023-03-02 15:36:07.118</td>
      <td>BNB</td>
      <td>USDT</td>
      <td>297.857700</td>
      <td>0.800000</td>
      <td>297.891900</td>
      <td>0.800000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>ADA/USDT</td>
      <td>2023-03-02 15:36:07.172</td>
      <td>ADA</td>
      <td>USDT</td>
      <td>0.348630</td>
      <td>1100.000000</td>
      <td>0.348750</td>
      <td>511.200000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>BUSD/USDT</td>
      <td>2023-03-02 15:36:07.226</td>
      <td>BUSD</td>
      <td>USDT</td>
      <td>0.999500</td>
      <td>293433.930000</td>
      <td>0.999600</td>
      <td>317175.730000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>SOL/USDT</td>
      <td>2023-03-02 15:36:07.288</td>
      <td>SOL</td>
      <td>USDT</td>
      <td>21.857000</td>
      <td>22.870000</td>
      <td>21.863500</td>
      <td>23.000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>USDC/USDT</td>
      <td>2023-03-02 15:36:07.342</td>
      <td>USDC</td>
      <td>USDT</td>
      <td>1.000100</td>
      <td>307657.000000</td>
      <td>1.000200</td>
      <td>299181.000000</td>
    </tr>
    <tr>
      <th>15</th>
      <td>MATIC/USDT</td>
      <td>2023-03-02 15:36:07.394</td>
      <td>MATIC</td>
      <td>USDT</td>
      <td>1.203000</td>
      <td>1664.600000</td>
      <td>1.205000</td>
      <td>5405.600000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>MANA/USDT</td>
      <td>2023-03-02 15:36:07.447</td>
      <td>MANA</td>
      <td>USDT</td>
      <td>0.631000</td>
      <td>157.000000</td>
      <td>0.632200</td>
      <td>571.000000</td>
    </tr>
    <tr>
      <th>17</th>
      <td>TRX/USDT</td>
      <td>2023-03-02 15:36:07.501</td>
      <td>TRX</td>
      <td>USDT</td>
      <td>0.069280</td>
      <td>10824.900000</td>
      <td>0.069330</td>
      <td>10818.600000</td>
    </tr>
    <tr>
      <th>18</th>
      <td>BTC/BUSD</td>
      <td>2023-03-02 15:36:07.612</td>
      <td>BTC</td>
      <td>BUSD</td>
      <td>23371.440000</td>
      <td>0.021500</td>
      <td>23376.830000</td>
      <td>0.021500</td>
    </tr>
    <tr>
      <th>19</th>
      <td>BNB/BUSD</td>
      <td>2023-03-02 15:36:07.665</td>
      <td>BNB</td>
      <td>BUSD</td>
      <td>297.763000</td>
      <td>1.670000</td>
      <td>297.952500</td>
      <td>1.340000</td>
    </tr>
    <tr>
      <th>20</th>
      <td>ETH/BUSD</td>
      <td>2023-03-02 15:36:07.719</td>
      <td>ETH</td>
      <td>BUSD</td>
      <td>1630.210000</td>
      <td>0.510000</td>
      <td>1630.760000</td>
      <td>0.255000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>MATIC/BUSD</td>
      <td>2023-03-02 15:36:07.772</td>
      <td>MATIC</td>
      <td>BUSD</td>
      <td>1.203410</td>
      <td>623.100000</td>
      <td>1.204540</td>
      <td>415.000000</td>
    </tr>
    <tr>
      <th>22</th>
      <td>USDC/BUSD</td>
      <td>2023-03-02 15:36:07.893</td>
      <td>USDC</td>
      <td>BUSD</td>
      <td>0.999900</td>
      <td>329027.800000</td>
      <td>1.000000</td>
      <td>279879.620000</td>
    </tr>
    <tr>
      <th>23</th>
      <td>MANA/BUSD</td>
      <td>2023-03-02 15:36:07.950</td>
      <td>MANA</td>
      <td>BUSD</td>
      <td>0.630700</td>
      <td>343.000000</td>
      <td>0.632100</td>
      <td>3054.000000</td>
    </tr>
    <tr>
      <th>24</th>
      <td>ADA/BUSD</td>
      <td>2023-03-02 15:36:08.003</td>
      <td>ADA</td>
      <td>BUSD</td>
      <td>0.348000</td>
      <td>6582.900000</td>
      <td>0.349000</td>
      <td>997.000000</td>
    </tr>
    <tr>
      <th>25</th>
      <td>SOL/BUSD</td>
      <td>2023-03-02 15:36:08.056</td>
      <td>SOL</td>
      <td>BUSD</td>
      <td>21.830000</td>
      <td>1.390000</td>
      <td>21.900000</td>
      <td>181.090000</td>
    </tr>
    <tr>
      <th>26</th>
      <td>TRX/BUSD</td>
      <td>2023-03-02 15:36:08.114</td>
      <td>TRX</td>
      <td>BUSD</td>
      <td>0.069290</td>
      <td>10823.900000</td>
      <td>0.069390</td>
      <td>25220.400000</td>
    </tr>
    <tr>
      <th>27</th>
      <td>BTC/USDC</td>
      <td>2023-03-02 15:36:08.170</td>
      <td>BTC</td>
      <td>USDC</td>
      <td>23371.660000</td>
      <td>0.020000</td>
      <td>23376.990000</td>
      <td>0.051000</td>
    </tr>
    <tr>
      <th>28</th>
      <td>ETH/USDC</td>
      <td>2023-03-02 15:36:08.228</td>
      <td>ETH</td>
      <td>USDC</td>
      <td>1630.160000</td>
      <td>0.100000</td>
      <td>1630.810000</td>
      <td>0.215000</td>
    </tr>
    <tr>
      <th>29</th>
      <td>SOL/USDC</td>
      <td>2023-03-02 15:36:08.298</td>
      <td>SOL</td>
      <td>USDC</td>
      <td>21.830000</td>
      <td>343.520000</td>
      <td>21.880000</td>
      <td>201.080000</td>
    </tr>
    <tr>
      <th>30</th>
      <td>ADA/USDC</td>
      <td>2023-03-02 15:36:08.368</td>
      <td>ADA</td>
      <td>USDC</td>
      <td>0.348200</td>
      <td>8615.400000</td>
      <td>0.349400</td>
      <td>2433.100000</td>
    </tr>
    <tr>
      <th>31</th>
      <td>BTC/DAI</td>
      <td>2023-03-02 15:36:08.433</td>
      <td>BTC</td>
      <td>DAI</td>
      <td>23366.440000</td>
      <td>0.049540</td>
      <td>23394.360000</td>
      <td>0.049500</td>
    </tr>
    <tr>
      <th>32</th>
      <td>ETH/DAI</td>
      <td>2023-03-02 15:36:08.485</td>
      <td>ETH</td>
      <td>DAI</td>
      <td>1629.890000</td>
      <td>0.497400</td>
      <td>1631.810000</td>
      <td>1.490000</td>
    </tr>
    <tr>
      <th>33</th>
      <td>BTC/USD</td>
      <td>2023-03-02 15:36:08.623</td>
      <td>BTC</td>
      <td>USD</td>
      <td>23373.010000</td>
      <td>0.007463</td>
      <td>23376.720000</td>
      <td>0.048805</td>
    </tr>
    <tr>
      <th>34</th>
      <td>ETH/USD</td>
      <td>2023-03-02 15:36:08.675</td>
      <td>ETH</td>
      <td>USD</td>
      <td>1630.490000</td>
      <td>2.564550</td>
      <td>1630.740000</td>
      <td>0.580700</td>
    </tr>
    <tr>
      <th>35</th>
      <td>USDT/USD</td>
      <td>2023-03-02 15:36:08.730</td>
      <td>USDT</td>
      <td>USD</td>
      <td>1.000000</td>
      <td>10407.870000</td>
      <td>1.000100</td>
      <td>954839.680000</td>
    </tr>
    <tr>
      <th>36</th>
      <td>BNB/USD</td>
      <td>2023-03-02 15:36:08.782</td>
      <td>BNB</td>
      <td>USD</td>
      <td>297.900200</td>
      <td>2.100000</td>
      <td>297.952500</td>
      <td>1.342000</td>
    </tr>
    <tr>
      <th>37</th>
      <td>ADA/USD</td>
      <td>2023-03-02 15:36:08.835</td>
      <td>ADA</td>
      <td>USD</td>
      <td>0.348800</td>
      <td>1500.000000</td>
      <td>0.348900</td>
      <td>3000.000000</td>
    </tr>
    <tr>
      <th>38</th>
      <td>BUSD/USD</td>
      <td>2023-03-02 15:36:08.942</td>
      <td>BUSD</td>
      <td>USD</td>
      <td>0.999500</td>
      <td>79157.800000</td>
      <td>0.999900</td>
      <td>795593.480000</td>
    </tr>
    <tr>
      <th>39</th>
      <td>MATIC/USD</td>
      <td>2023-03-02 15:36:08.998</td>
      <td>MATIC</td>
      <td>USD</td>
      <td>1.204000</td>
      <td>937.600000</td>
      <td>1.204500</td>
      <td>937.500000</td>
    </tr>
    <tr>
      <th>40</th>
      <td>USDC/USD</td>
      <td>2023-03-02 15:36:09.051</td>
      <td>USDC</td>
      <td>USD</td>
      <td>0.999900</td>
      <td>5050.300000</td>
      <td>1.000000</td>
      <td>517682.170000</td>
    </tr>
    <tr>
      <th>41</th>
      <td>MANA/USD</td>
      <td>2023-03-02 15:36:09.102</td>
      <td>MANA</td>
      <td>USD</td>
      <td>0.631000</td>
      <td>372.340000</td>
      <td>0.631600</td>
      <td>572.340000</td>
    </tr>
    <tr>
      <th>42</th>
      <td>DAI/USD</td>
      <td>2023-03-02 15:36:09.155</td>
      <td>DAI</td>
      <td>USD</td>
      <td>0.999100</td>
      <td>4534.660000</td>
      <td>1.000100</td>
      <td>7591.820000</td>
    </tr>
    <tr>
      <th>43</th>
      <td>SOL/USD</td>
      <td>2023-03-02 15:36:09.217</td>
      <td>SOL</td>
      <td>USD</td>
      <td>21.858100</td>
      <td>55.730000</td>
      <td>21.865900</td>
      <td>18.290000</td>
    </tr>
    <tr>
      <th>44</th>
      <td>TRX/USD</td>
      <td>2023-03-02 15:36:09.270</td>
      <td>TRX</td>
      <td>USD</td>
      <td>0.069200</td>
      <td>225602.200000</td>
      <td>0.069400</td>
      <td>224245.500000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="modelling-the-arbitrage-search-problem-as-a-graph">
<h2>Modelling the arbitrage search problem as a graph<a class="headerlink" href="#modelling-the-arbitrage-search-problem-as-a-graph" title="Link to this heading">#</a></h2>
<p>Our goal will be to find arbitrage opportunities, i.e., the possibility to start from a given currency and, through a sequence of executed trades, arrive back at the same currency with a higher balance than at the beginning. We will model this problem as a network one.</p>
<p>A bid appearing in the order book for the market symbol <span class="math notranslate nohighlight">\(b/q\)</span> is an order from a prospective counter party to purchase an amount of the base currency <span class="math notranslate nohighlight">\(b\)</span> at a bid price given in a quote currency <span class="math notranslate nohighlight">\(q\)</span>. For a currency trader, a bid in the order book is an opportunity to convert the base currency <span class="math notranslate nohighlight">\(b\)</span> into the quote currency <span class="math notranslate nohighlight">\(q\)</span>.</p>
<p>The order book can be represented as a directed graph where the nodes correspond to individual currencies. A directed edge <span class="math notranslate nohighlight">\(b\rightarrow q\)</span> from node <span class="math notranslate nohighlight">\(b\)</span> to node <span class="math notranslate nohighlight">\(q\)</span> describes an opportunity for us to convert currency <span class="math notranslate nohighlight">\(b\)</span> into units of currency <span class="math notranslate nohighlight">\(q\)</span>. Let <span class="math notranslate nohighlight">\(V_b\)</span> and <span class="math notranslate nohighlight">\(V_q\)</span> denote the amounts of each currency held by us, and let <span class="math notranslate nohighlight">\(x_{b\rightarrow q}\)</span> denote the amount of currency <span class="math notranslate nohighlight">\(b\)</span> exchanged for currency <span class="math notranslate nohighlight">\(j\)</span>. Following the transaction <span class="math notranslate nohighlight">\(x_{b\rightarrow q}\)</span> we have the following changes to the currency holdings</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    \Delta V_b &amp; = - x_{b\rightarrow q} \\
    \Delta V_q &amp; = a_{b\rightarrow q} x_{b\rightarrow q},
\end{align*}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(a_{b\rightarrow q}\)</span> is a <em>conversion coefficient</em> equal to the price of <span class="math notranslate nohighlight">\(b\)</span> expressed in terms of currency <span class="math notranslate nohighlight">\(q\)</span>. The capacity <span class="math notranslate nohighlight">\(c_{b\rightarrow q}\)</span> of a trading along edge <span class="math notranslate nohighlight">\(b\rightarrow q\)</span> is specified by a relationship</p>
<div class="math notranslate nohighlight">
\[
    x_{b\rightarrow q} \leq c_{b\rightarrow q}.
\]</div>
<p>Because the arcs in our graph correspond to two types of orders - bid and ask - we need to build a consistent way of expressing them in our  <span class="math notranslate nohighlight">\(a_{b\rightarrow q}\)</span>, <span class="math notranslate nohighlight">\(c_{b\rightarrow q}\)</span> notation. Imagine now that we are the party that accepts the buy and ask bids existing in the graph.</p>
<p>For bid orders, we have the opportunity to convert the base currency <span class="math notranslate nohighlight">\(b\)</span> into the quote currency <span class="math notranslate nohighlight">\(q\)</span>, for which we will use the following notation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
a_{b\rightarrow q} &amp; = \text{bid price} \\
c_{b\rightarrow q} &amp; = \text{bid volume}
\end{align*}
\end{split}\]</div>
<p>An ask order for symbol <span class="math notranslate nohighlight">\(b/q\)</span> is an order to sell the base currency at a price not less than the ‘ask’ price given in terms of the quote currency. The ask volume is the amount of base currency to be sold. For us, a sell order is an opportunity to convert the quoted currency into the base currency such that</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
a_{q\rightarrow b} &amp; = \frac{1}{\text{ask price}} \\
c_{q\rightarrow b} &amp; = \text{ask volume} \times \text{ask volume}
\end{align*}
\end{split}\]</div>
<p>The following cell creates a directed graph using data from an exchange order book. To distinguish between different order types, we will highlight the big orders with green color, and ask orders with red color.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">):</span>
    <span class="c1"># create a dictionary of edges index by (src, dst)</span>
    <span class="n">dg_order_book</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

    <span class="c1"># loop over each order in the order book dataframe</span>
    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">order_book</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="c1"># if the order is a &#39;bid&#39;, i.e., an order to purchase the base currency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_volume&quot;</span><span class="p">]):</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">]</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;quote&quot;</span><span class="p">]</span>
            <span class="c1"># add an edge to the graph with the relevant attributes</span>
            <span class="n">dg_order_book</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                <span class="n">src</span><span class="p">,</span>
                <span class="n">dst</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bid&quot;</span><span class="p">,</span>
                <span class="n">a</span><span class="o">=</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_price&quot;</span><span class="p">],</span>
                <span class="n">capacity</span><span class="o">=</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_volume&quot;</span><span class="p">],</span>
                <span class="n">weight</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;bid_price&quot;</span><span class="p">]),</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># if the order is an &#39;ask&#39;, i.e., an order to sell the base currency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_volume&quot;</span><span class="p">]):</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;quote&quot;</span><span class="p">]</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">]</span>
            <span class="c1"># add an edge to the graph with the relevant attributes</span>
            <span class="n">dg_order_book</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                <span class="n">src</span><span class="p">,</span>
                <span class="n">dst</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;ask&quot;</span><span class="p">,</span>
                <span class="n">a</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_price&quot;</span><span class="p">],</span>
                <span class="n">capacity</span><span class="o">=</span><span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_volume&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_price&quot;</span><span class="p">],</span>
                <span class="n">weight</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">order_book</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="s2">&quot;ask_price&quot;</span><span class="p">]),</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># loop over each node in the graph and set the color attribute to &quot;lightblue&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">dg_order_book</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lightblue&quot;</span>

    <span class="k">return</span> <span class="n">dg_order_book</span>


<span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First, we simply print the content of the order book as a list of arcs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display contents of the directed graph</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;src   --&gt; dst    kind            a                c&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;------------------------------------------------------&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">:</span><span class="s2">5s</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">:</span><span class="s2">5s</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">)][</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">)][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2"> 16f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">)][</span><span class="s1">&#39;capacity&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2"> 16f</span><span class="si">}</span><span class="s2">    &quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>src   --&gt; dst    kind            a                c
------------------------------------------------------
ETH   --&gt; BTC     bid        0.069735         0.012000    
ETH   --&gt; ADA     ask     4668.534080         0.190981    
ETH   --&gt; USDT    bid     1630.200000         0.950000    
ETH   --&gt; BUSD    bid     1630.210000         0.510000    
ETH   --&gt; USDC    bid     1630.160000         0.100000    
ETH   --&gt; DAI     bid     1629.890000         0.497400    
ETH   --&gt; USD     bid     1630.490000         2.564550    
BTC   --&gt; ETH     ask       14.335068         0.003488    
BTC   --&gt; BNB     ask       78.403701         0.038263    
BTC   --&gt; ADA     ask    66844.919786         0.032433    
BTC   --&gt; SOL     ask     1068.261938         0.014154    
BTC   --&gt; MATIC   ask    19391.118868         0.007746    
BTC   --&gt; MANA    ask    36968.576710         0.038113    
BTC   --&gt; TRX     ask   335570.469799         0.075549    
BTC   --&gt; USDT    bid    23373.920000         0.118619    
BTC   --&gt; BUSD    bid    23371.440000         0.021500    
BTC   --&gt; USDC    bid    23371.660000         0.020000    
BTC   --&gt; DAI     bid    23366.440000         0.049540    
BTC   --&gt; USD     bid    23373.010000         0.007463    
BNB   --&gt; BTC     bid        0.012743         0.050000    
BNB   --&gt; USDT    bid      297.857700         0.800000    
BNB   --&gt; BUSD    bid      297.763000         1.670000    
BNB   --&gt; USD     bid      297.900200         2.100000    
ADA   --&gt; BTC     bid        0.000015         2.000000    
ADA   --&gt; ETH     bid        0.000214       994.900000    
ADA   --&gt; USDT    bid        0.348630      1100.000000    
ADA   --&gt; BUSD    bid        0.348000      6582.900000    
ADA   --&gt; USDC    bid        0.348200      8615.400000    
ADA   --&gt; USD     bid        0.348800      1500.000000    
SOL   --&gt; BTC     bid        0.000935         1.420000    
SOL   --&gt; USDT    bid       21.857000        22.870000    
SOL   --&gt; BUSD    bid       21.830000         1.390000    
SOL   --&gt; USDC    bid       21.830000       343.520000    
SOL   --&gt; USD     bid       21.858100        55.730000    
MATIC --&gt; BTC     bid        0.000052        26.200000    
MATIC --&gt; USDT    bid        1.203000      1664.600000    
MATIC --&gt; BUSD    bid        1.203410       623.100000    
MATIC --&gt; USD     bid        1.204000       937.600000    
MANA  --&gt; BTC     bid        0.000027       831.000000    
MANA  --&gt; USDT    bid        0.631000       157.000000    
MANA  --&gt; BUSD    bid        0.630700       343.000000    
MANA  --&gt; USD     bid        0.631000       372.340000    
TRX   --&gt; BTC     bid        0.000003         4.000000    
TRX   --&gt; USDT    bid        0.069280     10824.900000    
TRX   --&gt; BUSD    bid        0.069290     10823.900000    
TRX   --&gt; USD     bid        0.069200    225602.200000    
USDT  --&gt; BTC     ask        0.000043      1058.348400    
USDT  --&gt; ETH     ask        0.000613       815.385000    
USDT  --&gt; BNB     ask        0.003357       238.313520    
USDT  --&gt; ADA     ask        2.867384       178.281000    
USDT  --&gt; BUSD    ask        1.000400    317048.859708    
USDT  --&gt; SOL     ask        0.045738       502.860500    
USDT  --&gt; USDC    ask        0.999800    299240.836200    
USDT  --&gt; MATIC   ask        0.829876      6513.748000    
USDT  --&gt; MANA    ask        1.581778       360.986200    
USDT  --&gt; TRX     ask       14.423770       750.053538    
USDT  --&gt; USD     bid        1.000000     10407.870000    
BUSD  --&gt; USDT    bid        0.999500    293433.930000    
BUSD  --&gt; BTC     ask        0.000043       502.601845    
BUSD  --&gt; BNB     ask        0.003356       399.256350    
BUSD  --&gt; ETH     ask        0.000613       415.843800    
BUSD  --&gt; MATIC   ask        0.830192       499.884100    
BUSD  --&gt; USDC    ask        1.000000    279879.620000    
BUSD  --&gt; MANA    ask        1.582028      1930.433400    
BUSD  --&gt; ADA     ask        2.865330       347.953000    
BUSD  --&gt; SOL     ask        0.045662      3965.871000    
BUSD  --&gt; TRX     ask       14.411298      1750.043556    
BUSD  --&gt; USD     bid        0.999500     79157.800000    
USDC  --&gt; USDT    bid        1.000100    307657.000000    
USDC  --&gt; BUSD    bid        0.999900    329027.800000    
USDC  --&gt; BTC     ask        0.000043      1192.226490    
USDC  --&gt; ETH     ask        0.000613       350.624150    
USDC  --&gt; SOL     ask        0.045704      4399.630400    
USDC  --&gt; ADA     ask        2.862049       850.125140    
USDC  --&gt; USD     bid        0.999900      5050.300000    
DAI   --&gt; BTC     ask        0.000043      1158.020820    
DAI   --&gt; ETH     ask        0.000613      2431.396900    
DAI   --&gt; USD     bid        0.999100      4534.660000    
USD   --&gt; BTC     ask        0.000043      1140.900820    
USD   --&gt; ETH     ask        0.000613       946.970718    
USD   --&gt; USDT    ask        0.999900    954935.163968    
USD   --&gt; BNB     ask        0.003356       399.852255    
USD   --&gt; ADA     ask        2.866151      1046.700000    
USD   --&gt; BUSD    ask        1.000100    795513.920652    
USD   --&gt; MATIC   ask        0.830220      1129.218750    
USD   --&gt; USDC    ask        1.000000    517682.170000    
USD   --&gt; MANA    ask        1.583281       361.489944    
USD   --&gt; DAI     ask        0.999900      7592.579182    
USD   --&gt; SOL     ask        0.045733       399.927311    
USD   --&gt; TRX     ask       14.409222     15562.637700    
</pre></div>
</div>
</div>
</div>
<p>Next, we draw the graph itself.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">draw_dg</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d1d412c48358ebfbd002a217e8b904cf374f5cb716d5469a3933d357d6f8f79d.png" src="../../_images/d1d412c48358ebfbd002a217e8b904cf374f5cb716d5469a3933d357d6f8f79d.png" />
</div>
</div>
</section>
<section id="trading-and-arbitrage">
<h2>Trading and arbitrage<a class="headerlink" href="#trading-and-arbitrage" title="Link to this heading">#</a></h2>
<p>With this unified treatment of bid and ask orders, we are ready to formulate the mathematical problem of finding an arbitrage opportunity. An arbitrage exists if it is possible to find a closed path and a sequence of transactions in the directed graph resulting in a net increase in currency holdings. Given a path</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
    i_0 \rightarrow i_1 \rightarrow i_2 \rightarrow \cdots \rightarrow i_{n-1} \rightarrow i_n
\end{align*}
\]</div>
<p>the path is closed if <span class="math notranslate nohighlight">\(i_n = i_0\)</span>. The path has finite capacity if each edge in the path has a non-zero capacity. For a sufficiently small holding <span class="math notranslate nohighlight">\(w_{i_0}\)</span> of currency <span class="math notranslate nohighlight">\(i_0\)</span> (because of capacity constraints), a closed path with <span class="math notranslate nohighlight">\(i_0 = i_n\)</span> represents an arbitrage opportunity if</p>
<div class="math notranslate nohighlight">
\[
\begin{equation} 
    \prod_{k=0}^{n-1} a_{i_k\rightarrow i_{k+1}} &gt; 1.
\end{equation}
\]</div>
<p>If all we care about is simply finding an arbitrage cycle, regardless of the volume traded, we can use one of the many shortest path algorithms from the <code class="docutils literal notranslate"><span class="pre">networkx</span></code> library. To convert the problem of finding a path meeting  the above condition into a sum-of-terms to be minimized, we can take the negative logarithm of both sides to obtain the condition:</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
    -\log(\prod_{k=0}^{n-1} a_{i_k\rightarrow i_{k+1}}) = - \sum\limits_{k = 0}^{n-1} \log (a_{i_k\rightarrow i_{k+1}}) &lt; 0,
\end{align*}
\]</div>
<p>In other words, if we assign the negative logarithm as the weight of arcs in a graph, then our problem just becomes translated into the problem of searching for a cycle with a total sum of weights along it to be negative.</p>
</section>
<section id="find-order-books-that-have-arbitrage-opportunities">
<h2>Find order books that have arbitrage opportunities<a class="headerlink" href="#find-order-books-that-have-arbitrage-opportunities" title="Link to this heading">#</a></h2>
<p>A <em>simple cycle</em> is a closed path in which no node appears twice. Simple cycles are distinct if they are not cyclic permutations (essentially, the same set of nodes but with a different start and end points) of each other. One could check for arbitrage opportunities by checking if there are any negative simple cycles in the graph.</p>
<p>However, searching for a negative-weight cycle through searching for an arbitrage opportunity can be a daunting task - a brute-force search over all simple cycles has complexity <span class="math notranslate nohighlight">\((n + e)(c + 1)\)</span> which is impractical for large-scale applications. A more efficient search based on the Bellman-Ford algorithm is embedded in the NetworkX function <a class="reference external" href="https://networkx.org/documentation/networkx-1.10/reference/generated/networkx.algorithms.shortest_paths.weighted.negative_edge_cycle.html"><code class="docutils literal notranslate"><span class="pre">negative_edge_cycle</span></code></a> that returns a logical True if a negative cycle exists in a directed graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">negative_edge_cycle</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">heuristic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">negative_edge_cycle</span></code> is fast, but it only indicates if there is a negative cycle or not, and we don’t even know what kind of a cycle is it so it would be hard to use that information to perform an arbitrage.</p>
<p>Luckily, the <code class="docutils literal notranslate"><span class="pre">networkx</span></code> library includes the function <a class="reference external" href="https://networkx.org/documentation/stable/reference/algorithms/generated/networkx.algorithms.shortest_paths.weighted.find_negative_cycle.html"><code class="docutils literal notranslate"><span class="pre">find_negative_cycle</span></code></a> that locates a single negative edge cycle if one exists. We can use this to demonstrate the existence of an arbitrage opportunity and to highlight that opportunity on the directed graph of all possible trades. The following cell reports the cycle found and the corresponding trading return measured in basis points (1 basis point = 0.01%). The same trading cycle is marked with thicker arcs in the graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sum_weights</span><span class="p">(</span><span class="n">cycle</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cycle</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
<span class="n">arb</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">find_negative_cycle</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">bp</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sum_weights</span><span class="p">(</span><span class="n">arb</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arb</span><span class="p">,</span> <span class="n">arb</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">arb</span><span class="p">[:</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">order_book_dg</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">dst</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Trading cycle with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">arb</span><span class="p">))</span><span class="si">}</span><span class="s2"> trades: </span><span class="si">{</span><span class="s1">&#39; --&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">arb</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">Return = </span><span class="si">{</span><span class="n">bp</span><span class="si">:</span><span class="s2">6.3f</span><span class="si">}</span><span class="s2"> basis points &quot;</span>
<span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">draw_dg</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trading cycle with 3 trades: USDC --&gt; USDT --&gt; BUSD
Return =  5.002 basis points 
</pre></div>
</div>
<img alt="../../_images/b7839168395c04636d4d3ca4880e56ce3ffe27de0cd4c53c54a3e897603f126e.png" src="../../_images/b7839168395c04636d4d3ca4880e56ce3ffe27de0cd4c53c54a3e897603f126e.png" />
</div>
</div>
<p>Note this may or may not be the trading cycle with maximum return. There may be other cycles with higher or lower returns, and that allow higher or lower trading volumes.</p>
</section>
<section id="brute-force-search-arbitrage-with-simple-cycles">
<h2>Brute force search arbitrage with simple cycles<a class="headerlink" href="#brute-force-search-arbitrage-with-simple-cycles" title="Link to this heading">#</a></h2>
<p>Not all arbitrage cycles are the same - some yield a higher relative return (per dollar invested) than the others, and some yield a higher absolute return (maximum amount of money to be made risk-free) than others. This is because the amount of money that flows through a negative cycle is upper bounded by the size of the smallest order in that cycle. Thus, if one is looking for the best possible arbitrage sequence of trades, finding just ‘a cycle’ might not be enough.</p>
<p>A crude way to search for a good arbitrage opportunity would be to enumerate all possible simple cycles in a graph and pick the one that’s best according to whatever criterion we pick. A brute force search over for all simple cycles has order <span class="math notranslate nohighlight">\((N_{nodes} + N_{edges})(N_{cycles} + 1)\)</span> complexity, which is prohibitive for large order books. Nevertheless, we explore this option here to better understand the problem of finding and valuing arbitrage opportunities.</p>
<p>In the following cell, we compute the loss function for all simple cycles that can be constructed within a directed graph using the function <a class="reference external" href="https://networkx.org/documentation/stable/reference/algorithms/generated/networkx.algorithms.cycles.simple_cycles.html"><code class="docutils literal notranslate"><span class="pre">simple_cycles</span></code></a> from the <code class="docutils literal notranslate"><span class="pre">networkx</span></code> library to construct a dictionary of all distinct simple cycles in the order book. Each cycle is represented by an ordered list of nodes. For each cycle, the financial return is computed, and a histogram is constructed to show the distribution of potential returns. Several paths with the highest return are then overlaid on the graph of the order book.</p>
<p>Again, note that no account is taken of the trading capacity available on each path.</p>
<p>The next cell iterates over all simple cycles in a directed graph. This can take a long time for a large dense graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert order book to a directed graph</span>
<span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>


<span class="c1"># compute the sum of weights given a list of nodes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sum_weights</span><span class="p">(</span><span class="n">cycle</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cycle</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="c1"># create a dictionary of all simple cycles and sum of weights</span>
<span class="n">cycles</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">tuple</span><span class="p">(</span><span class="n">cycle</span><span class="p">):</span> <span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sum_weights</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span><span class="si">}</span><span class="s2"> distinct simple cycles in the order book, </span><span class="si">{</span><span class="nb">len</span><span class="p">([</span><span class="n">cycle</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cycle</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cycles</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> of which have positive return.&quot;</span>
<span class="p">)</span>

<span class="c1"># create histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cycles</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">))))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Basis Points&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of Returns for all Simple Cycles&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 203147 distinct simple cycles in the order book, 974 of which have positive return.
</pre></div>
</div>
<img alt="../../_images/84ebc76f8acac6bb9ebd870a9eb7f70e1db739c2d6bd2d3bf50f5f056e2f8429.png" src="../../_images/84ebc76f8acac6bb9ebd870a9eb7f70e1db739c2d6bd2d3bf50f5f056e2f8429.png" />
</div>
</div>
<p>Next, we sort out the negative cycles from this list and present them along with their basis-points (1% is 100 basis points) return.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arbitrage</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">cycle</span> <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cycles</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">cycles</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="p">]</span>

<span class="n">n_cycles_to_list</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top </span><span class="si">{</span><span class="n">n_cycles_to_list</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Basis Points             Arbitrage Cycle&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">arbitrage</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cycles_to_list</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arbitrage</span><span class="p">))]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span><span class="si">:</span><span class="s2">6.3f</span><span class="si">}</span><span class="s2">         </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2"> trades: </span><span class="si">{</span><span class="s1">&#39; --&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 5

Basis Points             Arbitrage Cycle
14.774         8 trades: USDT --&gt; ADA --&gt; BTC --&gt; ETH --&gt; USD --&gt; BUSD --&gt; USDC --&gt; USDT
14.747         8 trades: USDT --&gt; TRX --&gt; BTC --&gt; ETH --&gt; USD --&gt; BUSD --&gt; USDC --&gt; USDT
14.699         7 trades: USDT --&gt; ADA --&gt; BTC --&gt; USD --&gt; BUSD --&gt; USDC --&gt; USDT
14.673         7 trades: USDT --&gt; TRX --&gt; BTC --&gt; USD --&gt; BUSD --&gt; USDC --&gt; USDT
13.772         7 trades: USDT --&gt; ADA --&gt; BTC --&gt; ETH --&gt; USD --&gt; USDC --&gt; USDT
</pre></div>
</div>
</div>
</div>
<p>In the end, we draw an example arbitrage cycle on our graph to illustrate the route that the money must travel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cycles_to_show</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">arbitrage</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cycles_to_show</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arbitrage</span><span class="p">))]:</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Trading cycle with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2"> trades: </span><span class="si">{</span><span class="s1">&#39; --&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Return = </span><span class="si">{</span><span class="n">cycles</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span><span class="si">:</span><span class="s2">6.3f</span><span class="si">}</span><span class="s2"> basis points &quot;</span>
    <span class="p">)</span>
    <span class="c1"># get fresh graph to color nodes</span>
    <span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>

    <span class="c1"># color nodes red</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">:</span>
        <span class="n">order_book_dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>

    <span class="c1"># makes lines wide</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">cycle</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">cycle</span><span class="p">[:</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">draw_dg</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trading cycle with 8 trades: USDT --&gt; ADA --&gt; BTC --&gt; ETH --&gt; USD --&gt; BUSD --&gt; USDC --&gt; USDT
Return = 14.774 basis points 
</pre></div>
</div>
<img alt="../../_images/c3018b18d57bdbfb0d81a1d2b0865cddf1fbdc3546ef55dd637ea008e8ec1e65.png" src="../../_images/c3018b18d57bdbfb0d81a1d2b0865cddf1fbdc3546ef55dd637ea008e8ec1e65.png" />
</div>
</div>
</section>
<section id="pyomo-model-for-arbitrage-with-capacity-constraints">
<h2>Pyomo model for arbitrage with capacity constraints<a class="headerlink" href="#pyomo-model-for-arbitrage-with-capacity-constraints" title="Link to this heading">#</a></h2>
<p>The preceding analysis demonstrates some practical limitations of relying on generic implementations of network algorithms:</p>
<ul class="simple">
<li><p>First, more than one negative cycle may exist, so more than one arbitrage opportunity may exist, i.e. an optimal strategy consists of a combination of cycles.</p></li>
<li><p>Secondly, simply searching for a negative cycle using shortest path algorithms does not account for capacity constraints, i.e., the maximum size of each of the exchanges. For that reason, one may end up with a cycle on which a good `rate’ of arbitrage is available, but where the absolute gain need not be large due to the maximum amounts that can be traded.</p></li>
</ul>
<p>Instead, we can formulate the problem of searching for a maximum-gain arbitrage via linear optimization. Assume that we are given a directed graph where each edge <span class="math notranslate nohighlight">\(i\rightarrow j\)</span> is labeled with a ‘multiplier’ <span class="math notranslate nohighlight">\(a_{i\rightarrow j}\)</span> indicating how many units of currency <span class="math notranslate nohighlight">\(j\)</span> will be received for one unit of currency <span class="math notranslate nohighlight">\(i\)</span>, and a ‘capacity’ <span class="math notranslate nohighlight">\(c_{i\rightarrow j}\)</span> indicating how many units of currency <span class="math notranslate nohighlight">\(i\)</span> can be converted to currency <span class="math notranslate nohighlight">\(j\)</span>.</p>
<p>We break the trading process into steps indexed by <span class="math notranslate nohighlight">\(t = 1, 2, \ldots, T\)</span>, where currencies are exchanged between two adjacent nodes in a single step. We denote by <span class="math notranslate nohighlight">\(x_{i\rightarrow j}(t)\)</span> the amount of currency traded from node <span class="math notranslate nohighlight">\(i\)</span> to <span class="math notranslate nohighlight">\(j\)</span> in step <span class="math notranslate nohighlight">\(t\)</span>. In this way, we start with the amount <span class="math notranslate nohighlight">\(w_{USD}(0)\)</span> at time <span class="math notranslate nohighlight">\(0\)</span> and aim to maximize the amount <span class="math notranslate nohighlight">\(w_{USD}(T)\)</span> at time <span class="math notranslate nohighlight">\(T\)</span>. Denote by <span class="math notranslate nohighlight">\(O_j\)</span> the set of nodes to which outgoing arcs from <span class="math notranslate nohighlight">\(j\)</span> lead, and by <span class="math notranslate nohighlight">\(I_j\)</span> the set of nodes from which incoming arcs lead.</p>
<p>A single transaction converts <span class="math notranslate nohighlight">\(x_{i\rightarrow j}(t)\)</span> units of currency <span class="math notranslate nohighlight">\(i\)</span> to currency <span class="math notranslate nohighlight">\(j\)</span>. Following all transactions at event <span class="math notranslate nohighlight">\(t\)</span>, the trader will hold <span class="math notranslate nohighlight">\(v_j(t)\)</span> units of currency <span class="math notranslate nohighlight">\(j\)</span> where</p>
<div class="math notranslate nohighlight">
\[v_{j}(t) = v_{j}(t-1) + \sum_{i\in I_j} a_{i\rightarrow j}x_{i\rightarrow j}(t) - \sum_{k\in O_j} x_{j\rightarrow k}(t)\]</div>
<p>For every edge <span class="math notranslate nohighlight">\(i\rightarrow j\)</span>, the sum of all transactions must satisfy</p>
<div class="math notranslate nohighlight">
\[\sum_{t=1}^T x_{j\rightarrow k}(t) \leq c_{j\rightarrow k}\]</div>
<p>The objective of the optimization model is to find a sequence of currency transactions that increase the holdings of a reference currency. The solution is constrained by assuming that the trader cannot short sell any currency. The resulting model is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\max \quad &amp; v_{USD}(T) \\
\text{s.t.} \quad &amp; v_{USD}(0) = v_0 \\ 
&amp; v_{j}(t) = v_{j}(t-1) + \sum_{i\in I_j} a_{i\rightarrow j}x_{i\rightarrow j}(t) - \sum_{k\in O_j} x_{j\rightarrow k}(t) &amp; \forall j\in N, t=1, 2, \ldots, T \\
&amp; v_j(t-1) \geq \sum_{k\in O_j} x_{j\rightarrow k}(t) &amp; \forall j\in N, t = 1, 2, \ldots, T  \\
&amp; \sum_{t=1}^T x_{j\rightarrow k}(t) \leq c_{j\rightarrow k} &amp; \forall (j, k) \in E,  t = 1, 2, \ldots, T \\
&amp; v_{j}(t), x_{i\rightarrow j}(t) \geq 0 &amp; \forall t
\end{align*}
\end{split}\]</div>
<p>where the constraints model:</p>
<ul class="simple">
<li><p>the initial amount condition,</p></li>
<li><p>the balance equations linking the state of the given node in the previous and subsequent time periods,</p></li>
<li><p>the fact that we cannot trade at time step <span class="math notranslate nohighlight">\(t\)</span> more of a given currency than we had in this currency from time step <span class="math notranslate nohighlight">\(t - 1\)</span>. This constraint ‘enforces’ the time order of trades, i.e., we cannot trade in time period <span class="math notranslate nohighlight">\(t\)</span> units which have been received in the same time period.</p></li>
<li><p>the maximum allowed trade volumes,</p></li>
<li><p>the non-negativity of the variables.</p></li>
</ul>
<p>The following cell implements this optimization model using Pyomo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">crypto_model</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="mf">100.0</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;Cryptocurrency arbitrage&quot;</span><span class="p">)</span>

    <span class="c1"># length of the trading chain</span>
    <span class="n">m</span><span class="o">.</span><span class="n">T0</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">RangeSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">RangeSet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

    <span class="c1"># currency nodes and trading edges</span>
    <span class="n">m</span><span class="o">.</span><span class="n">NODES</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">order_book_dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">))</span>

    <span class="c1"># currency on hand at each node</span>
    <span class="n">m</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># amount traded on each edge at each trade</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># total amount traded on each edge over all trades</span>
    <span class="n">m</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># &quot;multiplier&quot; on each trading edge</span>
    <span class="nd">@m</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;capacity&quot;</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wealth</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_traded</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">])</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">edge_capacity</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span>

    <span class="c1"># initial assignment of v0 units on a selected currency</span>
    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initial</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">no_shorting</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">out_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">dst</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">out_nodes</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">balances</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">in_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="k">if</span> <span class="n">dst</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
        <span class="n">out_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">dst</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span> <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">node</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">in_nodes</span>
        <span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">out_nodes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<p>Using this function, we are able to compute the optimal (absolute) return from an order book while respecting the order capacities and optimally using all the arbitrage opportunities inside it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mf">10000.0</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">crypto_model</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>
<span class="n">SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">vT</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">wealth</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting wealth = </span><span class="si">{</span><span class="n">v0</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> USD&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weath after </span><span class="si">{</span><span class="n">T</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2"> transactions = </span><span class="si">{</span><span class="n">vT</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> USD&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return = </span><span class="si">{</span><span class="mi">10000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">vT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v0</span><span class="p">)</span><span class="o">/</span><span class="n">v0</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> basis points&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting wealth = 10000.00 USD
Weath after  8 transactions = 10009.01 USD
Return = 9.006 basis points
</pre></div>
</div>
</div>
</div>
<p>To track the evolution of the trades throughout time, the script in the following cell illustrates, for each currency (rows) the amount of money held in that currency at each of the time steps <span class="math notranslate nohighlight">\(t = 0, \dots, 8\)</span>. It is visible from this scheme that the sequence of trades is not a simple cycle, but rather a more sophisticated sequence of trades which we would not have discovered with simple-cycle exploration alone, especially not when considering also the arc capacities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">NODES</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="si">:</span><span class="s2">5s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">]()</span><span class="si">:</span><span class="s2">11.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ETH       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
BTC       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00004     0.00000
BNB       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
ADA       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     2.00000     0.00000     0.00000
SOL       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
MATIC     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
MANA      0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
TRX       0.00000     0.00000    -0.00000    -0.00000     0.00000     0.00000     4.00000    -0.00000     0.00000
USDT      0.00000  4953.27900  5046.73030     0.00000  4955.75660  5049.25470     0.00000  4958.23550     0.00000
BUSD      0.00000    -0.00000  4955.26110  5048.74980     0.00000  4957.73970  5050.30000     0.00000     0.00000
USDC      0.00000  5046.22570     0.00000  4955.26110  5048.74980     0.00000  4957.73970  5050.30000     0.00000
DAI       0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000     0.00000
USD   10000.00000    -0.00000     0.00000     0.00000     0.00000    -0.00000     0.00000     0.00000 10009.00600
</pre></div>
</div>
</div>
</div>
<p>To be even more specific, the following cell lists the sequence of transcations executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transaction Events&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">src</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">:</span><span class="s2">8s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">]()</span><span class="si">:</span><span class="s2">14.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">]()</span><span class="si">:</span><span class="s2">14.6f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Transaction Events
t = 1
 USD      -&gt; USDT    :    4953.774300    4953.278972
 USD      -&gt; USDC    :    5046.225700    5046.225700

t = 2
 USDT     -&gt; BUSD    :    4953.279000    4955.261104
 USDC     -&gt; USDT    :    5046.225700    5046.730323

t = 3
 USDT     -&gt; BUSD    :    5046.730300    5048.749800
 BUSD     -&gt; USDC    :    4955.261100    4955.261100

t = 4
 BUSD     -&gt; USDC    :    5048.749800    5048.749800
 USDC     -&gt; USDT    :    4955.261100    4955.756626

t = 5
 USDT     -&gt; BUSD    :    4955.756600    4957.739696
 USDC     -&gt; USDT    :    5048.749800    5049.254675

t = 6
 USDT     -&gt; ADA     :       0.697500       2.000000
 USDT     -&gt; BUSD    :    5048.279900    5050.300020
 USDT     -&gt; TRX     :       0.277320       4.000000
 BUSD     -&gt; USDC    :    4957.739700    4957.739700

t = 7
 ADA      -&gt; BTC     :       2.000000       0.000030
 TRX      -&gt; BTC     :       4.000000       0.000012
 BUSD     -&gt; USDC    :    5050.300000    5050.300000
 USDC     -&gt; USDT    :    4957.739700    4958.235474

t = 8
 BTC      -&gt; USD     :       0.000042       0.976057
 USDT     -&gt; USD     :    4958.235500    4958.235500
 USDC     -&gt; USD     :    5050.300000    5049.794970
</pre></div>
</div>
</div>
</div>
<p>We next illustrate the arbitrage strategy in the graph by marking all the corresponding arcs thicker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for each currency we took only one ask and one bid, this is why we are unique between each pair of nodes</span>

<span class="c1"># report what orders to issue</span>
<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">0.0000002</span><span class="p">:</span>
        <span class="n">order_book_dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="n">order_book_dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">dst</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="n">order_book_dg</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">dst</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">draw_dg</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8fe7be5a2fedb472960cc6e8d5a6e7ebef36528ae6ed33a3aa505374e9875be3.png" src="../../_images/8fe7be5a2fedb472960cc6e8d5a6e7ebef36528ae6ed33a3aa505374e9875be3.png" />
</div>
</div>
<p>If we want to be even more precise about the execution of the trading strategy, we can formulate a printout of the list of orders that we, as the counter party to the orders stated in the order book, should issue for our strategy to take place.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># report what orders to issue</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trading Summary for the Order Book&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Order Book   Type    Capacity         Traded&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">EDGES</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">0.0000002</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">:</span><span class="s2">&gt;5s</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dst</span><span class="si">:</span><span class="s2">&lt;5s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">]</span><span class="si">:</span><span class="s2">12.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">]()</span><span class="si">:</span><span class="s2">14.5f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  &gt;&gt;&gt;  &quot;</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;ask&quot;</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">dst</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="n">src</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">quote</span>
            <span class="n">price</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span> <span class="o">/</span> <span class="n">price</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;sell </span><span class="si">{</span><span class="n">volume</span><span class="si">:</span><span class="s2">15.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s2">11s</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;bid&quot;</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">src</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="n">dst</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">quote</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">order_book_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;buy </span><span class="si">{</span><span class="n">volume</span><span class="si">:</span><span class="s2">16.6f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s2">11s</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">12.6f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trading Summary for the Order Book
  Order Book   Type    Capacity         Traded
  BTC -&gt; USD   bid      0.00746        0.00004  &gt;&gt;&gt;  buy         0.000042 BTC/USD     at 23373.010000
  ADA -&gt; BTC   bid      2.00000        2.00000  &gt;&gt;&gt;  buy         2.000000 ADA/BTC     at     0.000015
  TRX -&gt; BTC   bid      4.00000        4.00000  &gt;&gt;&gt;  buy         4.000000 TRX/BTC     at     0.000003
 USDT -&gt; ADA   ask    178.28100        0.69750  &gt;&gt;&gt;  sell        2.000000 ADA/USDT    at     0.348750
 USDT -&gt; BUSD  ask 317048.85971    20004.04600  &gt;&gt;&gt;  sell    20012.050820 BUSD/USDT   at     0.999600
 USDT -&gt; TRX   ask    750.05354        0.27732  &gt;&gt;&gt;  sell        4.000000 TRX/USDT    at     0.069330
 USDT -&gt; USD   bid  10407.87000     4958.23550  &gt;&gt;&gt;  buy      4958.235500 USDT/USD    at     1.000000
 BUSD -&gt; USDC  ask 279879.62000    20012.05100  &gt;&gt;&gt;  sell    20012.051000 USDC/BUSD   at     1.000000
 USDC -&gt; USDT  bid 307657.00000    20007.97600  &gt;&gt;&gt;  buy     20007.976000 USDC/USDT   at     1.000100
 USDC -&gt; USD   bid   5050.30000     5050.30000  &gt;&gt;&gt;  buy      5050.300000 USDC/USD    at     0.999900
  USD -&gt; USDT  ask 954935.16397     4953.77430  &gt;&gt;&gt;  sell     4953.278972 USDT/USD    at     1.000100
  USD -&gt; USDC  ask 517682.17000     5046.22570  &gt;&gt;&gt;  sell     5046.225700 USDC/USD    at     1.000000
</pre></div>
</div>
</div>
</div>
<p>In the end, we can illustrate the time-journey of our balances in different currencies using time-indexed bar charts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display currency balances</span>
<span class="n">balances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">order_book_dg</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0000002</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">T0</span><span class="p">:</span>
            <span class="n">balances</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">]()</span>

<span class="n">balances</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Transaction&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Currency Units&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/06eb2ef896260feb73fe97d3f472b664ef63288789733cb5e3331e8ddaefce6a.png" src="../../_images/06eb2ef896260feb73fe97d3f472b664ef63288789733cb5e3331e8ddaefce6a.png" />
</div>
</div>
</section>
<section id="exercises-for-the-reader">
<h2>Exercises for the reader<a class="headerlink" href="#exercises-for-the-reader" title="Link to this heading">#</a></h2>
<p>The previous notebook cells made certain assumptions that we need to consider. The first assumption was that there was at most one bid and one ask order between any pair of currencies in an exchange. This assumption was based on the number of orders we downloaded from the online database, but in reality, there may be more orders. How would the presence of multiple orders per pair affect our graph formulation? How can we adjust the MILO formulation to account for this?</p>
<p>Another assumption was that we only traded currencies within one exchange. However, in reality, we can trade across multiple exchanges. How can we modify the graph-based problem formulation to accommodate this scenario?</p>
<p>Further, we have assigned no cost to the number of trades required to implement the strategy produced by optimization. How can the modeled be modified to either minimize the number of trades, or to explicitly include trading costs?</p>
<p>Finally, a tool like this needs to operate in real time. How can this model be incorporated into, say, a <a class="reference external" href="https://streamlit.io/">streamlit</a> application that could be used to monitor for arbitrage opportunities in real time?</p>
</section>
<section id="real-time-downloads-of-order-books-from-an-exchange">
<h2>Real Time Downloads of Order Books from an Exchange<a class="headerlink" href="#real-time-downloads-of-order-books-from-an-exchange" title="Link to this heading">#</a></h2>
<p>The goal of this notebook was to show how network algorithms and optimization can be utilized to detect arbitrage opportunities within an order book that has been obtained from a cryptocurrency exchange.</p>
<p>The subsequent cell in the notebook utilizes <code class="docutils literal notranslate"><span class="pre">ccxt.exchange.fetch_order_book</span></code> to obtain the highest bid and lowest ask orders from an exchange for market symbols that meet the criteria of having a minimum in-degree for their base currencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">exchange_dg</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_orders</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">]),</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;asks&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bids&quot;</span><span class="p">]:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;quote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="p">,</span> <span class="n">quote</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">milliseconds</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bid_price&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bid_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ask_price&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ask_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;asks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># fetch order book data and store in a dictionary</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">[</span><span class="n">get_orders</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">)</span> <span class="k">for</span> <span class="n">quote</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">exchange_dg</span><span class="o">.</span><span class="n">edges</span><span class="p">()],</span>
    <span class="p">)</span>

    <span class="c1"># convert to pandas dataframe</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
    <span class="n">order_book</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">order_book</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">order_book</span><span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;base&quot;</span><span class="p">,</span>
            <span class="s2">&quot;quote&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bid_price&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bid_volume&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ask_price&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ask_volume&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span>


<span class="n">minimum_in_degree</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># get graph of market symbols with mininum_in_degree for base currencies</span>
<span class="n">exchange_dg</span> <span class="o">=</span> <span class="n">get_exchange_dg</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">minimum_in_degree</span><span class="p">)</span>

<span class="c1"># get order book for all markets in the graph</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="n">get_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">exchange_dg</span><span class="p">)</span>
<span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>

<span class="c1"># find trades</span>
<span class="n">v0</span> <span class="o">=</span> <span class="mf">10000.0</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">crypto_model</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">v0</span><span class="p">)</span>
<span class="n">vT</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">wealth</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential Return = </span><span class="si">{</span><span class="mi">10000</span><span class="o">*</span><span class="p">(</span><span class="n">vT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v0</span><span class="p">)</span><span class="o">/</span><span class="n">v0</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> basis points&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Potential Return = 0.000 basis points
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>symbol</th>
      <th>timestamp</th>
      <th>base</th>
      <th>quote</th>
      <th>bid_price</th>
      <th>bid_volume</th>
      <th>ask_price</th>
      <th>ask_volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ETH/BTC</td>
      <td>2023-10-26 10:28:07.688</td>
      <td>ETH</td>
      <td>BTC</td>
      <td>0.0534</td>
      <td>1.00000</td>
      <td>0.0535</td>
      <td>1.01680</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BTC/USDT</td>
      <td>2023-10-26 10:28:07.785</td>
      <td>BTC</td>
      <td>USDT</td>
      <td>34422.5300</td>
      <td>0.04934</td>
      <td>34450.7000</td>
      <td>0.00128</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ETH/USDT</td>
      <td>2023-10-26 10:28:08.017</td>
      <td>ETH</td>
      <td>USDT</td>
      <td>1840.2700</td>
      <td>1.07030</td>
      <td>1841.6900</td>
      <td>2.09630</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BAT/USDT</td>
      <td>2023-10-26 10:28:08.118</td>
      <td>BAT</td>
      <td>USDT</td>
      <td>0.2032</td>
      <td>659.00000</td>
      <td>0.2044</td>
      <td>804.00000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ETC/USDT</td>
      <td>2023-10-26 10:28:08.213</td>
      <td>ETC</td>
      <td>USDT</td>
      <td>16.5500</td>
      <td>6.27000</td>
      <td>16.8500</td>
      <td>0.10000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>143</th>
      <td>BTC/USDC</td>
      <td>2023-10-26 10:28:29.614</td>
      <td>BTC</td>
      <td>USDC</td>
      <td>34358.6800</td>
      <td>0.00504</td>
      <td>34467.3700</td>
      <td>0.00290</td>
    </tr>
    <tr>
      <th>144</th>
      <td>ETH/USDC</td>
      <td>2023-10-26 10:28:29.712</td>
      <td>ETH</td>
      <td>USDC</td>
      <td>1834.3500</td>
      <td>1.11010</td>
      <td>1862.0600</td>
      <td>0.21520</td>
    </tr>
    <tr>
      <th>145</th>
      <td>BTC/DAI</td>
      <td>2023-10-26 10:28:29.828</td>
      <td>BTC</td>
      <td>DAI</td>
      <td>33763.7400</td>
      <td>0.00030</td>
      <td>35062.9500</td>
      <td>0.00030</td>
    </tr>
    <tr>
      <th>146</th>
      <td>ETH/DAI</td>
      <td>2023-10-26 10:28:30.036</td>
      <td>ETH</td>
      <td>DAI</td>
      <td>1635.0100</td>
      <td>0.02700</td>
      <td>1872.4900</td>
      <td>0.00120</td>
    </tr>
    <tr>
      <th>147</th>
      <td>USDT/USD</td>
      <td>2023-10-26 10:28:30.430</td>
      <td>USDT</td>
      <td>USD</td>
      <td>1.0000</td>
      <td>4030.00000</td>
      <td>1.0006</td>
      <td>620.00000</td>
    </tr>
  </tbody>
</table>
<p>148 rows × 8 columns</p>
</div></div></div>
</div>
<p>The following cell can be used to download additional order book data sets for testing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># get graph of market symbols with mininum_in_degree for base currencies</span>
<span class="n">minimum_in_degree</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">exchange_dg</span> <span class="o">=</span> <span class="n">get_exchange_dg</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">minimum_in_degree</span><span class="p">)</span>

<span class="c1"># search time</span>
<span class="n">search_time</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">search_time</span>

<span class="c1"># threshold in basis points</span>
<span class="n">arb_threshold</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># wait for arbitrage opportunity</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search for </span><span class="si">{</span><span class="n">search_time</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">timeout</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basis points = &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">order_book</span> <span class="o">=</span> <span class="n">get_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">exchange_dg</span><span class="p">)</span>
    <span class="n">order_book_dg</span> <span class="o">=</span> <span class="n">order_book_to_dg</span><span class="p">(</span><span class="n">order_book</span><span class="p">)</span>

    <span class="n">v0</span> <span class="o">=</span> <span class="mf">10000.0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">crypto_model</span><span class="p">(</span><span class="n">order_book_dg</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    <span class="n">vT</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">wealth</span><span class="p">()</span>
    <span class="n">bp</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">vT</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span> <span class="o">/</span> <span class="n">vT</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bp</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bp</span> <span class="o">&gt;=</span> <span class="n">arb_threshold</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;arbitrage found!&quot;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s2"> orderbook </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span>
        <span class="p">)</span>
        <span class="n">order_book</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;order book saved to: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Search complete.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Search for 20 seconds.
Basis points = 0.149
Search complete.
</pre></div>
</div>
</div>
</div>
</section>
<section id="bibliographic-notes">
<h2>Bibliographic Notes<a class="headerlink" href="#bibliographic-notes" title="Link to this heading">#</a></h2>
<p>Crytocurrency markets are relatively new compared to other markets, and relatively few academic papers are available that specifically address arbitrage on those markets. Early studies, such as the following, reported periods of large, recurrent arbitrage opportunities that exist across exchanges, and that can persist for several days or weeks.</p>
<blockquote>
<div><p>Makarov, I., &amp; Schoar, A. (2020). Trading and arbitrage in cryptocurrency markets. Journal of Financial Economics, 135(2), 293-319.</p>
</div></blockquote>
<p>Subsequent work reports these prices differentials do exist, but only at a fraction of the values previously reported, and only for fleeting periods of time.</p>
<blockquote>
<div><p>Crépellière, T., &amp; Zeisberger, S. (2020). Arbitrage in the Market for Cryptocurrencies. Available at SSRN 3606053.  <a class="reference external" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3606053">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3606053</a></p>
</div></blockquote>
<p>The use of network algorithms to identify cross-exchange arbitrage has appeared in the academic literature, and in numerous web sites demonstrating optimization and network applications. Representative examples are cited below.</p>
<blockquote>
<div><p>Peduzzi, G., James, J., &amp; Xu, J. (2021, September). JACK THE RIPPLER: Arbitrage on the Decentralized Exchange of the XRP Ledger. In 2021 3rd Conference on Blockchain Research &amp; Applications for Innovative Networks and Services (BRAINS) (pp. 1-2). IEEE. <a class="reference external" href="https://arxiv.org/pdf/2106.16158.pdf">https://arxiv.org/pdf/2106.16158.pdf</a></p>
</div></blockquote>
<blockquote>
<div><p>Bruzgė, R., &amp; Šapkauskienė, A. (2022). Network analysis on Bitcoin arbitrage opportunities. The North American Journal of Economics and Finance, 59, 101562. <a class="reference external" href="https://doi.org/10.1016/j.najef.2021.101562">https://doi.org/10.1016/j.najef.2021.101562</a></p>
</div></blockquote>
<blockquote>
<div><p>Bruzgė, R., &amp; Šapkauskienė, A. (2022). Dataset for Bitcoin arbitrage in different cryptocurrency exchanges. Data in Brief, 40, 107731.</p>
</div></blockquote>
<p>The work in this notebook is related to materials found in the following web resources.</p>
<blockquote>
<div><p><a class="reference external" href="https://anilpai.medium.com/currency-arbitrage-using-bellman-ford-algorithm-8938dcea56ea">https://anilpai.medium.com/currency-arbitrage-using-bellman-ford-algorithm-8938dcea56ea</a></p>
</div></blockquote>
<blockquote>
<div><p><a class="reference external" href="https://nbviewer.org/github/rcroessmann/sharing_public/blob/master/arbitrage_identification.ipynb">Crypto Trading and Arbitrage Identification Strategies</a></p>
</div></blockquote>
<p>A more complete analysis of trading and exploiting arbitrage opportunities in decentralized finance markets is available in the following paper and thesis.</p>
<blockquote>
<div><p>Byrne, S. An Exploration of Novel Trading and Arbitrage Methods within Decentralised Finance. <a class="reference external" href="https://www.scss.tcd.ie/Donal.OMahony/bfg/202021/StephenByrneDissertation.pdf">https://www.scss.tcd.ie/Donal.OMahony/bfg/202021/StephenByrneDissertation.pdf</a></p>
</div></blockquote>
<blockquote>
<div><p>Levus, R., Berko, A., Chyrun, L., Panasyuk, V., &amp; Hrubel, M. (2021). Intelligent System for Arbitrage Situations Searching in the Cryptocurrency Market. In CEUR Workshop Proceedings (pp. 407-440). <a class="reference external" href="http://ceur-ws.org/Vol-2917/paper32.pdf">http://ceur-ws.org/Vol-2917/paper32.pdf</a></p>
</div></blockquote>
<p>In addition to the analysis of arbitrage opportunities, convex optimization may also have an important role in the developing of trading algorithms for crypocurrency exchanges.</p>
<blockquote>
<div><p>Angeris, G., Agrawal, A., Evans, A., Chitra, T., &amp; Boyd, S. (2021). Constant function market makers: Multi-asset trades via convex optimization. arXiv preprint arXiv:2107.12484. <a class="reference external" href="https://baincapitalcrypto.com/constant-function-market-makers-multi-asset-trades-via-convex-optimization/">https://baincapitalcrypto.com/constant-function-market-makers-multi-asset-trades-via-convex-optimization/</a> and <a class="reference external" href="https://arxiv.org/pdf/2107.12484.pdf">https://arxiv.org/pdf/2107.12484.pdf</a></p>
</div></blockquote>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/04"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="04-exam-room-scheduling.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">4.4 Exam room scheduling</p>
      </div>
    </a>
    <a class="right-next"
       href="06-power-network.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Extra material: Energy dispatch problem</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installations-and-imports">Installations and Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble-install-pyomo-and-a-solver">Preamble: Install Pyomo and a solver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-description">Problem description</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-libraries-needed-networkx-and-ccxt">Additional libraries needed: NetworkX and CCXT</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-cryptocurrency-exchanges">Available cryptocurrency exchanges</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-an-exchange-as-a-directed-graph">Representing an exchange as a directed graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exchange-order-book">Exchange order book</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelling-the-arbitrage-search-problem-as-a-graph">Modelling the arbitrage search problem as a graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trading-and-arbitrage">Trading and arbitrage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-order-books-that-have-arbitrage-opportunities">Find order books that have arbitrage opportunities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#brute-force-search-arbitrage-with-simple-cycles">Brute force search arbitrage with simple cycles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pyomo-model-for-arbitrage-with-capacity-constraints">Pyomo model for arbitrage with capacity constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-for-the-reader">Exercises for the reader</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-time-downloads-of-order-books-from-an-exchange">Real Time Downloads of Order Books from an Exchange</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliographic-notes">Bibliographic Notes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The MO Book Group
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>