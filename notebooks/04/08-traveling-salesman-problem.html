
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Extra material: Traveling Salesman Problem &#8212; Companion code for the book &#34;Hands-On Mathematical Optimization with Python&#34;</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-DVQ7NZ8CYZ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DVQ7NZ8CYZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DVQ7NZ8CYZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/04/08-traveling-salesman-problem';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Extra material: Shortest path problem in real life" href="09-shortest-path-road-networks.html" />
    <link rel="prev" title="Extra material: Forex Arbitrage" href="07-forex-arbitrage.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cover.jpg" class="logo__image only-light" alt="Companion code for the book "Hands-On Mathematical Optimization with Python" - Home"/>
    <script>document.write(`<img src="../../_static/cover.jpg" class="logo__image only-dark" alt="Companion code for the book "Hands-On Mathematical Optimization with Python" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Hands-On Mathematical Optimization with Python
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/01.00.html">1. Mathematical Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/01-production-planning.html">1.1 A first production planning problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/02-production-planning-basic.html">1.2 A basic Pyomo model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/03-production-planning-advanced.html">1.3 A data-driven Pyomo Model</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/02.00.html">2. Linear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/01-bim.html">2.1 BIM production planning using linear optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/02-lad-regression.html">2.2 Least Absolute Deviation (LAD) Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/03-mad-portfolio-optimization.html">2.3 Mean Absolute Deviation (MAD) portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/04-bim-maxmin.html">2.4 BIM production for worst case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/05-bim-fractional.html">2.5 BIM production variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/06-bim-dual.html">2.6 Dual of the BIM production problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/07-bim-demand-forecast.html">2.7 BIM production using demand forecasts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/08-L1-regression-wine-quality.html">Extra material: Wine quality prediction with <span class="math notranslate nohighlight">\(L_1\)</span> regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/09-production-facility-worst-case.html">Extra material: Multi-product facility production</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../03/03.00.html">3. Mixed Integer Linear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03/01-bim-perturbed.html">3.1 BIM production with perturbed data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/02-shift-scheduling.html">3.2 Workforce shift scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/03-recharging-electric-vehicle.html">3.3 Recharging strategy for an electric vehicle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/04-simple-production-model-gdp.html">3.4 Production model using disjunctions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/05-machine-scheduling.html">3.5 Machine Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/06-facility-location.html">3.6 Facility location problem</a></li>


<li class="toctree-l2"><a class="reference internal" href="../03/07-bim-production-revisited.html">3.7 BIM production revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/08-cryptarithms.html">Extra material: Cryptarithms puzzle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/09-strip-packing.html">Extra material: Strip packing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/10-job-shop-scheduling.html">Extra material: Job shop scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/11-maintenance-planning.html">Extra material: Maintenance planning</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="04.00.html">4. Network Optimization</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01-dinner-seat-allocation.html">4.1 Dinner seating arrangement</a></li>

<li class="toctree-l2"><a class="reference internal" href="02-mincost-flow.html">4.2 Minimum-Cost Flow Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-gasoline-distribution.html">4.3 Gasoline distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-exam-room-scheduling.html">4.4 Exam room scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-cryptocurrency-arbitrage.html">4.5 Cryptocurrency arbitrage search</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-power-network.html">Extra material: Energy dispatch problem</a></li>



<li class="toctree-l2"><a class="reference internal" href="07-forex-arbitrage.html">Extra material: Forex Arbitrage</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Extra material: Traveling Salesman Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-shortest-path-road-networks.html">Extra material: Shortest path problem in real life</a></li>


</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../05/05.00.html">5. Convex Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../05/01-milk-pooling.html">5.1 Milk pooling and blending</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/02-ols-regression.html">5.2 Ordinary Least Squares (OLS) Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/03-markowitz-portfolio.html">5.3 Markowitz portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/04-svm-binary-classification.html">5.4 Support Vector Machines for binary classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/05-refinery-production.html">Extra material: Refinery production and shadow pricing with CVXPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05/06-cutting-stock.html">Extra Material: Cutting Stock</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../06/06.00.html">6. Conic Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06/01-economic-order-quantity.html">6.1 Economic Order Quantity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/02-kelly-criterion.html">6.2 The Kelly criterion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/03-markowitz-portfolio-revisited.html">6.3 Markowitz portfolio optimization revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/04-building-insulation.html">6.4 Optimal Design of Multilayered Building Insulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/05-svm-conic.html">Extra material: Support Vector Machines with conic optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/06-investment-wheel.html">Extra material: Luenberger’s Investment Wheel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/07-optimal-growth-portfolios.html">Extra material: Optimal Growth Portfolios with Risk Aversion</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../07/07.00.html">7. Accounting for Uncertainty: Optimization Meets Reality</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07/01-fleet-assignment.html">7.1 Fleet assignment problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/02-bim-robustness-analysis.html">7.2 Robustness analysis of BIM production plan via simulations</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../08/08.00.html">8. Robust Optimization - Single Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08/01-bim-robust-optimization.html">8.1 Robust BIM microchip production problem</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../09/09.00.html">9. Stochastic Optimization - Single Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09/01-markowitz-portfolio-with-chance-constraint.html">9.1 Markowitz portfolio optimization with chance constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/02-pop-up-shop.html">9.2 Pop-up shop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/03-seafood-distribution-center.html">9.3 Stock optimization for seafood distribution center</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/04-economic-dispatch.html">9.4 Economic dispatch in renewable energy systems using chance constraints</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../10/10.00.html">10. Two-Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../10/01-aircraft-seat-allocation.html">10.1 Aircraft seat allocation problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/02-two-stage-production-planning.html">10.2 Two-stage production planning using constraint and column generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/03-opf-linear-decision-rule.html">10.3 Optimal power flow problem with recourse actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/04-farmer-problem.html">Extra: The farmer’s problem and its variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/05-opf-wind-curtailment.html">Extra: Two-stage energy dispatch optimization with wind curtailment</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../appendix/appendix.html">Appendix: Working with Pyomo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../appendix/pyomo-style-guide.html">Pyomo style guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../appendix/functional-programming-pyomo.html">Functional Programming with Pyomo</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/mobook/MO-book/blob/main/notebooks/04/08-traveling-salesman-problem.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mobook/MO-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mobook/MO-book/issues/new?title=Issue%20on%20page%20%2Fnotebooks/04/08-traveling-salesman-problem.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/04/08-traveling-salesman-problem.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Extra material: Traveling Salesman Problem</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solvers-and-utilities">Solvers and utilities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-format">Data format</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-handle-instances-and-solutions">Functions to handle instances and solutions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-impressions">First impressions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-models">The models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-blocks-for-tsp-models">Building blocks for TSP models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-solutions">Examining solutions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiments">Experiments</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-the-strength-of-the-mtz-models-differ">How does the strength of the MTZ models differ?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-models">Exploring the models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tale-of-two-models">A tale of two models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wait-we-can-solve-dfj-after-all">Wait, we <em>can</em> solve DFJ after all!</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetry">Symmetry</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#revisiting-the-implementation-lazy-constraint-generation">Revisiting the implementation: lazy constraint generation!</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#callbacks">Callbacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gray-area">Gray area</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#famous-benchmark-instances-from-the-internet">Famous benchmark instances from the Internet</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beyond-this">Beyond this?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variants">Variants</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#open-tsp">Open TSP</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-tsp">Multiple TSP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#portability">Portability</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#larger-models">Larger models?</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="extra-material-traveling-salesman-problem">
<span id="index-1"></span><span id="index-0"></span><h1>Extra material: Traveling Salesman Problem<a class="headerlink" href="#extra-material-traveling-salesman-problem" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This notebook can be seen as an addition to both Chapter 3 (since it concerns mixed integer models, and analyses differences in strength) and to Chapter 4 (since it addresses a network optimization problem).</p>
<p>In this notebook we illustrate several things:</p>
<ol class="arabic simple">
<li><p>That different <strong>correct</strong> models for the same (mixed) integer optimization problem may require substantially different effort to optimize.</p></li>
<li><p>That different models can be combined, and why that may become interesting.</p></li>
<li><p>That very large models can be specified ‘on a need basis’ by adding only the constraints that are needed for a specific instance.</p></li>
<li><p>That exploiting knowledge about the instance (e.g. symmetry of the cost function) may dramatically reduce optimization effort.</p></li>
</ol>
<p>First, we will deal with how to even formulate this problem, to which there are multiple answers.
Next, we shall solve each of the equivalent formulations with a solver and compare the solutions/solution times.
Note that an important formulation requires an exponential number of constraints, rendering it impractical to explicitly implement.
In the end, we will delve on how classic optimization techniques can be used to attack this problem in a way that is scalable.</p>
<p>This notebook focuses on the <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem">Traveling Salesman Problem</a> which may be the most studied (combinatorial) optimization problem.</p>
<p>A wonderful <a class="reference external" href="https://www.math.uwaterloo.ca/tsp/">source</a> you may like to visit is maintained by <a class="reference external" href="https://www.math.uwaterloo.ca/~bico/">Prof. Bill Cook</a>.
You may consider reading this enlightening and exciting <a class="reference external" href="https://press.princeton.edu/books/paperback/9780691163529/in-pursuit-of-the-traveling-salesman">book on the pursuit</a>.</p>
<p>The main challenge when modelling the TSP is the <em>connectivity</em> of the solution.</p>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem">Wikipedia page</a> lists two well-known models, the <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Miller%E2%80%93Tucker%E2%80%93Zemlin_formulation%5B21%5D">Miller–Tucker–Zemlin</a> and the <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Dantzig%E2%80%93Fulkerson%E2%80%93Johnson_formulation">Dantzig–Fulkerson–Johnson</a>.</p>
<p>These are not the only TSP models, see <a class="reference external" href="https://co-enzyme.fr/blog/spanning-tree-flow-based-formulations-for-the-asymmetric-traveling-Salesman-problem-tsp/">this</a> or <a class="reference external" href="https://dm872.github.io/assets/dm872-TSP_Formulations.pdf">this</a> overviews.
A thorough <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S2192437620600115">comparison</a> is also available.</p>
<p>Besides the practical computation difficulties, different formulations also have different merits as basis to model different business requirements.
A good example is this <a class="reference external" href="https://onlinelibrary.wiley.com/doi/full/10.1002/net.21962">very rich routing problem</a> for which the computational impact of different model choices for the TSP parts of it has also been <a class="reference external" href="https://www.ubvu.vu.nl/scripties/getpdf.cfm?facid=27&amp;amp;id=21392">studied</a>.</p>
<p>As said, we focus on the <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Miller%E2%80%93Tucker%E2%80%93Zemlin_formulation%5B21%5D">MTZ</a> and the <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Dantzig%E2%80%93Fulkerson%E2%80%93Johnson_formulation">DFJ</a> models.</p>
<p>A first inspection to these models may invite you to choose the former and abandon any consideration of the latter, on the grounds of compactness: the <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Miller%E2%80%93Tucker%E2%80%93Zemlin_formulation%5B21%5D">MTZ</a> model consists of a polynomial number of variables and constraints, while the <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Dantzig%E2%80%93Fulkerson%E2%80%93Johnson_formulation">DFJ</a> model requires an exponential number of constraints.</p>
<p>In the case of the TSP, as this notebook shows, the strength of models is of paramount importance when we need to actually solve the problem.</p>
<p>In the end, compactness may <em><strong>not</strong></em> be all what matters!</p>
<section id="preamble">
<h3>Preamble<a class="headerlink" href="#preamble" title="Link to this heading">#</a></h3>
<p>Let us start importing the modules that we will need.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">%</span><span class="k">pip</span> install pyomo &gt;/dev/null 2&gt;/dev/null
    <span class="o">%</span><span class="k">pip</span> install highspy &gt;/dev/null 2&gt;/dev/null
    <span class="o">%</span><span class="k">pip</span> install gurobipy &gt;/dev/null 2&gt;/dev/null
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">os.path</span><span class="o">,</span><span class="w"> </span><span class="nn">string</span><span class="o">,</span><span class="w"> </span><span class="nn">re</span><span class="o">,</span><span class="w"> </span><span class="nn">requests</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span><span class="o">,</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">it</span><span class="o">,</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span><span class="o">,</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">perf_counter</span> <span class="k">as</span> <span class="n">pc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">distance_matrix</span> <span class="k">as</span> <span class="n">euclidean</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solvers-and-utilities">
<h3>Solvers and utilities<a class="headerlink" href="#solvers-and-utilities" title="Link to this heading">#</a></h3>
<p>We will illustrate the differences between free and commercial solvers, and also the advantages of having the ability of modifying a model while solving with a persistent solver.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">free_solver</span> <span class="o">=</span> <span class="s2">&quot;appsi_highs&quot;</span>
<span class="n">persistent_solver</span> <span class="o">=</span> <span class="s2">&quot;gurobi_persistent&quot;</span>

<span class="n">SOLVER</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">free_solver</span><span class="p">)</span>
<span class="n">PERSISTENT_SOLVER</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">persistent_solver</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">SOLVER</span><span class="o">.</span><span class="n">available</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Solver </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> is not available.&quot;</span>
<span class="k">assert</span> <span class="n">PERSISTENT_SOLVER</span><span class="o">.</span><span class="n">available</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Solver </span><span class="si">{</span><span class="n">persistent_solver</span><span class="si">}</span><span class="s2"> is not available.&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>A transformation to obtain the linear relaxation of a given model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linear_relaxation</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TransformationFactory</span><span class="p">(</span><span class="s2">&quot;core.relax_integer_vars&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A simple function to display an elapsed number of seconds as a digital clock.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_seconds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sec</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">sec</span><span class="p">))[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-format">
<h3>Data format<a class="headerlink" href="#data-format" title="Link to this heading">#</a></h3>
<p>Since the TSP is very well-known and widely studied, there exists a <a class="reference external" href="http://comopt.ifi.uni-heidelberg.de/software/TSPLIB95/tsp95.pdf">de-facto standard</a> for the data format of its instances.</p>
<p>This is important due to the richness of widely studied benchmark instances.
Later down this notebook we will read such instances from the internet, we start generating random instances of convenient sizes and introduce some convenience functions to deal with their representation in <code class="docutils literal notranslate"><span class="pre">python</span></code> data structures.</p>
<p>The most important part of the data is for now the <code class="docutils literal notranslate"><span class="pre">NODE_COORD_SECTION</span></code> which we model as a list of triplets: <code class="docutils literal notranslate"><span class="pre">(index,x,y)</span></code>.</p>
<p>We limit us to the rounded integer values of the <code class="docutils literal notranslate"><span class="pre">EUC_2D</span></code> option for <code class="docutils literal notranslate"><span class="pre">EDGE_WEIGHT_TYPE</span></code> as described in <a class="reference external" href="http://comopt.ifi.uni-heidelberg.de/software/TSPLIB95/tsp95.pdf">TSPLIB95</a> for the lengths of the route segments.</p>
<p>Later we will read instances in that format from the internet.
Now we generate instances of convenient sizes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_tsp</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2023</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a Traveling Salesman Problem (TSP) instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        n (int, optional): Number of nodes. Defaults to 10.</span>
<span class="sd">        seed (int, optional): Seed for random number generation. Defaults to 2023.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, Any]: A dictionary representing the TSP instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> seed=</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">instance</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="functions-to-handle-instances-and-solutions">
<h3>Functions to handle instances and solutions<a class="headerlink" href="#functions-to-handle-instances-and-solutions" title="Link to this heading">#</a></h3>
<p>When we read (or generate instances) we create <code class="docutils literal notranslate"><span class="pre">python</span></code> data structures that we manipulate with the functions below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_rounded_euclidean_distances</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the cost matrix for TSP instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The TSP instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The cost matrix.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">XY</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asmatrix</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">euclidean</span><span class="p">(</span><span class="n">XY</span><span class="p">,</span> <span class="n">XY</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_route_cost</span><span class="p">(</span><span class="n">route</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">C</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the cost of a given route.</span>

<span class="sd">    Args:</span>
<span class="sd">        route: The route as a list of node indices.</span>
<span class="sd">        C: The cost matrix.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The total cost of the route.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">departure</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">route</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">arrival</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">departure</span><span class="p">,</span> <span class="n">arrival</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_indices_and_reverse_lookup</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the node indices and reverse lookup dictionary for TSP instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The TSP instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the list of node indices and the reverse lookup dictionary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">I</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">]]</span>
    <span class="n">R</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">I</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">R</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_coordinates</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the X and Y coordinates of the nodes in the TSP instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The TSP instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the X and Y coordinates as NumPy arrays.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">XY</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">]]</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">XY</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">show_tsp</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span>
    <span class="n">sol</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">node_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">get_cost_matrix</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize the TSP instance and the solution.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The TSP instance.</span>
<span class="sd">        sol: The solution as a list of node indices (optional).</span>
<span class="sd">        node_labels: Whether to display node labels (default: False).</span>
<span class="sd">        how: Additional information or description of the visualization (default: &#39;&#39;).</span>
<span class="sd">        get_cost_matrix: Function to generate the cost matrix (default get_rounded_euclidean_distances).</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">get_indices_and_reverse_lookup</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">get_coordinates</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="n">S</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">R</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">]</span>

    <span class="n">markersize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span> <span class="k">if</span> <span class="n">node_labels</span> <span class="k">else</span> <span class="mi">5</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">Y</span><span class="p">[</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;yo&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="s2">&quot;g-&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">node_labels</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">Y</span><span class="p">[</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cost_matrix</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39;cost=</span><span class="si">{</span><span class="n">get_route_cost</span><span class="p">(</span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="first-impressions">
<h2>First impressions<a class="headerlink" href="#first-impressions" title="Link to this heading">#</a></h2>
<p>We generate a first instance of small size to start playing with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ca2545318395951c7a24a5ca5c479d136a869262b0f01dc3633c2df409ba67b7.png" src="../../_images/ca2545318395951c7a24a5ca5c479d136a869262b0f01dc3633c2df409ba67b7.png" />
</div>
</div>
<p>Just to show that the node labels may be very generic, we replace the numerical (1-based) indices by letters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span>
<span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">abc</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">])</span>
<span class="p">]</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/971aefc5de3cf873eb48cbbf384f5f585dde995eecbbbbc7294ec4b87ed2e310.png" src="../../_images/971aefc5de3cf873eb48cbbf384f5f585dde995eecbbbbc7294ec4b87ed2e310.png" />
</div>
</div>
</section>
<section id="the-models">
<h2>The models<a class="headerlink" href="#the-models" title="Link to this heading">#</a></h2>
<p>Most of the models consider the decision variables:
$<span class="math notranslate nohighlight">\(
   x_{ij} = \left\{
     \begin{array}{lr}
       1 &amp; \text{if node } j \text{ follows node } i \\
       0 &amp; \text{otherwise}                          \\
     \end{array}
   \right.
\)</span>$
Later we will see how to reduce these number of variables to (less than) half in case of symmetric distances.</p>
<p>All models aim at minimizing the total distance traveled: <span class="math notranslate nohighlight">\(\sum_{i,j \in N} c_{ij}x_{ij}\)</span>.</p>
<p>The models share a core: they model the degree of the nodes and the number of node pairs chosen in the solution.
In the sequel, we refer to a chosen pair <span class="math notranslate nohighlight">\((i,j)\)</span> of nodes as an <em>arc</em>, which we may also call an <em>edge</em> in case the distances are symmetric.
Pair (or arc) <span class="math notranslate nohighlight">\((i,j)\)</span> being chosen means that node <span class="math notranslate nohighlight">\(j\)</span> follows node <span class="math notranslate nohighlight">\(i\)</span> in the solutions, i.e. <span class="math notranslate nohighlight">\(x_{ij} = 1\)</span>.</p>
<p>Models based on arcs (i.e. listing all pairs <span class="math notranslate nohighlight">\((i,j)\)</span> of potential choices) share a <strong>bipartite matching</strong> or <strong>linear assignment</strong> core:
$<span class="math notranslate nohighlight">\(
\begin{array}{rrcll}
\min    &amp; \sum_{i,j \in N} c_{ij}x_{ij} \\
s.t.    &amp; \sum_{i \in N} x_{ij}              &amp; =    &amp; 1     &amp; \forall j \in N                       \\
        &amp; \sum_{j \in N} x_{ij}              &amp; =    &amp; 1     &amp; \forall i \in N                       \\
        &amp; x_{ij} \in \{0,1\}                 &amp;      &amp;       &amp; \forall i, j \in N
\end{array}
\)</span>$
As we learnt from Chapter 4, imposing the integrality (binary nature in this case) of the decision variables on the core model above is redundant, as it is natural integral by nature of its constraint matrix being <a class="reference external" href="https://en.wikipedia.org/wiki/Unimodular_matrix#Total_unimodularity">TUM</a>.</p>
<p>Since this property vanishes as soon as we complement the model in any known way (albeit some <a class="reference external" href="https://arxiv.org/pdf/cs/0609005">published work</a> erroneously saying otherwise, see also entry 17 of this wonderful <a class="reference external" href="https://www.win.tue.nl/~wscor/woeginger/P-versus-NP.htm">legacy page</a>) to reach a valid TSP model, we state the variables <span class="math notranslate nohighlight">\(x_{ij}\)</span> variables as binary.</p>
<p>The core model forces the degree of each node to be 2 (one arc entering the node and one leaving it) and also force <span class="math notranslate nohighlight">\(n\)</span> arcs to be used (that this is implied by the model above can be easily seen by adding any of the two groups of constraints).</p>
<p>Models vary in the way the way the enforce connectivity, as the core part fails in doing that. In fact, <span class="math notranslate nohighlight">\(x_{ii} = 1\)</span> for all <span class="math notranslate nohighlight">\(i\)</span> is feasible, but the TSP clearly leaves all vertices.</p>
<p>An immediate improvement to the core model is just to fix the <code class="docutils literal notranslate"><span class="pre">self-loops</span></code> to 0, i.e. <span class="math notranslate nohighlight">\(x_{ii} = 0\)</span>, but that is not enough as pairwise loops <span class="math notranslate nohighlight">\(x_{ij} = x_{ji} = 1\)</span> become the next culprit.</p>
<p>An inductive reasoning on how to forbid all this <em>sub-tours</em> leads to the well-known <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Dantzig%E2%80%93Fulkerson%E2%80%93Johnson_formulation"><strong>Dantzig, Fulkerson and Johnson</strong></a> model
and formulates the TSP as:
$<span class="math notranslate nohighlight">\(
\begin{array}{rrcll}
\min    &amp; \sum_{i,j \in N} c_{ij}x_{ij} \\
s.t.    &amp; \sum_{i \in N} x_{ij}   &amp; =    &amp; 1     &amp; \forall j \in N                       \\
        &amp; \sum_{j \in N} x_{ij}   &amp; =    &amp; 1     &amp; \forall i \in N                       \\
        &amp; \sum_{i,j \in S} x_{ij} &amp; \leq &amp; |S|-1 &amp; \forall \emptyset \subset S \subset N \\
        &amp; x_{ij} \in \{0,1\}      &amp;      &amp;       &amp; \forall i, j \in N                    \\
\end{array}
\)</span>$
The model above prohibits the choice of enough arcs on each subset of nodes to sub-tour on those nodes.</p>
<p>An equivalent version of the same seems to be more popular, enforcing each subset of nodes to be connected to its complement.
$<span class="math notranslate nohighlight">\(
\begin{array}{rrcll}
\min    &amp; \sum_{i,j \in N} c_{ij}x_{ij} \\
s.t.    &amp; \sum_{i \in N} x_{ij}              &amp; =    &amp; 1     &amp; \forall j \in N                       \\
        &amp; \sum_{j \in N} x_{ij}              &amp; =    &amp; 1     &amp; \forall i \in N                       \\
        &amp; \sum_{i \in S, j \not\in S} x_{ij} &amp; \geq &amp; 1     &amp; \forall \emptyset \subset S \subset N \\
        &amp; x_{ij} \in \{0,1\}                 &amp;      &amp;       &amp; \forall i, j \in N                    \\
\end{array}
\)</span>$</p>
<p>Since this model requires an exponential number of (so-called sub-tour elimination) constraints we may prefer to start with a more compact model.</p>
<p>Fortunately, a <a class="reference external" href="https://en.wikipedia.org/wiki/Travelling_Salesman_problem#Miller-Tucker-Zemlin_formulation">compact</a> model exists.
This ingenious model, devised by C. E. Miller, Alfred E. Tucker and R. A. Zemlin in 1960 adds <em>sequence</em> variables <span class="math notranslate nohighlight">\(u_i\)</span> and replace the connectivity (also known as subtour elimination) constraints which are in a exponential number by circa <span class="math notranslate nohighlight">\(n^2\)</span> sequence constraints.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}{rrcll}
\min    &amp; \sum_{i,j \in N} c_{ij}x_{ij} \\
s.t.    &amp; \sum_{i \in N} x_{ij} &amp; =    &amp; 1    &amp; \forall j \in N                              \\
        &amp; \sum_{j \in N} x_{ij} &amp; =    &amp; 1    &amp; \forall i \in N                              \\
        &amp; x_{ij} \in \{0,1\}    &amp;      &amp;      &amp; \forall i, j \in N                           \\
        &amp; u_i - u_j + nx_{ij}   &amp; \leq &amp; n-1  &amp; \forall i,j \in N : 2 \leq i \not = j \leq n \\
        &amp; u_i \in [0,n-2]       &amp;      &amp;      &amp; \forall i \in N                              \\
\end{array}
\end{split}\]</div>
<p>In fact, this model has been strengthened by several authors, see <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0166218X00003139">this paper</a>.</p>
<p>The first improvement is as below:
$<span class="math notranslate nohighlight">\(
\begin{array}{rrcll}
\min    &amp; \sum_{i,j \in N} c_{ij}x_{ij} \\
s.t.    &amp; \sum_{i \in N} x_{ij}   &amp; =    &amp; 1    &amp; \forall j \in N                              \\
        &amp; \sum_{j \in N} x_{ij}   &amp; =    &amp; 1    &amp; \forall i \in N                              \\
        &amp; x_{ij} \in \{0,1\}      &amp;      &amp;      &amp; \forall i, j \in N                           \\
        &amp; u_i - u_j + (n-1)x_{ij} &amp; \leq &amp; n-2  &amp; \forall i,j \in N : 2 \leq i \not = j \leq n \\
        &amp; u_i \in [0,n-2]         &amp;      &amp;      &amp; \forall i \in N                              \\
\end{array}
\)</span>$</p>
<p>The best known as below:
$<span class="math notranslate nohighlight">\(
\begin{array}{rrcll}
\min    &amp; \sum_{i,j \in N} c_{ij}x_{ij} \\
s.t.    &amp; \sum_{i \in N} x_{ij}                 &amp; =    &amp; 1    &amp; \forall j \in N                              \\
        &amp; \sum_{j \in N} x_{ij}                 &amp; =    &amp; 1    &amp; \forall i \in N                              \\
        &amp; x_{ij} \in \{0,1\}                    &amp;      &amp;      &amp; \forall i, j \in N                           \\
        &amp; u_i - u_j + (n-1)x_{ij} + (n-3)x_{ji} &amp; \leq &amp; n-2  &amp; \forall i,j \in N : 2 \leq i \not = j \leq n \\
        &amp; u_i \in [0,n-2]                       &amp;      &amp;      &amp; \forall i \in N                              \\
\end{array}
\)</span>$
These versions of the MTZ model are equivalent in how they model connectivity, but have increasingly tighter linear relaxations.</p>
<p>Below we will consider three MTZ models: the basic one, the one improved by <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/0167637791900832">Desrochers and Laporte</a> and the best one so far by <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0166218X00003139">Gouveia and Pires</a>.</p>
<section id="building-blocks-for-tsp-models">
<h3>Building blocks for TSP models<a class="headerlink" href="#building-blocks-for-tsp-models" title="Link to this heading">#</a></h3>
<p>As the good programmers that we all are, we will strive for modularity and reuse.
We will not regret!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">LAP</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span>
    <span class="n">get_cost_matrix</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the Linear Assignment Problem (LAP) for a given instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The LAP instance.</span>
<span class="sd">        get_cost_matrix: Function to generate the cost matrix (default get_rounded_euclidean_distances).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The pyo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">get_indices_and_reverse_lookup</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cost_matrix</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;LAP&quot;</span><span class="p">)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">I</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">IJ</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span>
    <span class="n">m</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">IJ</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">C</span><span class="p">[</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">IJ</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Cost</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">IJ</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">DepartFromEach</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ArriveAtEach</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the code below is a bit tricky: the functions <strong>do</strong> modify the model that they take as argument.
The fact that they return the model could lead into believing that not to be the case, but it is.
This construction has the convenience of allowing cascading (composing) function calls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ForbidDiagonal</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add constraints to forbid diagonal elements in the LAP problem.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The modified pyomo.ConcreteModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ForbidStaying</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">PrepareMTZ</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare the Miller-Tucker-Zemlin (MTZ) formulation for the TSP given a LAP model.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The modified pyomo.ConcreteModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">skip_first</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">I1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">skip_first</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">IJ1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">dimen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">skip_first</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">m</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I1</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">OriginalMTZ</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the original Miller-Tucker-Zemlin (MTZ) constraints to the LAP problem.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The modified pyomo.ConcreteModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">IJ1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">MTZ</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I1</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ImprovedMTZ</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the improved Miller-Tucker-Zemlin (MTZ) constraints to the LAP problem.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The modified pyomo.ConcreteModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">IJ1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">MTZ</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I1</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">BestMTZ</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the best Miller-Tucker-Zemlin (MTZ) constraints to the LAP problem.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The modified pyomo.ConcreteModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">IJ1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">MTZ</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I1</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="examining-solutions">
<h2>Examining solutions<a class="headerlink" href="#examining-solutions" title="Link to this heading">#</a></h2>
<p>A TSP solution is a partition of the nodes, complemented with the addition of the first node of the partition at the end.
Each model has a way to encode the solutions, but the translation into a permutation of nodes is different per model.
The most straightforward role is played by the <span class="math notranslate nohighlight">\(u\)</span> variables from the MTZ models, since they list the order of the nodes in that optimal permutation.
Models that confine themselves to arc or edge variables require some bookkeeping to translate the optimal solutions into node permutations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">GetNodeSuccessorFromArcVariables</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the successor of each node from the arc variables in the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping each node to its successor node.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">IJ</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">PartitionSuccessorIntoCycles</span><span class="p">(</span><span class="n">successor</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partition the successor dictionary into cycles.</span>

<span class="sd">    Args:</span>
<span class="sd">        successor: A dictionary mapping each node to its successor node.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of cycles, where each cycle is represented as a list of node pairs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unvisited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">successor</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">successor</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unvisited</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">current</span> <span class="ow">in</span> <span class="n">unvisited</span><span class="p">:</span>
                <span class="n">unvisited</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
                <span class="n">cycle</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current</span><span class="p">,</span> <span class="n">successor</span><span class="p">[</span><span class="n">current</span><span class="p">]))</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">successor</span><span class="p">[</span><span class="n">current</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">GetArcsInSolutionPartitionedInCycles</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the arcs in the solution partitioned into cycles.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of cycles, where each cycle is represented as a list of node pairs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PartitionSuccessorIntoCycles</span><span class="p">(</span><span class="n">GetNodeSuccessorFromArcVariables</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ListNodesInSolution</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List the nodes in the solution cycle.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of nodes in the solution cycle.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">succ</span> <span class="o">=</span> <span class="n">GetNodeSuccessorFromArcVariables</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">succ</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">succ</span><span class="p">[</span><span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">:</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">succ</span><span class="p">[</span><span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sol</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">GetSolutionFromMTZFollowingU</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the solution sequence by following the u values in the MTZ constraints.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel representing the LAP problem.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list representing the solution sequence.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">n</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">()))]</span> <span class="o">=</span> <span class="n">k</span>
    <span class="k">return</span> <span class="n">sequence</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="experiments">
<h2>Experiments<a class="headerlink" href="#experiments" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mtz_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">OriginalMTZ</span><span class="p">,</span> <span class="n">ImprovedMTZ</span><span class="p">,</span> <span class="n">BestMTZ</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mtz_models</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">PrepareMTZ</span><span class="p">(</span><span class="n">ForbidDiagonal</span><span class="p">(</span><span class="n">LAP</span><span class="p">(</span><span class="n">instance</span><span class="p">))))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="n">GetSolutionFromMTZFollowingU</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="n">ListNodesInSolution</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">results</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pyo</span><span class="o">.</span><span class="n">check_optimal_termination</span><span class="p">(</span><span class="n">r</span><span class="p">),</span>
        <span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Cost</span><span class="p">(),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">display_seconds</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GetSolutionFromMTZFollowingU</span><span class="p">(</span><span class="n">m</span><span class="p">)),</span>
    <span class="p">)</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;OriginalMTZ&#39;: (True, 307.0, &#39;0:00:00.066&#39;, &#39;hbeicjdfg&#39;),
 &#39;ImprovedMTZ&#39;: (True, 307.0, &#39;0:00:00.057&#39;, &#39;hbeicjdfg&#39;),
 &#39;BestMTZ&#39;: (True, 307.0, &#39;0:00:00.107&#39;, &#39;gfdjciebh&#39;)}
</pre></div>
</div>
</div>
</div>
<p>We can see that the solution found may differ due to the symmetry of the costs, when drawn they are all the same as the one below (the last one found above).
Note the special role played by the first node: the tour starts and ends there, therefore the <code class="docutils literal notranslate"><span class="pre">u</span></code> variables list the order of the intermediate nodes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ListNodesInSolution</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">display_seconds</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/526116fe7f68aa72a90091c7673c718c136e14831cbc7184a25ca90b1b24dd46.png" src="../../_images/526116fe7f68aa72a90091c7673c718c136e14831cbc7184a25ca90b1b24dd46.png" />
</div>
</div>
<section id="how-does-the-strength-of-the-mtz-models-differ">
<h3>How does the strength of the MTZ models differ?<a class="headerlink" href="#how-does-the-strength-of-the-mtz-models-differ" title="Link to this heading">#</a></h3>
<p>As we have seen in Chapter 3, a strong MILO model is characterized by a small gap between the optimal values of its linear counterpart (the linear relaxation) and of the true (mixed integer) optimal solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tsp_dimensions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MTZ_bounds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="n">tsp_dimensions</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mtz_models</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">MTZ_bounds</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mtz_models</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">PrepareMTZ</span><span class="p">(</span><span class="n">ForbidDiagonal</span><span class="p">(</span><span class="n">LAP</span><span class="p">(</span><span class="n">instance</span><span class="p">))))</span>
        <span class="n">linear_relaxation</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">pyo</span><span class="o">.</span><span class="n">check_optimal_termination</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">MTZ_bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Cost</span><span class="p">()</span>
<span class="n">MTZ_bounds</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9de78e14fff1439da770567d76987e66", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><style type="text/css">
</style>
<table id="T_1ac33">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_1ac33_level0_col0" class="col_heading level0 col0" >OriginalMTZ</th>
      <th id="T_1ac33_level0_col1" class="col_heading level0 col1" >ImprovedMTZ</th>
      <th id="T_1ac33_level0_col2" class="col_heading level0 col2" >BestMTZ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_1ac33_level0_row0" class="row_heading level0 row0" >5</th>
      <td id="T_1ac33_row0_col0" class="data row0 col0" >255.400</td>
      <td id="T_1ac33_row0_col1" class="data row0 col1" >257.000</td>
      <td id="T_1ac33_row0_col2" class="data row0 col2" >265.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row1" class="row_heading level0 row1" >10</th>
      <td id="T_1ac33_row1_col0" class="data row1 col0" >271.300</td>
      <td id="T_1ac33_row1_col1" class="data row1 col1" >271.333</td>
      <td id="T_1ac33_row1_col2" class="data row1 col2" >286.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row2" class="row_heading level0 row2" >15</th>
      <td id="T_1ac33_row2_col0" class="data row2 col0" >232.267</td>
      <td id="T_1ac33_row2_col1" class="data row2 col1" >233.143</td>
      <td id="T_1ac33_row2_col2" class="data row2 col2" >314.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row3" class="row_heading level0 row3" >20</th>
      <td id="T_1ac33_row3_col0" class="data row3 col0" >291.300</td>
      <td id="T_1ac33_row3_col1" class="data row3 col1" >291.579</td>
      <td id="T_1ac33_row3_col2" class="data row3 col2" >349.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row4" class="row_heading level0 row4" >25</th>
      <td id="T_1ac33_row4_col0" class="data row4 col0" >311.080</td>
      <td id="T_1ac33_row4_col1" class="data row4 col1" >311.167</td>
      <td id="T_1ac33_row4_col2" class="data row4 col2" >347.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row5" class="row_heading level0 row5" >30</th>
      <td id="T_1ac33_row5_col0" class="data row5 col0" >312.867</td>
      <td id="T_1ac33_row5_col1" class="data row5 col1" >313.034</td>
      <td id="T_1ac33_row5_col2" class="data row5 col2" >388.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row6" class="row_heading level0 row6" >35</th>
      <td id="T_1ac33_row6_col0" class="data row6 col0" >380.314</td>
      <td id="T_1ac33_row6_col1" class="data row6 col1" >380.471</td>
      <td id="T_1ac33_row6_col2" class="data row6 col2" >468.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row7" class="row_heading level0 row7" >40</th>
      <td id="T_1ac33_row7_col0" class="data row7 col0" >406.125</td>
      <td id="T_1ac33_row7_col1" class="data row7 col1" >406.231</td>
      <td id="T_1ac33_row7_col2" class="data row7 col2" >487.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row8" class="row_heading level0 row8" >45</th>
      <td id="T_1ac33_row8_col0" class="data row8 col0" >453.022</td>
      <td id="T_1ac33_row8_col1" class="data row8 col1" >453.091</td>
      <td id="T_1ac33_row8_col2" class="data row8 col2" >526.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row9" class="row_heading level0 row9" >50</th>
      <td id="T_1ac33_row9_col0" class="data row9 col0" >473.340</td>
      <td id="T_1ac33_row9_col1" class="data row9 col1" >473.388</td>
      <td id="T_1ac33_row9_col2" class="data row9 col2" >545.500</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row10" class="row_heading level0 row10" >55</th>
      <td id="T_1ac33_row10_col0" class="data row10 col0" >504.873</td>
      <td id="T_1ac33_row10_col1" class="data row10 col1" >504.907</td>
      <td id="T_1ac33_row10_col2" class="data row10 col2" >569.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row11" class="row_heading level0 row11" >60</th>
      <td id="T_1ac33_row11_col0" class="data row11 col0" >512.667</td>
      <td id="T_1ac33_row11_col1" class="data row11 col1" >512.712</td>
      <td id="T_1ac33_row11_col2" class="data row11 col2" >605.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row12" class="row_heading level0 row12" >65</th>
      <td id="T_1ac33_row12_col0" class="data row12 col0" >550.369</td>
      <td id="T_1ac33_row12_col1" class="data row12 col1" >550.406</td>
      <td id="T_1ac33_row12_col2" class="data row12 col2" >629.500</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row13" class="row_heading level0 row13" >70</th>
      <td id="T_1ac33_row13_col0" class="data row13 col0" >550.443</td>
      <td id="T_1ac33_row13_col1" class="data row13 col1" >550.478</td>
      <td id="T_1ac33_row13_col2" class="data row13 col2" >643.500</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row14" class="row_heading level0 row14" >75</th>
      <td id="T_1ac33_row14_col0" class="data row14 col0" >572.013</td>
      <td id="T_1ac33_row14_col1" class="data row14 col1" >572.041</td>
      <td id="T_1ac33_row14_col2" class="data row14 col2" >655.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row15" class="row_heading level0 row15" >80</th>
      <td id="T_1ac33_row15_col0" class="data row15 col0" >579.750</td>
      <td id="T_1ac33_row15_col1" class="data row15 col1" >579.772</td>
      <td id="T_1ac33_row15_col2" class="data row15 col2" >660.500</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row16" class="row_heading level0 row16" >85</th>
      <td id="T_1ac33_row16_col0" class="data row16 col0" >602.565</td>
      <td id="T_1ac33_row16_col1" class="data row16 col1" >602.583</td>
      <td id="T_1ac33_row16_col2" class="data row16 col2" >673.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row17" class="row_heading level0 row17" >90</th>
      <td id="T_1ac33_row17_col0" class="data row17 col0" >603.900</td>
      <td id="T_1ac33_row17_col1" class="data row17 col1" >603.921</td>
      <td id="T_1ac33_row17_col2" class="data row17 col2" >693.500</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row18" class="row_heading level0 row18" >95</th>
      <td id="T_1ac33_row18_col0" class="data row18 col0" >621.821</td>
      <td id="T_1ac33_row18_col1" class="data row18 col1" >621.840</td>
      <td id="T_1ac33_row18_col2" class="data row18 col2" >718.000</td>
    </tr>
    <tr>
      <th id="T_1ac33_level0_row19" class="row_heading level0 row19" >100</th>
      <td id="T_1ac33_row19_col0" class="data row19 col0" >660.670</td>
      <td id="T_1ac33_row19_col1" class="data row19 col1" >660.687</td>
      <td id="T_1ac33_row19_col2" class="data row19 col2" >751.500</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We can see above the optimal values of the linear relaxations of the three different MTZ models for (on each line) the same instance.</p>
<p>Note that the instance of 10 nodes that we solved before is the same as in the table above (due to seeding the generator).</p>
<p>The increase of the third version is quite impressive!
How is that affecting the times required to solve the integer versions?</p>
<p>Small spoiler about the remainder of this notebook: it is not wise to try to solve instances of more than 15 nodes with these models!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MTZ_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="n">tsp_dimensions</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mtz_models</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">MTZ_times</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mtz_models</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">PrepareMTZ</span><span class="p">(</span><span class="n">ForbidDiagonal</span><span class="p">(</span><span class="n">LAP</span><span class="p">(</span><span class="n">instance</span><span class="p">))))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">MTZ_times</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_seconds</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">cost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Cost</span><span class="p">()))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cost</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">MTZ_times</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">cost</span><span class="p">)))</span>
<span class="n">MTZ_times</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "45bee479422944d490e61d24d3f45674", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>OriginalMTZ</th>
      <th>ImprovedMTZ</th>
      <th>BestMTZ</th>
      <th>cost</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>0:00:00.011</td>
      <td>0:00:00.004</td>
      <td>0:00:00.003</td>
      <td>269</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0:00:00.061</td>
      <td>0:00:00.058</td>
      <td>0:00:00.115</td>
      <td>307</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0:00:00.431</td>
      <td>0:00:00.427</td>
      <td>0:00:00.587</td>
      <td>335</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note that the times above are likely to be very different if you run this notebook on your own machine, even if using the same solver and version.
In particular, if your machine has more than two (virtual) processors the differences between the models will be much smaller.
In fact, it may happen that the times taken to optimize do not directly reflect the strength of the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">MTZ_times</span><span class="p">,</span> <span class="n">MTZ_bounds</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_90d4f">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_90d4f_level0_col0" class="col_heading level0 col0" >OriginalMTZ</th>
      <th id="T_90d4f_level0_col1" class="col_heading level0 col1" >ImprovedMTZ</th>
      <th id="T_90d4f_level0_col2" class="col_heading level0 col2" >BestMTZ</th>
      <th id="T_90d4f_level0_col3" class="col_heading level0 col3" >cost</th>
      <th id="T_90d4f_level0_col4" class="col_heading level0 col4" >OriginalMTZ</th>
      <th id="T_90d4f_level0_col5" class="col_heading level0 col5" >ImprovedMTZ</th>
      <th id="T_90d4f_level0_col6" class="col_heading level0 col6" >BestMTZ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_90d4f_level0_row0" class="row_heading level0 row0" >5</th>
      <td id="T_90d4f_row0_col0" class="data row0 col0" >0:00:00.011</td>
      <td id="T_90d4f_row0_col1" class="data row0 col1" >0:00:00.004</td>
      <td id="T_90d4f_row0_col2" class="data row0 col2" >0:00:00.003</td>
      <td id="T_90d4f_row0_col3" class="data row0 col3" >269</td>
      <td id="T_90d4f_row0_col4" class="data row0 col4" >255.400</td>
      <td id="T_90d4f_row0_col5" class="data row0 col5" >257.000</td>
      <td id="T_90d4f_row0_col6" class="data row0 col6" >265.000</td>
    </tr>
    <tr>
      <th id="T_90d4f_level0_row1" class="row_heading level0 row1" >10</th>
      <td id="T_90d4f_row1_col0" class="data row1 col0" >0:00:00.061</td>
      <td id="T_90d4f_row1_col1" class="data row1 col1" >0:00:00.058</td>
      <td id="T_90d4f_row1_col2" class="data row1 col2" >0:00:00.115</td>
      <td id="T_90d4f_row1_col3" class="data row1 col3" >307</td>
      <td id="T_90d4f_row1_col4" class="data row1 col4" >271.300</td>
      <td id="T_90d4f_row1_col5" class="data row1 col5" >271.333</td>
      <td id="T_90d4f_row1_col6" class="data row1 col6" >286.000</td>
    </tr>
    <tr>
      <th id="T_90d4f_level0_row2" class="row_heading level0 row2" >15</th>
      <td id="T_90d4f_row2_col0" class="data row2 col0" >0:00:00.431</td>
      <td id="T_90d4f_row2_col1" class="data row2 col1" >0:00:00.427</td>
      <td id="T_90d4f_row2_col2" class="data row2 col2" >0:00:00.587</td>
      <td id="T_90d4f_row2_col3" class="data row2 col3" >335</td>
      <td id="T_90d4f_row2_col4" class="data row2 col4" >232.267</td>
      <td id="T_90d4f_row2_col5" class="data row2 col5" >233.143</td>
      <td id="T_90d4f_row2_col6" class="data row2 col6" >314.000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>
<section id="exploring-the-models">
<h2>Exploring the models<a class="headerlink" href="#exploring-the-models" title="Link to this heading">#</a></h2>
<p>While often in our book we follow simple steps (model, implement, feed data, solve) it is wise to consider some improvement iterations that <em>improve</em> the model.</p>
<p>We will see how to combine MTZ and DFJ, how that insight leads to actually becoming able to solve DFJ without the need for MTZ and how DFJ can be specialized to the case of symmetric costs, and the benefits of doing so (if that is indeed the case for the instances at hand).</p>
<section id="a-tale-of-two-models">
<h3>A tale of two models<a class="headerlink" href="#a-tale-of-two-models" title="Link to this heading">#</a></h3>
<p>The DFJ model is hard to use directly, since we would need to explicitly declare <span class="math notranslate nohighlight">\(2^n-2\)</span> constraints, and that soon becomes impractical and soon after that, even impossible.</p>
<p>Our first attempt to grasp its use follows the idea in <a class="reference external" href="https://epubs.siam.org/doi/pdf/10.1137/S00361445023685">this educational paper</a> in combining DFJ and MTZ.</p>
<p>The main idea is as follows:</p>
<ul class="simple">
<li><p>Start by solving the linear assignment model.</p></li>
<li><p>For each sub-tour in the solution identify the set <span class="math notranslate nohighlight">\(S\)</span> and add the corresponding DFJ sub-tour elimination constraint.</p></li>
<li><p>Solve again and repeat a pre-specified number of (<code class="docutils literal notranslate"><span class="pre">nof</span></code>) times.</p></li>
</ul>
<p>At the end of the procedure above we end up with the DFJ model confined to some sub-tour elimination constraints.
These are redundant for the (mixed integer) MTZ model, but not for its linear relaxation.
We add the MTZ variables and constraints and solve the resulting mixed model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">AddSomeDFJConstraints</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">nof</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">solver</span><span class="p">:</span> <span class="nb">any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>  <span class="c1"># need to define a type for a solver</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the violated DFJ constraints to the model during up to nof repeated solves.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The TSP instance.</span>
<span class="sd">        nof: The maximum number of solves to add DFJ constraints.</span>
<span class="sd">        solver: The pyomo.Solver object to solve the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the modified model and the index where an optimal solution was found.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optimal_at</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ForbidDiagonal</span><span class="p">(</span><span class="n">LAP</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">cuts</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConstraintList</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nof</span><span class="p">):</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="n">GetArcsInSolutionPartitionedInCycles</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">optimal_at</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">optimal_at</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nof</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">combined_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="n">tsp_dimensions</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;tDFJ.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tMTZ.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;LR.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nof</span><span class="p">]))</span>
    <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">combined_results</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nof</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">optimal_at</span> <span class="o">=</span> <span class="n">AddSomeDFJConstraints</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">)</span>
        <span class="n">combined_results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tDFJ.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optimal_at</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">BestMTZ</span><span class="p">(</span><span class="n">PrepareMTZ</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">combined_results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tMTZ.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Cost</span><span class="p">())))</span>
        <span class="n">linear_relaxation</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">combined_results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;LR.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Cost</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cost</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cost</span>
    <span class="n">combined_results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
<span class="n">combined_results</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9aa431695126469f8c42f557815651e6", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><style type="text/css">
</style>
<table id="T_47279">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_47279_level0_col0" class="col_heading level0 col0" >tDFJ.1</th>
      <th id="T_47279_level0_col1" class="col_heading level0 col1" >tMTZ.1</th>
      <th id="T_47279_level0_col2" class="col_heading level0 col2" >LR.1</th>
      <th id="T_47279_level0_col3" class="col_heading level0 col3" >tDFJ.2</th>
      <th id="T_47279_level0_col4" class="col_heading level0 col4" >tMTZ.2</th>
      <th id="T_47279_level0_col5" class="col_heading level0 col5" >LR.2</th>
      <th id="T_47279_level0_col6" class="col_heading level0 col6" >tDFJ.3</th>
      <th id="T_47279_level0_col7" class="col_heading level0 col7" >tMTZ.3</th>
      <th id="T_47279_level0_col8" class="col_heading level0 col8" >LR.3</th>
      <th id="T_47279_level0_col9" class="col_heading level0 col9" >tDFJ.4</th>
      <th id="T_47279_level0_col10" class="col_heading level0 col10" >tMTZ.4</th>
      <th id="T_47279_level0_col11" class="col_heading level0 col11" >LR.4</th>
      <th id="T_47279_level0_col12" class="col_heading level0 col12" >tDFJ.5</th>
      <th id="T_47279_level0_col13" class="col_heading level0 col13" >tMTZ.5</th>
      <th id="T_47279_level0_col14" class="col_heading level0 col14" >LR.5</th>
      <th id="T_47279_level0_col15" class="col_heading level0 col15" >cost</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_47279_level0_row0" class="row_heading level0 row0" >5</th>
      <td id="T_47279_row0_col0" class="data row0 col0" >0.010</td>
      <td id="T_47279_row0_col1" class="data row0 col1" >0.000</td>
      <td id="T_47279_row0_col2" class="data row0 col2" >265.000</td>
      <td id="T_47279_row0_col3" class="data row0 col3" >0.010</td>
      <td id="T_47279_row0_col4" class="data row0 col4" >0.000</td>
      <td id="T_47279_row0_col5" class="data row0 col5" >269.000</td>
      <td id="T_47279_row0_col6" class="data row0 col6" >0.010</td>
      <td id="T_47279_row0_col7" class="data row0 col7" >nan</td>
      <td id="T_47279_row0_col8" class="data row0 col8" >269.000</td>
      <td id="T_47279_row0_col9" class="data row0 col9" >0.010</td>
      <td id="T_47279_row0_col10" class="data row0 col10" >nan</td>
      <td id="T_47279_row0_col11" class="data row0 col11" >269.000</td>
      <td id="T_47279_row0_col12" class="data row0 col12" >0.010</td>
      <td id="T_47279_row0_col13" class="data row0 col13" >nan</td>
      <td id="T_47279_row0_col14" class="data row0 col14" >269.000</td>
      <td id="T_47279_row0_col15" class="data row0 col15" >269</td>
    </tr>
    <tr>
      <th id="T_47279_level0_row1" class="row_heading level0 row1" >10</th>
      <td id="T_47279_row1_col0" class="data row1 col0" >0.010</td>
      <td id="T_47279_row1_col1" class="data row1 col1" >0.020</td>
      <td id="T_47279_row1_col2" class="data row1 col2" >292.000</td>
      <td id="T_47279_row1_col3" class="data row1 col3" >0.010</td>
      <td id="T_47279_row1_col4" class="data row1 col4" >0.010</td>
      <td id="T_47279_row1_col5" class="data row1 col5" >292.000</td>
      <td id="T_47279_row1_col6" class="data row1 col6" >0.010</td>
      <td id="T_47279_row1_col7" class="data row1 col7" >0.020</td>
      <td id="T_47279_row1_col8" class="data row1 col8" >292.000</td>
      <td id="T_47279_row1_col9" class="data row1 col9" >0.020</td>
      <td id="T_47279_row1_col10" class="data row1 col10" >nan</td>
      <td id="T_47279_row1_col11" class="data row1 col11" >292.000</td>
      <td id="T_47279_row1_col12" class="data row1 col12" >0.020</td>
      <td id="T_47279_row1_col13" class="data row1 col13" >nan</td>
      <td id="T_47279_row1_col14" class="data row1 col14" >292.000</td>
      <td id="T_47279_row1_col15" class="data row1 col15" >307</td>
    </tr>
    <tr>
      <th id="T_47279_level0_row2" class="row_heading level0 row2" >15</th>
      <td id="T_47279_row2_col0" class="data row2 col0" >0.010</td>
      <td id="T_47279_row2_col1" class="data row2 col1" >0.020</td>
      <td id="T_47279_row2_col2" class="data row2 col2" >335.000</td>
      <td id="T_47279_row2_col3" class="data row2 col3" >0.010</td>
      <td id="T_47279_row2_col4" class="data row2 col4" >0.020</td>
      <td id="T_47279_row2_col5" class="data row2 col5" >335.000</td>
      <td id="T_47279_row2_col6" class="data row2 col6" >0.010</td>
      <td id="T_47279_row2_col7" class="data row2 col7" >nan</td>
      <td id="T_47279_row2_col8" class="data row2 col8" >335.000</td>
      <td id="T_47279_row2_col9" class="data row2 col9" >0.010</td>
      <td id="T_47279_row2_col10" class="data row2 col10" >nan</td>
      <td id="T_47279_row2_col11" class="data row2 col11" >335.000</td>
      <td id="T_47279_row2_col12" class="data row2 col12" >0.080</td>
      <td id="T_47279_row2_col13" class="data row2 col13" >nan</td>
      <td id="T_47279_row2_col14" class="data row2 col14" >335.000</td>
      <td id="T_47279_row2_col15" class="data row2 col15" >335</td>
    </tr>
    <tr>
      <th id="T_47279_level0_row3" class="row_heading level0 row3" >20</th>
      <td id="T_47279_row3_col0" class="data row3 col0" >0.010</td>
      <td id="T_47279_row3_col1" class="data row3 col1" >0.950</td>
      <td id="T_47279_row3_col2" class="data row3 col2" >357.000</td>
      <td id="T_47279_row3_col3" class="data row3 col3" >0.020</td>
      <td id="T_47279_row3_col4" class="data row3 col4" >0.900</td>
      <td id="T_47279_row3_col5" class="data row3 col5" >357.000</td>
      <td id="T_47279_row3_col6" class="data row3 col6" >0.040</td>
      <td id="T_47279_row3_col7" class="data row3 col7" >1.100</td>
      <td id="T_47279_row3_col8" class="data row3 col8" >357.000</td>
      <td id="T_47279_row3_col9" class="data row3 col9" >0.060</td>
      <td id="T_47279_row3_col10" class="data row3 col10" >0.660</td>
      <td id="T_47279_row3_col11" class="data row3 col11" >357.000</td>
      <td id="T_47279_row3_col12" class="data row3 col12" >0.100</td>
      <td id="T_47279_row3_col13" class="data row3 col13" >0.780</td>
      <td id="T_47279_row3_col14" class="data row3 col14" >357.000</td>
      <td id="T_47279_row3_col15" class="data row3 col15" >380</td>
    </tr>
    <tr>
      <th id="T_47279_level0_row4" class="row_heading level0 row4" >25</th>
      <td id="T_47279_row4_col0" class="data row4 col0" >0.020</td>
      <td id="T_47279_row4_col1" class="data row4 col1" >0.690</td>
      <td id="T_47279_row4_col2" class="data row4 col2" >355.000</td>
      <td id="T_47279_row4_col3" class="data row4 col3" >0.030</td>
      <td id="T_47279_row4_col4" class="data row4 col4" >0.770</td>
      <td id="T_47279_row4_col5" class="data row4 col5" >355.000</td>
      <td id="T_47279_row4_col6" class="data row4 col6" >0.120</td>
      <td id="T_47279_row4_col7" class="data row4 col7" >0.710</td>
      <td id="T_47279_row4_col8" class="data row4 col8" >355.000</td>
      <td id="T_47279_row4_col9" class="data row4 col9" >0.140</td>
      <td id="T_47279_row4_col10" class="data row4 col10" >0.700</td>
      <td id="T_47279_row4_col11" class="data row4 col11" >355.000</td>
      <td id="T_47279_row4_col12" class="data row4 col12" >0.180</td>
      <td id="T_47279_row4_col13" class="data row4 col13" >0.440</td>
      <td id="T_47279_row4_col14" class="data row4 col14" >355.000</td>
      <td id="T_47279_row4_col15" class="data row4 col15" >395</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">combined_results</span><span class="p">,</span> <span class="n">MTZ_times</span><span class="p">,</span> <span class="n">MTZ_bounds</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
    <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_b3112">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_b3112_level0_col0" class="col_heading level0 col0" >tDFJ.1</th>
      <th id="T_b3112_level0_col1" class="col_heading level0 col1" >tMTZ.1</th>
      <th id="T_b3112_level0_col2" class="col_heading level0 col2" >LR.1</th>
      <th id="T_b3112_level0_col3" class="col_heading level0 col3" >tDFJ.2</th>
      <th id="T_b3112_level0_col4" class="col_heading level0 col4" >tMTZ.2</th>
      <th id="T_b3112_level0_col5" class="col_heading level0 col5" >LR.2</th>
      <th id="T_b3112_level0_col6" class="col_heading level0 col6" >tDFJ.3</th>
      <th id="T_b3112_level0_col7" class="col_heading level0 col7" >tMTZ.3</th>
      <th id="T_b3112_level0_col8" class="col_heading level0 col8" >LR.3</th>
      <th id="T_b3112_level0_col9" class="col_heading level0 col9" >tDFJ.4</th>
      <th id="T_b3112_level0_col10" class="col_heading level0 col10" >tMTZ.4</th>
      <th id="T_b3112_level0_col11" class="col_heading level0 col11" >LR.4</th>
      <th id="T_b3112_level0_col12" class="col_heading level0 col12" >tDFJ.5</th>
      <th id="T_b3112_level0_col13" class="col_heading level0 col13" >tMTZ.5</th>
      <th id="T_b3112_level0_col14" class="col_heading level0 col14" >LR.5</th>
      <th id="T_b3112_level0_col15" class="col_heading level0 col15" >cost</th>
      <th id="T_b3112_level0_col16" class="col_heading level0 col16" >OriginalMTZ</th>
      <th id="T_b3112_level0_col17" class="col_heading level0 col17" >ImprovedMTZ</th>
      <th id="T_b3112_level0_col18" class="col_heading level0 col18" >BestMTZ</th>
      <th id="T_b3112_level0_col19" class="col_heading level0 col19" >cost</th>
      <th id="T_b3112_level0_col20" class="col_heading level0 col20" >OriginalMTZ</th>
      <th id="T_b3112_level0_col21" class="col_heading level0 col21" >ImprovedMTZ</th>
      <th id="T_b3112_level0_col22" class="col_heading level0 col22" >BestMTZ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b3112_level0_row0" class="row_heading level0 row0" >5</th>
      <td id="T_b3112_row0_col0" class="data row0 col0" >0.010</td>
      <td id="T_b3112_row0_col1" class="data row0 col1" >0.000</td>
      <td id="T_b3112_row0_col2" class="data row0 col2" >265.000</td>
      <td id="T_b3112_row0_col3" class="data row0 col3" >0.010</td>
      <td id="T_b3112_row0_col4" class="data row0 col4" >0.000</td>
      <td id="T_b3112_row0_col5" class="data row0 col5" >269.000</td>
      <td id="T_b3112_row0_col6" class="data row0 col6" >0.010</td>
      <td id="T_b3112_row0_col7" class="data row0 col7" >nan</td>
      <td id="T_b3112_row0_col8" class="data row0 col8" >269.000</td>
      <td id="T_b3112_row0_col9" class="data row0 col9" >0.010</td>
      <td id="T_b3112_row0_col10" class="data row0 col10" >nan</td>
      <td id="T_b3112_row0_col11" class="data row0 col11" >269.000</td>
      <td id="T_b3112_row0_col12" class="data row0 col12" >0.010</td>
      <td id="T_b3112_row0_col13" class="data row0 col13" >nan</td>
      <td id="T_b3112_row0_col14" class="data row0 col14" >269.000</td>
      <td id="T_b3112_row0_col15" class="data row0 col15" >269</td>
      <td id="T_b3112_row0_col16" class="data row0 col16" >0:00:00.011</td>
      <td id="T_b3112_row0_col17" class="data row0 col17" >0:00:00.004</td>
      <td id="T_b3112_row0_col18" class="data row0 col18" >0:00:00.003</td>
      <td id="T_b3112_row0_col19" class="data row0 col19" >269</td>
      <td id="T_b3112_row0_col20" class="data row0 col20" >255.400</td>
      <td id="T_b3112_row0_col21" class="data row0 col21" >257.000</td>
      <td id="T_b3112_row0_col22" class="data row0 col22" >265.000</td>
    </tr>
    <tr>
      <th id="T_b3112_level0_row1" class="row_heading level0 row1" >10</th>
      <td id="T_b3112_row1_col0" class="data row1 col0" >0.010</td>
      <td id="T_b3112_row1_col1" class="data row1 col1" >0.020</td>
      <td id="T_b3112_row1_col2" class="data row1 col2" >292.000</td>
      <td id="T_b3112_row1_col3" class="data row1 col3" >0.010</td>
      <td id="T_b3112_row1_col4" class="data row1 col4" >0.010</td>
      <td id="T_b3112_row1_col5" class="data row1 col5" >292.000</td>
      <td id="T_b3112_row1_col6" class="data row1 col6" >0.010</td>
      <td id="T_b3112_row1_col7" class="data row1 col7" >0.020</td>
      <td id="T_b3112_row1_col8" class="data row1 col8" >292.000</td>
      <td id="T_b3112_row1_col9" class="data row1 col9" >0.020</td>
      <td id="T_b3112_row1_col10" class="data row1 col10" >nan</td>
      <td id="T_b3112_row1_col11" class="data row1 col11" >292.000</td>
      <td id="T_b3112_row1_col12" class="data row1 col12" >0.020</td>
      <td id="T_b3112_row1_col13" class="data row1 col13" >nan</td>
      <td id="T_b3112_row1_col14" class="data row1 col14" >292.000</td>
      <td id="T_b3112_row1_col15" class="data row1 col15" >307</td>
      <td id="T_b3112_row1_col16" class="data row1 col16" >0:00:00.061</td>
      <td id="T_b3112_row1_col17" class="data row1 col17" >0:00:00.058</td>
      <td id="T_b3112_row1_col18" class="data row1 col18" >0:00:00.115</td>
      <td id="T_b3112_row1_col19" class="data row1 col19" >307</td>
      <td id="T_b3112_row1_col20" class="data row1 col20" >271.300</td>
      <td id="T_b3112_row1_col21" class="data row1 col21" >271.333</td>
      <td id="T_b3112_row1_col22" class="data row1 col22" >286.000</td>
    </tr>
    <tr>
      <th id="T_b3112_level0_row2" class="row_heading level0 row2" >15</th>
      <td id="T_b3112_row2_col0" class="data row2 col0" >0.010</td>
      <td id="T_b3112_row2_col1" class="data row2 col1" >0.020</td>
      <td id="T_b3112_row2_col2" class="data row2 col2" >335.000</td>
      <td id="T_b3112_row2_col3" class="data row2 col3" >0.010</td>
      <td id="T_b3112_row2_col4" class="data row2 col4" >0.020</td>
      <td id="T_b3112_row2_col5" class="data row2 col5" >335.000</td>
      <td id="T_b3112_row2_col6" class="data row2 col6" >0.010</td>
      <td id="T_b3112_row2_col7" class="data row2 col7" >nan</td>
      <td id="T_b3112_row2_col8" class="data row2 col8" >335.000</td>
      <td id="T_b3112_row2_col9" class="data row2 col9" >0.010</td>
      <td id="T_b3112_row2_col10" class="data row2 col10" >nan</td>
      <td id="T_b3112_row2_col11" class="data row2 col11" >335.000</td>
      <td id="T_b3112_row2_col12" class="data row2 col12" >0.080</td>
      <td id="T_b3112_row2_col13" class="data row2 col13" >nan</td>
      <td id="T_b3112_row2_col14" class="data row2 col14" >335.000</td>
      <td id="T_b3112_row2_col15" class="data row2 col15" >335</td>
      <td id="T_b3112_row2_col16" class="data row2 col16" >0:00:00.431</td>
      <td id="T_b3112_row2_col17" class="data row2 col17" >0:00:00.427</td>
      <td id="T_b3112_row2_col18" class="data row2 col18" >0:00:00.587</td>
      <td id="T_b3112_row2_col19" class="data row2 col19" >335</td>
      <td id="T_b3112_row2_col20" class="data row2 col20" >232.267</td>
      <td id="T_b3112_row2_col21" class="data row2 col21" >233.143</td>
      <td id="T_b3112_row2_col22" class="data row2 col22" >314.000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="wait-we-can-solve-dfj-after-all">
<h3>Wait, we <em>can</em> solve DFJ after all!<a class="headerlink" href="#wait-we-can-solve-dfj-after-all" title="Link to this heading">#</a></h3>
<p>We just saw that we can implement a tiny bit of DFJ on a need basis and complement it with MTZ in order solve the combined model faster than MTZ alone.</p>
<p>But the process of discovering that part of DFJ that matters for the instance at hand may actually lead to solving it without the need of MTZ, and hence <em>only</em> using (the right part of) DFJ.</p>
<p>What we do is known in the literature as constraint (or cut) generation, sometimes also known as <em>lazy constraints</em>.</p>
<p>The fundamental ingredient is known as the <em>separation problem</em>.
This is the ability to discover the important (but still missing) constraints that are in fact violated by the (infeasible) solution at hand.
Once these constraints are added, the previous solution becomes <em>separated</em> from  the new feasible set and will not be found again, ensuring termination of this iterative procedure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">SolveWithDFJ</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>  <span class="c1"># need to define a type for a solver</span>
    <span class="n">get_cost_matrix</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the violated DFJ constraints to the model until the optimal solution is found.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The TSP instance.</span>
<span class="sd">        solver: The pyomo.Solver object to solve the model.</span>
<span class="sd">        get_cost_matrix: Function to generate the cost matrix (default get_rounded_euclidean_distances).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The optimal solution.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optimal_at</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ForbidDiagonal</span><span class="p">(</span><span class="n">LAP</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">get_cost_matrix</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">cuts</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConstraintList</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="n">GetArcsInSolutionPartitionedInCycles</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Cost</span><span class="p">(),</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ListNodesInSolution</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">SolveWithDFJ</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">sol</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>471.0 [2, 2, 2, 2, 3, 2, 3, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2]
549.0 [27, 7, 3, 3, 2, 2, 3, 3]
562.0 [4, 9, 7, 3, 2, 3, 2, 3, 3, 3, 2, 3, 2, 2, 2]
571.0 [4, 15, 6, 3, 19, 3]
577.0 [36, 10, 4]
577.0 [36, 4, 4, 6]
578.0 [3, 16, 25, 6]
579.0 [3, 16, 25, 6]
580.0 [28, 6, 10, 4, 2]
581.0 [36, 4, 4, 6]
582.0 [44, 2, 2, 2]
583.0 [50]
</pre></div>
</div>
<img alt="../../_images/236d8b831ab5e8e391f4e5bb44b42446e1f67a08cc5da4ee14847e0caab28fe7.png" src="../../_images/236d8b831ab5e8e391f4e5bb44b42446e1f67a08cc5da4ee14847e0caab28fe7.png" />
</div>
</div>
<p>We could not solve this instance with the (free, community edition of the) commercial solver, but the free solver did it in less than one minute!</p>
<p>We could be very happy about this, but now we realize that for all instances that we have been solving <span class="math notranslate nohighlight">\(c_{ij} = c_{ji}\)</span> and in fact we do not need to have both <span class="math notranslate nohighlight">\(x_{ij}\)</span> and <span class="math notranslate nohighlight">\(x_{ji}\)</span>.</p>
<p>In essence, our underlying graph has been asymmetric (hence, with directed arcs) but can be regarded as symmetric (with undirected edges).</p>
<p>We do need to be careful about what that means for the model!</p>
</section>
<section id="symmetry">
<h3>Symmetry<a class="headerlink" href="#symmetry" title="Link to this heading">#</a></h3>
<p>So far, our models include variables <span class="math notranslate nohighlight">\(x_{ij}\)</span> for all <span class="math notranslate nohighlight">\(i,j \in N\)</span>.
However, if the cost matrix happens to be symmetric (and that is the case is symmetric of all instances studied in this notebook) we may ignore the direction, i.e. consider only one of the two arcs <span class="math notranslate nohighlight">\((i,j)\)</span> or <span class="math notranslate nohighlight">\((j,i)\)</span>.</p>
<p>The number of edges <span class="math notranslate nohighlight">\((i,j)\)</span> for <span class="math notranslate nohighlight">\(i &lt; j\)</span> is less than half of the number of arcs.</p>
<p>The symmetric model can be easily derived from the DFJ model: the linear assignment structure is replaced by constraining each node to have degree 2.</p>
<p>Note that no variant of MTZ is known for the symmetric case!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">SymmetricBasicModel</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a symmetric basic model for the TSP.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: The TSP instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The created pyomo.ConcreteModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">get_indices_and_reverse_lookup</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;STSP&quot;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">I</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">C</span><span class="p">[</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Cost</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">enter_and_leave</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">E</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">m</span>


<span class="k">def</span><span class="w"> </span><span class="nf">GetSelected</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the selected edges in the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        m: The pyomo.ConcreteModel.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of selected edges.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">E</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">GetAdjacent</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the adjacent nodes for each node in the selected edges.</span>

<span class="sd">    Args:</span>
<span class="sd">        selected: The selected edges.</span>
<span class="sd">        I: The set of all nodes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping each node to its adjacent nodes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adjacent</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">I</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
        <span class="n">adjacent</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">adjacent</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adjacent</span>


<span class="k">def</span><span class="w"> </span><span class="nf">GetSubTours</span><span class="p">(</span><span class="n">adjacent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the sub-tours from the adjacent nodes.</span>

<span class="sd">    Args:</span>
<span class="sd">        adjacent: The dictionary mapping each node to its adjacent nodes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of sub-tours.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">adjacent</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">sub_tours</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">))</span>
        <span class="n">tour</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="n">all_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="n">tour</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">adjacent</span><span class="p">[</span><span class="n">tour</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">adjacent</span><span class="p">[</span><span class="n">tour</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tour</span><span class="p">:</span>
                    <span class="n">tour</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">all_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="n">sub_tours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tour</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sub_tours</span>


<span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">SymmetricBasicModel</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">ellim</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConstraintList</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">sub_tours</span> <span class="o">=</span> <span class="n">GetSubTours</span><span class="p">(</span><span class="n">GetAdjacent</span><span class="p">(</span><span class="n">GetSelected</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Cost</span><span class="p">(),</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="n">sub_tours</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="n">sub_tours</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">ellim</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">E</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">S</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">])</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>552.0 [28, 7, 3, 3, 3, 3, 3]
571.0 [4, 15, 6, 3, 19, 3]
577.0 [36, 4, 4, 6]
581.0 [3, 16, 11, 20]
583.0 [50]
</pre></div>
</div>
<img alt="../../_images/733abf91c0a7d4e3e7ad52cd5fbbdcfe3a49e0f62637b79bea32a364b00e87d3.png" src="../../_images/733abf91c0a7d4e3e7ad52cd5fbbdcfe3a49e0f62637b79bea32a364b00e87d3.png" />
</div>
</div>
<p>Are you amazed about the speedup (same solver)?</p>
<p>You <em>should</em> be!</p>
</section>
</section>
<section id="revisiting-the-implementation-lazy-constraint-generation">
<h2>Revisiting the implementation: lazy constraint generation!<a class="headerlink" href="#revisiting-the-implementation-lazy-constraint-generation" title="Link to this heading">#</a></h2>
<p>Adding constraints on a need basis required so far that we repeatedly solved the problem from scratch, each time with a slightly larger model than before.
In fact, some solvers allow the constraints to be added <em>while</em> solving.
And <code class="docutils literal notranslate"><span class="pre">pyomo</span></code> offers ways to use that ability!</p>
<section id="callbacks">
<h3>Callbacks<a class="headerlink" href="#callbacks" title="Link to this heading">#</a></h3>
<p>So far, we extended our model by adding the needed constraints and the solved again.</p>
<p>Some solvers support a more sophisticated way to add constraints while solving.
The mechanism to do so is called a <em>callback</em>: a function that we define and offer to the solver to call while solving the problem.</p>
<p>The solver can do this at different moments.
For us, the moment of interest is when the solver finds a feasible solution: we can check if it satisfies all the not yet defined constraints, and if needed add some new constraints.</p>
<p><code class="docutils literal notranslate"><span class="pre">Pyomo</span></code> supports callbacks for using with <code class="docutils literal notranslate"><span class="pre">gurobi</span></code>, <code class="docutils literal notranslate"><span class="pre">cplex</span></code> and <code class="docutils literal notranslate"><span class="pre">express</span></code>.
These are all commercial solvers, of which the free (community edition) of gurobi is the most generous, allowing for up to 2000 variables and/or constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">gurobipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gurobipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRB</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_callback</span><span class="p">(</span><span class="n">cb_m</span><span class="p">,</span> <span class="n">cb_opt</span><span class="p">,</span> <span class="n">cb_where</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom callback function for the optimization solver.</span>

<span class="sd">    Args:</span>
<span class="sd">        cb_m: The pyomo.ConcreteModel.</span>
<span class="sd">        cb_opt: The optimization solver.</span>
<span class="sd">        cb_where: The callback location.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cb_where</span> <span class="o">==</span> <span class="n">GRB</span><span class="o">.</span><span class="n">Callback</span><span class="o">.</span><span class="n">MIPSOL</span><span class="p">:</span>
        <span class="n">cb_opt</span><span class="o">.</span><span class="n">cbGetSolution</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">cb_m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cb_m</span><span class="o">.</span><span class="n">E</span><span class="p">])</span>
        <span class="n">sub_tours</span> <span class="o">=</span> <span class="n">GetSubTours</span><span class="p">(</span><span class="n">GetAdjacent</span><span class="p">(</span><span class="n">GetSelected</span><span class="p">(</span><span class="n">cb_m</span><span class="p">),</span> <span class="n">cb_m</span><span class="o">.</span><span class="n">I</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="n">sub_tours</span><span class="p">:</span>
                <span class="n">cb_opt</span><span class="o">.</span><span class="n">cbLazy</span><span class="p">(</span>
                    <span class="n">cb_m</span><span class="o">.</span><span class="n">ellim</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span>
                            <span class="n">cb_m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cb_m</span><span class="o">.</span><span class="n">E</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">S</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">SymmetricBasicModel</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">ellim</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConstraintList</span><span class="p">()</span>
<span class="n">PERSISTENT_SOLVER</span><span class="o">.</span><span class="n">set_instance</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">PERSISTENT_SOLVER</span><span class="o">.</span><span class="n">set_gurobi_param</span><span class="p">(</span><span class="s2">&quot;OutputFlag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">PERSISTENT_SOLVER</span><span class="o">.</span><span class="n">set_gurobi_param</span><span class="p">(</span><span class="s2">&quot;PreCrush&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">PERSISTENT_SOLVER</span><span class="o">.</span><span class="n">set_gurobi_param</span><span class="p">(</span><span class="s2">&quot;LazyConstraints&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">PERSISTENT_SOLVER</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">my_callback</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">PERSISTENT_SOLVER</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_tours</span> <span class="o">=</span> <span class="n">GetSubTours</span><span class="p">(</span><span class="n">GetAdjacent</span><span class="p">(</span><span class="n">GetSelected</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span> <span class="o">=</span> <span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">sol</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2b613dc539720c5e27cfd356d3b3b1ed9eec2c279aab272724e6e7aee3d0b450.png" src="../../_images/2b613dc539720c5e27cfd356d3b3b1ed9eec2c279aab272724e6e7aee3d0b450.png" />
</div>
</div>
<p>There is an additional benefit here! While the commercial solver would not solve this instance in  the previous implementation with repeated solves (since the instance soon includes a number of constraints beyond the free tier) it does now, since the additional constraints added <em>while solving</em> don’t count!</p>
</section>
<section id="gray-area">
<h3>Gray area<a class="headerlink" href="#gray-area" title="Link to this heading">#</a></h3>
<p>Defining a callback forces us to adhere to solver specific knowledge.</p>
<p>One may argue that the flexibility offered by <code class="docutils literal notranslate"><span class="pre">pyomo</span></code> is now somewhat lost.</p>
<p>Maybe this is the moment to consider modeling the whole model in the solver’s dialect (<code class="docutils literal notranslate"><span class="pre">gurobipy</span></code> in this case) and bypass the overhead of <code class="docutils literal notranslate"><span class="pre">pyomo</span></code> all together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">SymmetricTSPViaGurobi</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the symmetric traveling Salesman problem using Gurobi.</span>

<span class="sd">    Args:</span>
<span class="sd">        C: Cost matrix (symmetric).</span>
<span class="sd">        trace: Flag to enable/disable output traces.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tour: List of nodes representing the optimal tour.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">),</span> <span class="s2">&quot;cost should be symmetric&quot;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>

    <span class="n">m</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">_I</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_n</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">_E</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_I</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">m</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">addVars</span><span class="p">(</span>
        <span class="n">m</span><span class="o">.</span><span class="n">_E</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="p">{(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_E</span><span class="p">},</span> <span class="n">vtype</span><span class="o">=</span><span class="n">GRB</span><span class="o">.</span><span class="n">BINARY</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span>
    <span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">addConstrs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_I</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">GetSelected</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">subtourelim</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">where</span> <span class="o">==</span> <span class="n">GRB</span><span class="o">.</span><span class="n">Callback</span><span class="o">.</span><span class="n">MIPSOL</span><span class="p">:</span>
            <span class="n">sub_tours</span> <span class="o">=</span> <span class="n">GetSubTours</span><span class="p">(</span>
                <span class="n">GetAdjacent</span><span class="p">(</span><span class="n">GetSelected</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cbGetSolution</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_x</span><span class="p">)),</span> <span class="n">model</span><span class="o">.</span><span class="n">_I</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">tour</span> <span class="ow">in</span> <span class="n">sub_tours</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tour</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">_n</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">cbLazy</span><span class="p">(</span>
                        <span class="n">gp</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tour</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tour</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">Params</span><span class="o">.</span><span class="n">OutputFlag</span> <span class="o">=</span> <span class="n">trace</span>
    <span class="n">m</span><span class="o">.</span><span class="n">Params</span><span class="o">.</span><span class="n">LazyConstraints</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">m</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">subtourelim</span><span class="p">)</span>

    <span class="n">sub_tours</span> <span class="o">=</span> <span class="n">GetSubTours</span><span class="p">(</span><span class="n">GetAdjacent</span><span class="p">(</span><span class="n">GetSelected</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getAttr</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_x</span><span class="p">)),</span> <span class="n">m</span><span class="o">.</span><span class="n">_I</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sub_tours</span>
    <span class="n">tour</span> <span class="o">=</span> <span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tour</span><span class="p">)</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">tour</span>
    <span class="n">tour</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tour</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">m</span><span class="o">.</span><span class="n">printStats</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">tour</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">GurobiSymmetric</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the symmetric traveling salesman problem using Gurobi.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: TSP instance.</span>
<span class="sd">        trace: Flag to enable/disable output traces.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tour: List of nodes representing the optimal tour.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="n">tour</span> <span class="o">=</span> <span class="n">SymmetricTSPViaGurobi</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">I</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_indices_and_reverse_lookup</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tour</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">GurobiSymmetric</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">sol</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8b58c66784b11e17001e4f779e6471cbd3d43cce1c22e529d54bc900454f1482.png" src="../../_images/8b58c66784b11e17001e4f779e6471cbd3d43cce1c22e529d54bc900454f1482.png" />
</div>
</div>
<p>Since the number of variables is <span class="math notranslate nohighlight">\(n(n-1)/2\)</span> dominates the number of explicit constraints <span class="math notranslate nohighlight">\(n\)</span>, the highest <span class="math notranslate nohighlight">\(n\)</span> that fits the community edition is <span class="math notranslate nohighlight">\(n=63\)</span> yielding <span class="math notranslate nohighlight">\(1953\)</span> variables and <span class="math notranslate nohighlight">\(63\)</span> constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">GurobiSymmetric</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">sol</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/05b1b11b6a7c29202c7aa43cc622636f168a1f7babfdea6f2a228968fae6c875.png" src="../../_images/05b1b11b6a7c29202c7aa43cc622636f168a1f7babfdea6f2a228968fae6c875.png" />
</div>
</div>
<p>Very fast, right? Maybe we can try some of the benchmarks now!</p>
</section>
</section>
<section id="famous-benchmark-instances-from-the-internet">
<h2>Famous benchmark instances from the Internet<a class="headerlink" href="#famous-benchmark-instances-from-the-internet" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_tsp_world</span> <span class="o">=</span> <span class="s2">&quot;https://www.math.uwaterloo.ca/tsp/world/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">url_exists</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the given URL exists by sending a GET request and checking the status code.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: URL to check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the URL exists (status code 200), False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ReadTextFromURL</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read text data from a given URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: URL to fetch the text data from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The text data fetched from the URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">NumberOrString</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the given text to an integer, float, or string.</span>

<span class="sd">    Args:</span>
<span class="sd">        text: Text to convert.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Converted value as an integer, float, or string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">LeftPart</span><span class="p">(</span><span class="n">lineWithColon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the left part of a string before the colon.</span>

<span class="sd">    Args:</span>
<span class="sd">        lineWithColon: Input string containing a colon.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Left part of the string before the colon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lineWithColon</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">RightPart</span><span class="p">(</span><span class="n">lineWithColon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the right part of a string after the colon.</span>

<span class="sd">    Args:</span>
<span class="sd">        lineWithColon: Input string containing a colon.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Right part of the string after the colon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">NumberOrString</span><span class="p">(</span><span class="n">lineWithColon</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ParseComment</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the comment string and convert it to a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        comment: Comment string to parse.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing parsed comment information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asList</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">LeftPart</span><span class="p">(</span><span class="n">line</span><span class="p">):</span> <span class="n">RightPart</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">asList</span> <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">}</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">asList</span> <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dispatch the given name to the appropriate function based on a dispatcher dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name to dispatch.</span>
<span class="sd">        *args: Additional positional arguments.</span>
<span class="sd">        **kwargs: Additional keyword arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Result of the dispatched function based on the name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dispatcher</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DIMENSION&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;CAPACITY&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">:</span> <span class="n">ParseComment</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dispatcher</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NumberOrString</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ReadCVRP</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the Capacitated Vehicle Routing Problem (CVRP) instance from the given text.</span>

<span class="sd">    Args:</span>
<span class="sd">        text: Text data containing the CVRP instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary representing the CVRP instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;EOF&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;EOF&quot;</span><span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">LeftPart</span><span class="p">(</span><span class="n">line</span><span class="p">):</span> <span class="n">Dispatch</span><span class="p">(</span><span class="n">LeftPart</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">RightPart</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span>
        <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">line</span>
    <span class="p">}</span>
    <span class="n">idxSections</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;SECTION&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;EOF&quot;</span> <span class="ow">in</span> <span class="n">line</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idxSections</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">NumberOrString</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">idxSections</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">instance</span>


<span class="k">def</span><span class="w"> </span><span class="nf">GetNationalTSP</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="n">url_tsp_world</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch the National TSP instance from the given filename.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: Filename of the National TSP instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary representing the National TSP instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ReadCVRP</span><span class="p">(</span><span class="n">ReadTextFromURL</span><span class="p">(</span><span class="n">world</span> <span class="o">+</span> <span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ReadWorldSummary</span><span class="p">(</span><span class="n">world</span><span class="o">=</span><span class="n">url_tsp_world</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the world summary table from the given URL and return it as a pandas DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        world: URL of the world summary page. Defaults to url_tsp_world.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Pandas DataFrame containing the world summary table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">url_exists</span><span class="p">(</span><span class="n">world</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">world</span><span class="si">}</span><span class="s2">summary.html&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Tour&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))},</span>
        <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">&quot;(\d+)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tsp_world_summary</span> <span class="o">=</span> <span class="n">ReadWorldSummary</span><span class="p">(</span><span class="n">world</span><span class="o">=</span><span class="n">url_tsp_world</span><span class="p">)</span>
<span class="n">tsp_world_summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>Gap</th>
      <th>Bound</th>
      <th>Tour</th>
      <th>Source of Tour</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>wi29</td>
      <td>Optimal</td>
      <td>27603</td>
      <td>27603</td>
      <td>Concorde</td>
      <td>29</td>
    </tr>
    <tr>
      <th>1</th>
      <td>dj38</td>
      <td>Optimal</td>
      <td>6656</td>
      <td>6656</td>
      <td>Concorde</td>
      <td>38</td>
    </tr>
    <tr>
      <th>2</th>
      <td>qa194</td>
      <td>Optimal</td>
      <td>9352</td>
      <td>9352</td>
      <td>Concorde</td>
      <td>194</td>
    </tr>
    <tr>
      <th>3</th>
      <td>uy734</td>
      <td>Optimal</td>
      <td>79114</td>
      <td>79114</td>
      <td>Concorde</td>
      <td>734</td>
    </tr>
    <tr>
      <th>4</th>
      <td>zi929</td>
      <td>Optimal</td>
      <td>95345</td>
      <td>95345</td>
      <td>Concorde</td>
      <td>929</td>
    </tr>
    <tr>
      <th>5</th>
      <td>lu980</td>
      <td>Optimal</td>
      <td>11340</td>
      <td>11340</td>
      <td>Concorde</td>
      <td>980</td>
    </tr>
    <tr>
      <th>6</th>
      <td>rw1621</td>
      <td>Optimal</td>
      <td>26051</td>
      <td>26051</td>
      <td>Concorde</td>
      <td>1621</td>
    </tr>
    <tr>
      <th>7</th>
      <td>mu1979</td>
      <td>Optimal</td>
      <td>86891</td>
      <td>86891</td>
      <td>Concorde</td>
      <td>1979</td>
    </tr>
    <tr>
      <th>8</th>
      <td>nu3496</td>
      <td>Optimal</td>
      <td>96132</td>
      <td>96132</td>
      <td>Concorde</td>
      <td>3496</td>
    </tr>
    <tr>
      <th>9</th>
      <td>ca4663</td>
      <td>Optimal</td>
      <td>1290319</td>
      <td>1290319</td>
      <td>Concorde</td>
      <td>4663</td>
    </tr>
    <tr>
      <th>10</th>
      <td>tz6117</td>
      <td>Optimal</td>
      <td>394718</td>
      <td>394718</td>
      <td>LKH + tmerge</td>
      <td>6117</td>
    </tr>
    <tr>
      <th>11</th>
      <td>eg7146</td>
      <td>Optimal</td>
      <td>172386</td>
      <td>172386</td>
      <td>Keld Helsgaun</td>
      <td>7146</td>
    </tr>
    <tr>
      <th>12</th>
      <td>ym7663</td>
      <td>Optimal</td>
      <td>238314</td>
      <td>238314</td>
      <td>LKH + tmerge</td>
      <td>7663</td>
    </tr>
    <tr>
      <th>13</th>
      <td>pm8079</td>
      <td>Optimal</td>
      <td>114855</td>
      <td>114855</td>
      <td>Yuichi Nagata</td>
      <td>8079</td>
    </tr>
    <tr>
      <th>14</th>
      <td>ei8246</td>
      <td>Optimal</td>
      <td>206171</td>
      <td>206171</td>
      <td>LKH</td>
      <td>8246</td>
    </tr>
    <tr>
      <th>15</th>
      <td>ar9152</td>
      <td>Optimal</td>
      <td>837479</td>
      <td>837479</td>
      <td>Hung Dinh Nguyen</td>
      <td>9152</td>
    </tr>
    <tr>
      <th>16</th>
      <td>ja9847</td>
      <td>Optimal</td>
      <td>491924</td>
      <td>491924</td>
      <td>Keld Helsgaun</td>
      <td>9847</td>
    </tr>
    <tr>
      <th>17</th>
      <td>gr9882</td>
      <td>Optimal</td>
      <td>300899</td>
      <td>300899</td>
      <td>LKH + tmerge</td>
      <td>9882</td>
    </tr>
    <tr>
      <th>18</th>
      <td>kz9976</td>
      <td>Optimal</td>
      <td>1061881</td>
      <td>1061881</td>
      <td>Keld Helsgaun</td>
      <td>9976</td>
    </tr>
    <tr>
      <th>19</th>
      <td>fi10639</td>
      <td>Optimal</td>
      <td>520527</td>
      <td>520527</td>
      <td>LKH + tmerge</td>
      <td>10639</td>
    </tr>
    <tr>
      <th>20</th>
      <td>mo14185</td>
      <td>Optimal</td>
      <td>427377</td>
      <td>427377</td>
      <td>Keld Helsgaun</td>
      <td>14185</td>
    </tr>
    <tr>
      <th>21</th>
      <td>ho14473</td>
      <td>Optimal</td>
      <td>177092</td>
      <td>177092</td>
      <td>Yuichi Nagata</td>
      <td>14473</td>
    </tr>
    <tr>
      <th>22</th>
      <td>it16862</td>
      <td>Optimal</td>
      <td>557315</td>
      <td>557315</td>
      <td>LKH + tmerge</td>
      <td>16862</td>
    </tr>
    <tr>
      <th>23</th>
      <td>vm22775</td>
      <td>Optimal</td>
      <td>569288</td>
      <td>569288</td>
      <td>Keld Helsgaun</td>
      <td>22775</td>
    </tr>
    <tr>
      <th>24</th>
      <td>sw24978</td>
      <td>Optimal</td>
      <td>855597</td>
      <td>855597</td>
      <td>Keld Helsgaun</td>
      <td>24978</td>
    </tr>
    <tr>
      <th>25</th>
      <td>bm33708</td>
      <td>0.031%</td>
      <td>959011</td>
      <td>959289</td>
      <td>Yuichi Nagata</td>
      <td>33708</td>
    </tr>
    <tr>
      <th>26</th>
      <td>ch71009</td>
      <td>0.024%</td>
      <td>4565452</td>
      <td>4566506</td>
      <td>Yuichi Nagata</td>
      <td>71009</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Well, these sizes soon become too large for us!
Definitely for the community edition of <code class="docutils literal notranslate"><span class="pre">gurobi</span></code> (we can go up to the first two).
Actually, this technique becomes impractical soon after that, even when having a <code class="docutils literal notranslate"><span class="pre">gurobi</span></code> license in place.
No mather how good the model is, the problem is still very hard!
The solutions listed above where found by highly researched solvers, specific for the TSP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tsp_world_summary</span><span class="o">.</span><span class="n">Name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">GetNationalTSP</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.tsp&quot;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">GurobiSymmetric</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">show_tsp</span><span class="p">(</span>
        <span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">sol</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1875a3dc123ebd1ef3f3f7fe89a0a82ecc1e49c35cb1dc65f7f68d4161421276.png" src="../../_images/1875a3dc123ebd1ef3f3f7fe89a0a82ecc1e49c35cb1dc65f7f68d4161421276.png" />
<img alt="../../_images/de6cfbe1cb0e166b449468b36908babbc3bb8a1eb1dcdb8208a6c2c6788c71ea.png" src="../../_images/de6cfbe1cb0e166b449468b36908babbc3bb8a1eb1dcdb8208a6c2c6788c71ea.png" />
</div>
</div>
</section>
<section id="beyond-this">
<h2>Beyond this?<a class="headerlink" href="#beyond-this" title="Link to this heading">#</a></h2>
<p>Maybe there are some things that you may need to address related to TSP that are not covered here.</p>
<section id="variants">
<h3>Variants<a class="headerlink" href="#variants" title="Link to this heading">#</a></h3>
<p>Simple variants of the problem, such as not needing to return to the start node (shortest Hamiltonian path or open TSP) of using a given number of routes instead of one (the multiple TSP), are already with your reach.</p>
<p>These variants can be solved by <em>transformations</em> of the instance, or by remodeling.</p>
<p>We will illustrate the transformation approach, and leave the remodeling to you as exercises.</p>
<section id="open-tsp">
<h4>Open TSP<a class="headerlink" href="#open-tsp" title="Link to this heading">#</a></h4>
<p>Suppose (without loss of generality) that you start at node <span class="math notranslate nohighlight">\(0\)</span> and should visit all other nodes, without the need to return to <span class="math notranslate nohighlight">\(0\)</span>.</p>
<p>Then, it is enough to modify your cost matrix <span class="math notranslate nohighlight">\(C\)</span> by making all costs <span class="math notranslate nohighlight">\(c_{i0} = 0\)</span> and solve the corresponding TSP.</p>
<p><em>Note that this modified TSP is asymmetric regardless of the nature of the original instance!</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A simple closure does the trick!
Notice that we index at <em>inner indices</em> for code simplicity now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_cost_matrix_open_at</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="n">open_at</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_modified_cost_matrix</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">C</span><span class="p">[:,</span> <span class="n">open_at</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">C</span>

    <span class="k">return</span> <span class="n">get_modified_cost_matrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_cost_matrix_open_at_0</span> <span class="o">=</span> <span class="n">get_cost_matrix_open_at</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">open_sol</span> <span class="o">=</span> <span class="n">SolveWithDFJ</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">,</span> <span class="n">get_cost_matrix_open_at_0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>266.0 [8, 3, 2, 2, 3, 2]
291.0 [7, 2, 3, 2, 2, 2, 2]
315.0 [5, 2, 4, 3, 3, 3]
319.0 [8, 3, 9]
320.0 [8, 12]
320.0 [6, 2, 12]
321.0 [10, 7, 3]
323.0 [20]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">closed_sol</span> <span class="o">=</span> <span class="n">SolveWithDFJ</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>286.0 [2, 2, 3, 2, 2, 2, 3, 2, 2]
348.0 [3, 2, 2, 5, 3, 3, 2]
366.0 [3, 5, 3, 9]
366.0 [4, 12, 4]
366.0 [4, 12, 4]
370.0 [5, 4, 4, 3, 2, 2]
375.0 [4, 4, 8, 4]
376.0 [4, 12, 4]
378.0 [18, 2]
379.0 [16, 4]
379.0 [8, 12]
379.0 [8, 12]
380.0 [20]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">open_sol</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 8, 19, 2, 12, 20, 5, 9, 17, 11, 3, 18, 10, 4, 14, 16, 15, 7, 13, 6, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">closed_sol</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 13, 7, 15, 16, 14, 6, 4, 10, 18, 3, 11, 17, 9, 5, 20, 12, 2, 19, 8, 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_tsp</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">,</span>
    <span class="n">open_sol</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">get_cost_matrix</span><span class="o">=</span><span class="n">get_cost_matrix_open_at_0</span><span class="p">,</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;return to 1 costs 0&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/06e3bff002df79af54feb9198d34732f8da01eb3a7085770828e9ac5264e9f72.png" src="../../_images/06e3bff002df79af54feb9198d34732f8da01eb3a7085770828e9ac5264e9f72.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_tsp</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">,</span>
    <span class="n">closed_sol</span><span class="p">,</span>
    <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;return to 1 costs as much as leaving from 1&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/335b6522beec0264e1e21c60b86f0dd78f4a45fc7e39fc0bfb8799df140ae793.png" src="../../_images/335b6522beec0264e1e21c60b86f0dd78f4a45fc7e39fc0bfb8799df140ae793.png" />
</div>
</div>
</section>
<section id="multiple-tsp">
<h4>Multiple TSP<a class="headerlink" href="#multiple-tsp" title="Link to this heading">#</a></h4>
<p>Suppose that you start at some node with <span class="math notranslate nohighlight">\(k\)</span> sales persons that should partition the other nodes and return to the starting node.</p>
<p>Then, it is enough to replicate that node into <span class="math notranslate nohighlight">\(k\)</span> replicas, with a prohibitively large cost between all pairs of replicas (to force the sales person to go on a route).</p>
<p><em>Note that this modified TSP stays symmetric if instance given was symmetric!</em></p>
<p>Obviously that you can also combine these extensions!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/16e3eef96883c5c5388108b9a1602e0d2ffedd6b9c8f91556fb13d54d701bf57.png" src="../../_images/16e3eef96883c5c5388108b9a1602e0d2ffedd6b9c8f91556fb13d54d701bf57.png" />
</div>
</div>
<p>For this instance node <span class="math notranslate nohighlight">\(17\)</span> seems to be an ideal candidate for the home base of <span class="math notranslate nohighlight">\(2\)</span> sales persons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">I</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">get_indices_and_reverse_lookup</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">][</span><span class="n">R</span><span class="p">[</span><span class="mi">17</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p>We call the replica <span class="math notranslate nohighlight">\(0\)</span>, since that label was not yet used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="o">+</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;NODE_COORD_SECTION&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span> <span class="o">=</span> <span class="n">SolveWithDFJ</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>268.0 [2, 2, 2, 3, 2, 2, 3, 3, 2]
339.0 [3, 3, 2, 2, 3, 3, 2, 3]
366.0 [13, 4, 4]
366.0 [10, 3, 5, 3]
366.0 [13, 4, 4]
368.0 [13, 5, 3]
372.0 [13, 4, 4]
374.0 [5, 4, 4, 4, 2, 2]
378.0 [19, 2]
378.0 [5, 8, 8]
378.0 [5, 8, 8]
379.0 [17, 4]
380.0 [21]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0d02caadefb89d73dcfa16d3d7e0d0d04acd5b36c4da5b9b6cb99db9a393fcac.png" src="../../_images/0d02caadefb89d73dcfa16d3d7e0d0d04acd5b36c4da5b9b6cb99db9a393fcac.png" />
</div>
</div>
<p>Allowing the salesmen to stay at home leadds to only one leaving and hence to one single route.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_cost_matrix_forbid_these</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">these</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">]):</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">get_indices_and_reverse_lookup</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">R</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">these</span><span class="p">]</span>
    <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">C</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span> <span class="o">=</span> <span class="n">SolveWithDFJ</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">,</span> <span class="n">get_cost_matrix_forbid_these</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">node_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>307.0 [2, 2, 2, 2, 2, 2, 2, 3, 2, 2]
380.0 [13, 3, 2, 3]
392.0 [4, 3, 5, 9]
392.0 [10, 4, 4, 3]
392.0 [13, 4, 4]
394.0 [9, 5, 4, 3]
398.0 [2, 4, 11, 4]
398.0 [13, 4, 4]
400.0 [2, 17, 2]
401.0 [13, 8]
401.0 [13, 8]
402.0 [4, 13, 4]
402.0 [17, 4]
402.0 [19, 2]
403.0 [21]
</pre></div>
</div>
<img alt="../../_images/438374a5e3fa892391939528c4659483485049c4dd41cab78617ebef87f9c448.png" src="../../_images/438374a5e3fa892391939528c4659483485049c4dd41cab78617ebef87f9c448.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 16, 15, 7, 13, 1, 8, 19, 2, 12, 20, 5, 9, 17, 11, 3, 18, 10, 4, 6, 14, 0]
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="portability">
<h2>Portability<a class="headerlink" href="#portability" title="Link to this heading">#</a></h2>
<p>Although we are accustomed to modeling <em>data driven</em> and reflect the nature of the domain being solved in, for instance, the indices of the variables we are now dealing with a problem whose input is, in fact, just a square matrix of costs.</p>
<p>In such “pure” cases is, in fact, better to strive for portable code.</p>
<p>In fact, <code class="docutils literal notranslate"><span class="pre">SymmetricTSPViaGurobi</span></code> is already portable since it takes its data from <code class="docutils literal notranslate"><span class="pre">C</span></code> only.</p>
<p>May you wish, then you can copy and paste the code below for your own use. Please attribute! And remember that some functions are defined above, for reuse.</p>
<p>Note that it is trivial to express the solution in the original indices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">original_solution</span><span class="p">(</span><span class="n">I</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">sol</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">I</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">AsymmetricTSPViaGurobi</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the asymmetric traveling salesman problem using Gurobi.</span>

<span class="sd">    Args:</span>
<span class="sd">        C: Cost matrix.</span>
<span class="sd">        trace: Flag to enable/disable output traces.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tour: List of nodes representing the optimal tour.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>

    <span class="n">m</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">_I</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_n</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">_E</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_I</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_I</span><span class="p">))</span>

    <span class="n">m</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">addVars</span><span class="p">(</span>
        <span class="n">m</span><span class="o">.</span><span class="n">_E</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="p">{(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_E</span><span class="p">},</span> <span class="n">vtype</span><span class="o">=</span><span class="n">GRB</span><span class="o">.</span><span class="n">BINARY</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span>
    <span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">addConstrs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_I</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">addConstrs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_I</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">GetNodeSuccessorFromArcVariables</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">j</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">subtourelim</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">where</span> <span class="o">==</span> <span class="n">GRB</span><span class="o">.</span><span class="n">Callback</span><span class="o">.</span><span class="n">MIPSOL</span><span class="p">:</span>
            <span class="n">cycles</span> <span class="o">=</span> <span class="n">PartitionSuccessorIntoCycles</span><span class="p">(</span>
                <span class="n">GetNodeSuccessorFromArcVariables</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cbGetSolution</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_x</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">_n</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">cbLazy</span><span class="p">(</span>
                        <span class="n">gp</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">)</span>
                        <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">Params</span><span class="o">.</span><span class="n">OutputFlag</span> <span class="o">=</span> <span class="n">trace</span>
    <span class="n">m</span><span class="o">.</span><span class="n">Params</span><span class="o">.</span><span class="n">LazyConstraints</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">m</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">subtourelim</span><span class="p">)</span>

    <span class="n">succ</span> <span class="o">=</span> <span class="n">GetNodeSuccessorFromArcVariables</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">getAttr</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_x</span><span class="p">))</span>
    <span class="n">cycles</span> <span class="o">=</span> <span class="n">PartitionSuccessorIntoCycles</span><span class="p">(</span><span class="n">succ</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cycles</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">cycle</span>

    <span class="n">m</span><span class="o">.</span><span class="n">printStats</span><span class="p">()</span>

    <span class="n">sol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">succ</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">succ</span><span class="p">[</span><span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">:</span>
        <span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">succ</span><span class="p">[</span><span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">sol</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">AsymmetricTSPViaPyomo</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the asymmetric traveling salesman problem using Pyomo.</span>

<span class="sd">    Args:</span>
<span class="sd">        C: Cost matrix.</span>
<span class="sd">        solver: The pyomo.Solver object to solve the model.</span>
<span class="sd">        trace: Flag to enable/disable output traces.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tour: List of nodes representing the optimal tour.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;ATSP&quot;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">I</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">IJ</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span>
    <span class="n">m</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">IJ</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mutable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">IJ</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Cost</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">IJ</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">DepartFromEach</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ArriveAtEach</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ForbidDiagonal</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">m</span><span class="o">.</span><span class="n">cuts</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConstraintList</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="n">GetArcsInSolutionPartitionedInCycles</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ListNodesInSolution</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">SymmetricTSPViaPyomo</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the asymmetric traveling salesman problem using Pyomo.</span>

<span class="sd">    Args:</span>
<span class="sd">        C: Cost matrix.</span>
<span class="sd">        solver: The pyomo.Solver object to solve the model.</span>
<span class="sd">        trace: Flag to enable/disable output traces.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tour: List of nodes representing the optimal tour.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;STSP&quot;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">I</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Binary</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Cost</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">enter_and_leave</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">E</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="n">m</span><span class="o">.</span><span class="n">ellim</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConstraintList</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">sub_tours</span> <span class="o">=</span> <span class="n">GetSubTours</span><span class="p">(</span><span class="n">GetAdjacent</span><span class="p">(</span><span class="n">GetSelected</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">I</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="n">sub_tours</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">ellim</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">pyo</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">E</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">S</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="p">))</span>
                <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">n</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">sub_tours</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">sol</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">generate_tsp</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">get_rounded_euclidean_distances</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="n">I</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_indices_and_reverse_lookup</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">SymmetricTSPViaGurobi</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">original_solution</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">sol</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3ec5911551b875ac5025491cca4cfa3ba3dbb68567dc4406d91f93c21a8837df.png" src="../../_images/3ec5911551b875ac5025491cca4cfa3ba3dbb68567dc4406d91f93c21a8837df.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">AsymmetricTSPViaGurobi</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">original_solution</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">sol</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/96862d775140a7ddc9c09d0a200888ed6658b9003ee16c83a594fdf5e67e35db.png" src="../../_images/96862d775140a7ddc9c09d0a200888ed6658b9003ee16c83a594fdf5e67e35db.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">SymmetricTSPViaPyomo</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">original_solution</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">sol</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a599e67d0739a45b0bbe0f35c7e5f3382153042f93e1e348a8f4f70367f2a159.png" src="../../_images/a599e67d0739a45b0bbe0f35c7e5f3382153042f93e1e348a8f4f70367f2a159.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">pc</span><span class="p">()</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">AsymmetricTSPViaPyomo</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">SOLVER</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">show_tsp</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sol</span><span class="o">=</span><span class="n">original_solution</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">sol</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="n">display_seconds</span><span class="p">(</span><span class="n">pc</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/89c729fa6b7c11c8bdc6ad62a447ab5e471dc59be8f4824a2aaa458dc6e8edf7.png" src="../../_images/89c729fa6b7c11c8bdc6ad62a447ab5e471dc59be8f4824a2aaa458dc6e8edf7.png" />
</div>
</div>
<p>Note that if your instance is symmetric, solving the asymmetric model is much more expensive.</p>
</section>
<section id="larger-models">
<h2>Larger models?<a class="headerlink" href="#larger-models" title="Link to this heading">#</a></h2>
<p>Maybe read <a class="reference external" href="https://www.math.uwaterloo.ca/tsp/book/index.html">the book</a> and write your own TSP solver or just run <a class="reference external" href="https://github.com/jvkersch/pyconcorde">concorde</a>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/04"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="07-forex-arbitrage.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Extra material: Forex Arbitrage</p>
      </div>
    </a>
    <a class="right-next"
       href="09-shortest-path-road-networks.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Extra material: Shortest path problem in real life</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solvers-and-utilities">Solvers and utilities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-format">Data format</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-to-handle-instances-and-solutions">Functions to handle instances and solutions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-impressions">First impressions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-models">The models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-blocks-for-tsp-models">Building blocks for TSP models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-solutions">Examining solutions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experiments">Experiments</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-the-strength-of-the-mtz-models-differ">How does the strength of the MTZ models differ?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-models">Exploring the models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tale-of-two-models">A tale of two models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wait-we-can-solve-dfj-after-all">Wait, we <em>can</em> solve DFJ after all!</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetry">Symmetry</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#revisiting-the-implementation-lazy-constraint-generation">Revisiting the implementation: lazy constraint generation!</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#callbacks">Callbacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gray-area">Gray area</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#famous-benchmark-instances-from-the-internet">Famous benchmark instances from the Internet</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beyond-this">Beyond this?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variants">Variants</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#open-tsp">Open TSP</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-tsp">Multiple TSP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#portability">Portability</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#larger-models">Larger models?</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The MO Book Group
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>