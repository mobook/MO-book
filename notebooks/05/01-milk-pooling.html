
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>5.1 Milk pooling and blending &#8212; Companion code for the book &#34;Hands-On Mathematical Optimization with Python&#34;</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-DVQ7NZ8CYZ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DVQ7NZ8CYZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DVQ7NZ8CYZ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/05/01-milk-pooling';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.2 Ordinary Least Squares (OLS) Regression" href="02-ols-regression.html" />
    <link rel="prev" title="5. Convex Optimization" href="05.00.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/cover.jpg" class="logo__image only-light" alt="Companion code for the book "Hands-On Mathematical Optimization with Python" - Home"/>
    <script>document.write(`<img src="../../_static/cover.jpg" class="logo__image only-dark" alt="Companion code for the book "Hands-On Mathematical Optimization with Python" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Hands-On Mathematical Optimization with Python
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/01.00.html">1. Mathematical Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/01-production-planning.html">1.1 A first production planning problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/02-production-planning-basic.html">1.2 A basic Pyomo model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/03-production-planning-advanced.html">1.3 A data-driven Pyomo Model</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/02.00.html">2. Linear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/01-bim.html">2.1 BIM production planning using linear optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/02-lad-regression.html">2.2 Least Absolute Deviation (LAD) Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/03-mad-portfolio-optimization.html">2.3 Mean Absolute Deviation (MAD) portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/04-bim-maxmin.html">2.4 BIM production for worst case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/05-bim-fractional.html">2.5 BIM production variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/06-bim-dual.html">2.6 Dual of the BIM production problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/07-bim-demand-forecast.html">2.7 BIM production using demand forecasts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/08-L1-regression-wine-quality.html">Extra material: Wine quality prediction with <span class="math notranslate nohighlight">\(L_1\)</span> regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/09-production-facility-worst-case.html">Extra material: Multi-product facility production</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../03/03.00.html">3. Mixed Integer Linear Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03/01-bim-perturbed.html">3.1 BIM production with perturbed data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/02-shift-scheduling.html">3.2 Workforce shift scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/03-recharging-electric-vehicle.html">3.3 Recharging strategy for an electric vehicle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/04-simple-production-model-gdp.html">3.4 Production model using disjunctions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/05-machine-scheduling.html">3.5 Machine Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/06-facility-location.html">3.6 Facility location problem</a></li>


<li class="toctree-l2"><a class="reference internal" href="../03/07-bim-production-revisited.html">3.7 BIM production revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/08-cryptarithms.html">Extra material: Cryptarithms puzzle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/09-strip-packing.html">Extra material: Strip packing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/10-job-shop-scheduling.html">Extra material: Job shop scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03/11-maintenance-planning.html">Extra material: Maintenance planning</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../04/04.00.html">4. Network Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../04/01-dinner-seat-allocation.html">4.1 Dinner seating arrangement</a></li>

<li class="toctree-l2"><a class="reference internal" href="../04/02-mincost-flow.html">4.2 Minimum-Cost Flow Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/03-gasoline-distribution.html">4.3 Gasoline distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/04-exam-room-scheduling.html">4.4 Exam room scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/05-cryptocurrency-arbitrage.html">4.5 Cryptocurrency arbitrage search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/06-power-network.html">Extra material: Energy dispatch problem</a></li>



<li class="toctree-l2"><a class="reference internal" href="../04/07-forex-arbitrage.html">Extra material: Forex Arbitrage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/08-traveling-salesman-problem.html">Extra material: Traveling Salesman Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04/09-shortest-path-road-networks.html">Extra material: Shortest path problem in real life</a></li>


</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="05.00.html">5. Convex Optimization</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">5.1 Milk pooling and blending</a></li>
<li class="toctree-l2"><a class="reference internal" href="02-ols-regression.html">5.2 Ordinary Least Squares (OLS) Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-markowitz-portfolio.html">5.3 Markowitz portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-svm-binary-classification.html">5.4 Support Vector Machines for binary classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-refinery-production.html">Extra material: Refinery production and shadow pricing with CVXPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-cutting-stock.html">Extra Material: Cutting Stock</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../06/06.00.html">6. Conic Optimization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06/01-economic-order-quantity.html">6.1 Economic Order Quantity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/02-kelly-criterion.html">6.2 The Kelly criterion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/03-markowitz-portfolio-revisited.html">6.3 Markowitz portfolio optimization revisited</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/04-building-insulation.html">6.4 Optimal Design of Multilayered Building Insulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/05-svm-conic.html">Extra material: Support Vector Machines with conic optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/06-investment-wheel.html">Extra material: Luenberger’s Investment Wheel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06/07-optimal-growth-portfolios.html">Extra material: Optimal Growth Portfolios with Risk Aversion</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../07/07.00.html">7. Accounting for Uncertainty: Optimization Meets Reality</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07/01-fleet-assignment.html">7.1 Fleet assignment problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07/02-bim-robustness-analysis.html">7.2 Robustness analysis of BIM production plan via simulations</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../08/08.00.html">8. Robust Optimization - Single Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08/01-bim-robust-optimization.html">8.1 Robust BIM microchip production problem</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../09/09.00.html">9. Stochastic Optimization - Single Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09/01-markowitz-portfolio-with-chance-constraint.html">9.1 Markowitz portfolio optimization with chance constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/02-pop-up-shop.html">9.2 Pop-up shop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/03-seafood-distribution-center.html">9.3 Stock optimization for seafood distribution center</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09/04-economic-dispatch.html">9.4 Economic dispatch in renewable energy systems using chance constraints</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../10/10.00.html">10. Two-Stage Problems</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../10/01-aircraft-seat-allocation.html">10.1 Aircraft seat allocation problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/02-two-stage-production-planning.html">10.2 Two-stage production planning using constraint and column generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/03-opf-linear-decision-rule.html">10.3 Optimal power flow problem with recourse actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/04-farmer-problem.html">Extra: The farmer’s problem and its variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10/05-opf-wind-curtailment.html">Extra: Two-stage energy dispatch optimization with wind curtailment</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../appendix/appendix.html">Appendix: Working with Pyomo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../appendix/pyomo-style-guide.html">Pyomo style guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../appendix/functional-programming-pyomo.html">Functional Programming with Pyomo</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/mobook/MO-book/blob/main/notebooks/05/01-milk-pooling.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mobook/MO-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mobook/MO-book/issues/new?title=Issue%20on%20page%20%2Fnotebooks/05/01-milk-pooling.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/05/01-milk-pooling.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>5.1 Milk pooling and blending</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble-install-pyomo-and-a-solver">Preamble: Install Pyomo and a solver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-description-pooling-milk-for-wholesale-blending-and-distribution">Problem description: Pooling milk for wholesale blending and distribution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-business-as-usual">Option 1. Business as usual</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-buy-an-additional-truck">Option 2. Buy an additional truck</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-pool-delivery-from-remote-suppliers">Option 3. Pool delivery from remote suppliers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-problem">Pooling problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-are-bilinear-problems-hard">Why are bilinear problems hard?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convex-approximation">Convex Approximation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-optimization-nlo-solution-with-ipopt">Nonlinear Optimization (NLO) solution with ipopt</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concluding-remarks">Concluding Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliographic-notes">Bibliographic Notes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="milk-pooling-and-blending">
<span id="index-6"></span><span id="index-5"></span><span id="index-4"></span><span id="index-3"></span><span id="index-2"></span><span id="index-1"></span><span id="index-0"></span><h1>5.1 Milk pooling and blending<a class="headerlink" href="#milk-pooling-and-blending" title="Link to this heading">#</a></h1>
<p>Pooling and blending operations involve the “pooling” of various streams to create intermediate mixtures that are subsequently blended with other streams to meet final product specifications. These operations are common to the chemical processing and petroleum sectors where limited tankage may be available, or when it is necessary to transport materials by train, truck, or pipeline to remote blending terminals. Similar applications arise in agriculture, food, mining, wastewater treatment, and other industries.</p>
<p>This notebook considers a simple example of a wholesale milk distributor to show how <strong>non-convexity</strong> arises in the optimization of pooling and blending operations. Non-convexity is due to presence of <strong>bilinear</strong> terms that are the product of two decision variables where one is a scale-dependent <strong>extensive</strong> quantity measuring the amount or flow of a product, and the other is scale-independent <strong>intensive</strong> quantity such as product composition. The notebook then shows how to develop and solve a convex approximation of the problem, and finally demonstrates solution the use of <code class="docutils literal notranslate"><span class="pre">ipopt</span></code>, a solver specifically designed to find global solutions to nonlinear optimization (NLO) problems.</p>
<section id="preamble-install-pyomo-and-a-solver">
<h2>Preamble: Install Pyomo and a solver<a class="headerlink" href="#preamble-install-pyomo-and-a-solver" title="Link to this heading">#</a></h2>
<p>This cell selects and verifies a global SOLVER for the notebook. If run on Google Colab, the cell installs Pyomo and ipopt, then sets SOLVER to use the ipopt solver via the Pyomo SolverFactory. It then verifies that SOLVER is available.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>

<span class="n">solver_LO</span> <span class="o">=</span> <span class="s2">&quot;appsi_highs&quot;</span>

<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">%</span><span class="k">pip</span> install idaes-pse --pre &gt;/dev/null 2&gt;/dev/null
    <span class="o">%</span><span class="k">pip</span> install highspy &gt;/dev/null 2&gt;/dev/null
    <span class="o">!</span>idaes<span class="w"> </span>get-extensions<span class="w"> </span>--to<span class="w"> </span>./bin<span class="w"> </span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;:bin&#39;</span>
    
<span class="n">solver_NLO</span> <span class="o">=</span> <span class="s2">&quot;ipopt&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span> 

<span class="n">SOLVER_LO</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver_LO</span><span class="p">)</span>
<span class="n">SOLVER_NLO</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver_NLO</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">SOLVER_LO</span><span class="o">.</span><span class="n">available</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Solver </span><span class="si">{</span><span class="n">solver_LO</span><span class="si">}</span><span class="s2"> is not available.&quot;</span>
<span class="k">assert</span> <span class="n">SOLVER_NLO</span><span class="o">.</span><span class="n">available</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Solver </span><span class="si">{</span><span class="n">solver_NLO</span><span class="si">}</span><span class="s2"> is not available.&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="problem-description-pooling-milk-for-wholesale-blending-and-distribution">
<h2>Problem description: Pooling milk for wholesale blending and distribution<a class="headerlink" href="#problem-description-pooling-milk-for-wholesale-blending-and-distribution" title="Link to this heading">#</a></h2>
<p>A bulk distributor supplies custom milk blends to several customers. Each customer has specified a minimum fat content, a maximum price, and a maximum amount of milk they wish to buy. The distributor sources raw milk from local farms. Each farm produces a milk with a known fat content and cost.</p>
<p>The distributor has recently identified more affordable sources raw milk from some remote farms. These remote farms produce milk grades that can be blended with milk from local farms. However, the distributor only has one truck with a single tank available to transport milk from the remote farms. As a result, milk from the remote farms must be mixed in the tank before being transported to the blending station. This creates a “pool” of uniform composition which to be blended with local milk to meet the customer’s requirements.</p>
<p>The process is shown in the following diagram. The fat content and cost of raw milk is given for each farm. For each customer, data is provided for the required milk fat content, price, and the maximum demand. Arrows indicate pooling and blending of raw milk supplies. Each arrow is labeled with the amount of raw milk.</p>
<p><img alt="" src="../../_images/milk-pooling.png" /></p>
<p>What should the distributor do?</p>
<ul class="simple">
<li><p>Option 1. Do nothing and continue operating the business as usual with local suppliers.</p></li>
<li><p>Option 2. Buy a second truck to transport raw milk from the remote farms to the blending facility without pooling.</p></li>
<li><p>Option 3. Pool raw milk from the remote farms into a single truck for transport to the blending facility.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">customers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;Customer 1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_fat&quot;</span><span class="p">:</span> <span class="mf">0.045</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">52.0</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">:</span> <span class="mf">6000.0</span><span class="p">},</span>
        <span class="s2">&quot;Customer 2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_fat&quot;</span><span class="p">:</span> <span class="mf">0.030</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">48.0</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">:</span> <span class="mf">2500.0</span><span class="p">},</span>
        <span class="s2">&quot;Customer 3&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_fat&quot;</span><span class="p">:</span> <span class="mf">0.040</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">:</span> <span class="mf">4000.0</span><span class="p">},</span>
    <span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">suppliers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;Farm A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fat&quot;</span><span class="p">:</span> <span class="mf">0.045</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;local&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Farm B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fat&quot;</span><span class="p">:</span> <span class="mf">0.030</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">42.0</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;local&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Farm C&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fat&quot;</span><span class="p">:</span> <span class="mf">0.033</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">37.0</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;remote&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Farm D&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fat&quot;</span><span class="p">:</span> <span class="mf">0.050</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;remote&quot;</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">local_suppliers</span> <span class="o">=</span> <span class="n">suppliers</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">]</span>
<span class="n">remote_suppliers</span> <span class="o">=</span> <span class="n">suppliers</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;remote&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Customers&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">customers</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Suppliers&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">suppliers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Customers
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min_fat</th>
      <th>price</th>
      <th>demand</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Customer 1</th>
      <td>0.045</td>
      <td>52.0</td>
      <td>6000.0</td>
    </tr>
    <tr>
      <th>Customer 2</th>
      <td>0.030</td>
      <td>48.0</td>
      <td>2500.0</td>
    </tr>
    <tr>
      <th>Customer 3</th>
      <td>0.040</td>
      <td>50.0</td>
      <td>4000.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Suppliers
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fat</th>
      <th>cost</th>
      <th>location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Farm A</th>
      <td>0.045</td>
      <td>45.0</td>
      <td>local</td>
    </tr>
    <tr>
      <th>Farm B</th>
      <td>0.03</td>
      <td>42.0</td>
      <td>local</td>
    </tr>
    <tr>
      <th>Farm C</th>
      <td>0.033</td>
      <td>37.0</td>
      <td>remote</td>
    </tr>
    <tr>
      <th>Farm D</th>
      <td>0.05</td>
      <td>45.0</td>
      <td>remote</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="option-1-business-as-usual">
<h2>Option 1. Business as usual<a class="headerlink" href="#option-1-business-as-usual" title="Link to this heading">#</a></h2>
<p>The normal business of the milk distributor is to blend supplies from local farms to meet customer requirements. Let <span class="math notranslate nohighlight">\(L = \{ A, B \}\)</span> designate the set of local suppliers, and let <span class="math notranslate nohighlight">\(C = \{1,2,3\}\)</span> designate the set of customers. Decision variable <span class="math notranslate nohighlight">\(z_{l, c}\)</span> is the amount of milk from local supplier <span class="math notranslate nohighlight">\(l\in L\)</span> that is mixed into the blend sold to customer <span class="math notranslate nohighlight">\(c\in C\)</span>.</p>
<p>The distributor’s objectives is to maximize profit</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\text{profit} &amp; = \sum_{(l, c)\ \in\ L \times C} (\text{price}_c - \text{cost}_l) z_{l,c}
\end{align*}
\]</div>
<p>where <span class="math notranslate nohighlight">\((l, c)\ \in\ L\times C\)</span> indicates a summation over the cross-product of two sets. Each term, <span class="math notranslate nohighlight">\((\text{price}_c - \text{cost}_l)\)</span>, is the net profit of including one unit of raw milk from supplier <span class="math notranslate nohighlight">\(l\in L\)</span> in the blend delivered to customer <span class="math notranslate nohighlight">\(c\in C\)</span>.</p>
<p>The amount of milk delivered to each customer <span class="math notranslate nohighlight">\(c\in C\)</span> can not exceed the customer demand.</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\sum_{l\in L} z_{l, c} &amp; \leq \text{demand}_{c} &amp; \forall c\in C
\end{align*}
\]</div>
<p>Let <span class="math notranslate nohighlight">\(\text{fat}_l\)</span> denote the fat content of the raw milk produced by farm <span class="math notranslate nohighlight">\(l\)</span>, and let <span class="math notranslate nohighlight">\(\text{fat}^{\min}_c\)</span> denote the minimum fat content required by customer <span class="math notranslate nohighlight">\(c\)</span>, respectively. Assuming linear blending, the model becomes</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\sum_{(l,c)\ \in\ L \times C} \text{fat}_{l} \cdot z_{l,c} &amp; \geq \text{fat}^{\min}_{c} \sum_{l\in L} z_{l, c} &amp; \forall c \in C
\end{align*}
\]</div>
<p>This is a standard linear blending problem that can be solved by linear optimization (LO).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;Milk pooling v1&quot;</span><span class="p">)</span>

<span class="c1"># define sources and customers</span>
<span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">m</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">customers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># define local -&gt; customer flowrates</span>
<span class="n">m</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>


<span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
    <span class="p">)</span>


<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">]</span>


<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fat_content</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
        <span class="o">&gt;=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;min_fat&quot;</span><span class="p">]</span>
    <span class="p">)</span>


<span class="n">SOLVER_LO</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Profit = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">](),</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;supplier&quot;</span><span class="p">,</span> <span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;supplier&quot;</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s2">&quot;Total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s2">&quot;fat content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]()</span> <span class="o">*</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
    <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
<span class="p">]</span>
<span class="n">Z</span><span class="p">[</span><span class="s2">&quot;min_fat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">customers</span><span class="p">[</span><span class="s2">&quot;min_fat&quot;</span><span class="p">]</span>
<span class="n">display</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Profit = 81000.00
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left"></th>
      <th>Total</th>
      <th>fat content</th>
      <th>min_fat</th>
    </tr>
    <tr>
      <th>supplier</th>
      <th>Farm A</th>
      <th>Farm B</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
    <tr>
      <th>customer</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Customer 1</th>
      <td>6000.0</td>
      <td>0.0</td>
      <td>6000.0</td>
      <td>0.045</td>
      <td>0.045</td>
    </tr>
    <tr>
      <th>Customer 2</th>
      <td>0.0</td>
      <td>2500.0</td>
      <td>2500.0</td>
      <td>0.030</td>
      <td>0.030</td>
    </tr>
    <tr>
      <th>Customer 3</th>
      <td>2666.7</td>
      <td>1333.3</td>
      <td>4000.0</td>
      <td>0.040</td>
      <td>0.040</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="option-2-buy-an-additional-truck">
<h2>Option 2. Buy an additional truck<a class="headerlink" href="#option-2-buy-an-additional-truck" title="Link to this heading">#</a></h2>
<p>As shown before, the distributor can earn a profit of 81,000 using only local suppliers. It is possible to earn a higher profit by also sourcing raw milk from the remote suppliers?</p>
<p>Before considering pooling, the distributor may wish to know the maximum profit possible if raw milk from the remote suppliers could be blended just like local suppliers. This would require acquiring and operating a separate transport truck for each remote supplier, and is worth knowing if the additional profit would justify the additional expense.</p>
<p>The linear optimization model presented Option 1 extends the to include both local and remote suppliers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;Milk pooling v2 (additional truck)&quot;</span><span class="p">)</span>

<span class="c1"># define sources and customers</span>
<span class="n">m</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">m</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">customers</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># define local -&gt; customer flowrates</span>
<span class="n">m</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">S</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>


<span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">S</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
    <span class="p">)</span>


<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">]</span>


<span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">quality</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
        <span class="o">&gt;=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="o">*</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;min_fat&quot;</span><span class="p">]</span>
    <span class="p">)</span>


<span class="n">SOLVER_LO</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Profit = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">](),</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">S</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;supplier&quot;</span><span class="p">,</span> <span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;customer&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;supplier&quot;</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s2">&quot;Total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Z</span><span class="p">[</span><span class="s2">&quot;fat content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]()</span> <span class="o">*</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
    <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
<span class="p">]</span>
<span class="n">Z</span><span class="p">[</span><span class="s2">&quot;min_fat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">customers</span><span class="p">[</span><span class="s2">&quot;min_fat&quot;</span><span class="p">]</span>
<span class="n">display</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Profit = 122441.18
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="4" halign="left"></th>
      <th>Total</th>
      <th>fat content</th>
      <th>min_fat</th>
    </tr>
    <tr>
      <th>supplier</th>
      <th>Farm A</th>
      <th>Farm B</th>
      <th>Farm C</th>
      <th>Farm D</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
    <tr>
      <th>customer</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Customer 1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>1764.7</td>
      <td>4235.3</td>
      <td>6000.0</td>
      <td>0.045</td>
      <td>0.045</td>
    </tr>
    <tr>
      <th>Customer 2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>2500.0</td>
      <td>0.0</td>
      <td>2500.0</td>
      <td>0.033</td>
      <td>0.030</td>
    </tr>
    <tr>
      <th>Customer 3</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>2352.9</td>
      <td>1647.1</td>
      <td>4000.0</td>
      <td>0.040</td>
      <td>0.040</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Sourcing raw milk from the remote farms significantly increases profits. This blending, however, requires at least two trucks to keep the sources of milk from the remote suppliers separated until they reach the blending facility. Note that the local suppliers are completely replaced by the lower cost remote suppliers, even to the extent of providing “product giveaway” by surpassing the minimum requirements of Customer 2.</p>
</section>
<section id="option-3-pool-delivery-from-remote-suppliers">
<h2>Option 3. Pool delivery from remote suppliers<a class="headerlink" href="#option-3-pool-delivery-from-remote-suppliers" title="Link to this heading">#</a></h2>
<p>Comparing Option 1 with Option 2 shows there is significantly more profit to be earned by purchasing raw milk from the remote suppliers. But that option requires an additional truck to keep the supplies separated during transport.</p>
<p>Because only one truck with a single tank is available for transport from the remote farms, the pool and blending problem is to combine purchases from the remote suppliers into a single pool of uniform composition, transport that pool to the distribution facility, then blend with raw milk from local suppliers to meet individual customer requirements. Compared to option 2, the profit potential may be reduced due to pooling, but without the need to acquire an additional truck.</p>
<section id="pooling-problem">
<h3>Pooling problem<a class="headerlink" href="#pooling-problem" title="Link to this heading">#</a></h3>
<p>There are several mathematical formulations of pooling problem in the academic literature. The formulation used here is called the <strong><span class="math notranslate nohighlight">\(p\)</span>-parameterization</strong> where the pool composition represents a new decision variable <span class="math notranslate nohighlight">\(p\)</span>. The other additional decision variables are <span class="math notranslate nohighlight">\(x_r\)</span> referring to the amount of raw milk purchased from remote supplier <span class="math notranslate nohighlight">\(r\in R\)</span>, and <span class="math notranslate nohighlight">\(y_c\)</span> which is the amount of the pooled milk included in the blend delivered to customer <span class="math notranslate nohighlight">\(c\in C\)</span>.</p>
<p>The profit objective is the difference between the income received for selling blended products and the cost of purchasing raw milk from local and remote suppliers.</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\text{Profit} &amp; = \sum_{(l,c)\ \in\ L \times C} (\text{price}_c - \text{cost}_l)\ z_{l,c}
+ \sum_{c\in C} \text{price}_c y_{c} - \sum_{r\in R} \text{cost}_r x_{r}
\end{align*}
\]</div>
<p>The product delivered to each customer from local farms and the pool can not exceed demand.</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\sum_{l\in L} z_{l, c} + y_{c} &amp; \leq \text{demand}_{c} &amp; \forall c\in C
\end{align*}
\]</div>
<p>Purchases from the remote farms and the amounts delivered to customers from the pool must balance.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\sum_{r\in R}x_{r} &amp; = \sum_{c\in C} y_{c} \\
\end{align*}
\end{split}\]</div>
<p>The average milk fat composition of the pool, <span class="math notranslate nohighlight">\(p\)</span>, must satisfy an overall balance on milk fat entering the pool from the remote farms and the milk fat delivered to customers.</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\sum_{r\in R}\text{fat}_{r}\cdot x_{r}  &amp; = \underbrace{p \sum_{c\in C} y_{c}}_{\text{bilinear}}
\end{align*}
\]</div>
<p>Finally, the milk fat required by each customer <span class="math notranslate nohighlight">\(c\in C\)</span> satisfies a blending constraint.</p>
<div class="math notranslate nohighlight">
\[
\begin{align*}
\underbrace{p y_{c}}_{\text{bilinear}}  + \sum_{(l,c)\ \in\ L \times C} \text{fat}_{l}\cdot z_{l,c}
&amp; \geq \text{fat}^{\min}_c \ (\sum_{l\in L} z_{l, c} + y_{c})
&amp; \forall c \in C
\end{align*}
\]</div>
<p>The last two constraints include <strong>bilinear</strong> terms which are the product of the decision variable <span class="math notranslate nohighlight">\(p\)</span> with decision variables <span class="math notranslate nohighlight">\(y_c\)</span> for all <span class="math notranslate nohighlight">\(c\in C\)</span>.</p>
<p>Summarizing, the <strong>blending and pooling problem</strong> is to find a solution to maximize profit, where</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\max \quad &amp; \sum_{(l,c)\ \in\ L \times C} (\text{price}_c - \text{cost}_l)\ z_{l,c}
+ \sum_{c\in C} \text{price}_c y_{c} - \sum_{r\in R} \text{cost}_r x_{r} \\
\text{s.t.}\quad 
&amp; \sum_{l\in L} z_{l, c} + y_{c} \leq \text{demand}_{c} &amp; \forall c\in C \\
&amp; \sum_{r\in R}x_{r} = \sum_{c\in C} y_{c} \\
&amp; \underbrace{p y_{c}}_{\text{bilinear}}  + \sum_{(l,c)\ \in\ L \times C} \text{fat}_{l}\cdot z_{l,c} \geq \text{fat}^{\min}_c\ (\sum_{l\in L} z_{l, c} + y_{c}) &amp; \forall c \in C \\
&amp; \sum_{r\in R}\text{fat}_{r}\cdot x_{r} = \underbrace{p \sum_{c\in C} y_{c}}_{\text{bilinear}} \\
&amp; p, x_r, y_c, z_{l, c} \geq 0 &amp; \forall r\in R, c\in C, l\in L. 
\end{align*}
\end{split}\]</div>
<p>Before attempting a solution to this problem, let us first consider the implications of the bilinear terms.</p>
</section>
<section id="why-are-bilinear-problems-hard">
<h3>Why are bilinear problems hard?<a class="headerlink" href="#why-are-bilinear-problems-hard" title="Link to this heading">#</a></h3>
<p>Bilinearity has a profound consequence on the nature of the optimization problem. To explore this, we treat <span class="math notranslate nohighlight">\(p\)</span> as a parameter and repeatedly solve the resulting linear problem for different values of <span class="math notranslate nohighlight">\(p\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">milk_pooling_bilinear</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;Milk pooling v3 (Bilinear formulation)&quot;</span><span class="p">)</span>

    <span class="c1"># define sources</span>
    <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">m</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;remote&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># define customers</span>
    <span class="n">m</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">customers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># define flowrates</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">+</span><span class="nb">sum</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
            <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">*</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">customer_demand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pool_balance</span><span class="p">(</span>
        <span class="n">m</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pool_quality</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span>
        <span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">customer_quality</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span>
        <span class="p">)</span> <span class="o">&gt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;min_fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">f_plot</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_plot</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">milk_pooling_bilinear</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">SOLVER_LO</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">f_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">())</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_plot</span><span class="p">,</span> <span class="n">f_plot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pool composition p&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Profit&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/31f0a1a2e4526eab818c4c24b4056b6dc13d2828ef888902fd340b14fe0080fd.png" src="../../_images/31f0a1a2e4526eab818c4c24b4056b6dc13d2828ef888902fd340b14fe0080fd.png" />
</div>
</div>
<p>In contrast to linear or other convex optimization problems, the objective function for this <strong>bilinear optimization problem is a non-convex function of a decision variable</strong> <span class="math notranslate nohighlight">\(p\)</span> denoting the composition of the blending pool. In fact, when profit is plotted as a function of <span class="math notranslate nohighlight">\(p\)</span>, there are three local maxima separated by two local minima.</p>
</section>
<section id="convex-approximation">
<h3>Convex Approximation<a class="headerlink" href="#convex-approximation" title="Link to this heading">#</a></h3>
<p>The cause of the non-convexity in milk pooling problem are thee bilinear terms <span class="math notranslate nohighlight">\(p y_c\)</span> for all <span class="math notranslate nohighlight">\(c\in C\)</span> that appear in the constraints. A linear approximation can be obtained by introducing decision variables <span class="math notranslate nohighlight">\(w_c\)</span> to take the place of the bilinear terms <span class="math notranslate nohighlight">\(p y_c\)</span> in the model expressions. The result is a new, but incomplete, linear optimization problem</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\max\ \text{Profit} = &amp; \sum_{(l,c)\ \in\ L \times C} (\text{price}_c - \text{cost}_l)\ z_{l,c}
+ \sum_{c\in C} \text{price}_c y_{c} - \sum_{r\in R} \text{cost}_r x_{r} \\
\text{s.t.}\qquad &amp; \sum_{l\in L} z_{l, c} + y_{c} \leq \text{demand}_{c} &amp; \forall c\in C \\
&amp; \sum_{r\in R}x_{r} = \sum_{c\in C} y_{c} \\
&amp; w_c + \sum_{(l,c)\ \in\ L \times C} \text{fat}_{l}\ z_{l,c} \geq \text{fat}^{\min}_c \ (\sum_{l\in L} z_{l, c} + y_{c}) &amp; \forall c \in C \\
&amp; \sum_{r\in R}\text{fat}_{r}\ x_{r} = \underbrace{p \sum_{c\in C} y_{c}}_{\text{bilinear}} \\
&amp; w_c, x_r, y_c, z_{l, c} \geq 0 &amp; \forall r\in R, c\in C, l\in L 
\end{align*}
\end{split}\]</div>
<p>Just adding additional variables isn’t enough. Also needed are constraints that cause <span class="math notranslate nohighlight">\(w_c\)</span> to have close to or equal to <span class="math notranslate nohighlight">\(p y_c\)</span>, that is <span class="math notranslate nohighlight">\(w_c \approx p y_c\)</span> for all <span class="math notranslate nohighlight">\(c\in C\)</span>. If so, then this process produces a convex approximation to the original problem. Because the approximation relaxes the original constraints, a solution to the convex approximation will produced an over-estimate the potential profit.</p>
<p>From the problem formulation, the values of <span class="math notranslate nohighlight">\(y_c\)</span> are bounded between 0 and demand of customer <span class="math notranslate nohighlight">\(c\)</span>, and the value of <span class="math notranslate nohighlight">\(p\)</span> is bounded between the minimum and maximum milk fat concentrations of the remote farms.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
0 \leq\ &amp; y_c \leq \text{demand}_c\ &amp; \forall c\in C \\
\min_{r\in R} \text{conc}_r \leq\ &amp; p \leq \max_{r\in R} \text{conc}_r \\
\end{align*}
\end{split}\]</div>
<p>Representing the bounds on <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(y_c\)</span> as</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
\underline{p} &amp; \leq p \leq \bar{p} \\
\underline{y}_c &amp; \leq y_c \leq \bar{y}_c &amp; \forall c\in C 
\end{align*}
\end{split}\]</div>
<p>the McCormick envelope on <span class="math notranslate nohighlight">\(w_c\)</span> is given by a system of four inequalities. For each <span class="math notranslate nohighlight">\(c\in C\)</span>,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
w_c &amp; \geq \underline{y}_c p + \underline{p} y_c - \underline{p}\underline{y}_c \\
w_c &amp; \geq \bar{y}_c p + \bar{p} y_c - \bar{p}\bar{y}_c \\
w_c &amp; \leq \bar{y}_c p + \underline{p} y_c - \bar{p}\underline{y}_c \\
w_c &amp; \leq \underline{y}_c p + \bar{p} y_c - \underline{p}\bar{y}_c \\
\end{align*}
\end{split}\]</div>
<p>The following cell implements these constraint in Pyomo. The features to note are:</p>
<ul class="simple">
<li><p>Use of a rule to specify bounds on the decision variables <code class="docutils literal notranslate"><span class="pre">m.y[c]</span></code>.</p></li>
<li><p>Creating a new decision variable <code class="docutils literal notranslate"><span class="pre">m.p</span></code> with bounds.</p></li>
<li><p>Creating a new set of decision variables <code class="docutils literal notranslate"><span class="pre">m.w[c]</span></code> to replace the bilinear terms.</p></li>
<li><p>An indexed Pyomo <code class="docutils literal notranslate"><span class="pre">Block</span></code> to bound <code class="docutils literal notranslate"><span class="pre">m.w[c]</span></code> using McCormick envelopes.</p></li>
</ul>
<p>The result of these operations is a linear model that will provide an upper bound on the profit. Hopefully the resulting solution and bound will be a close enough approximation to be useful.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">milk_pooling_convex</span><span class="p">():</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;Milk pooling v3 (Convex approximation)&quot;</span><span class="p">)</span>

    <span class="c1"># define sources</span>
    <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">m</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;remote&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># define customers</span>
    <span class="n">m</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">customers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># define flowrates</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">]))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="c1"># composition of the pool</span>
    <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="c1"># w[c] to replace bilinear terms p * y[c]</span>
    <span class="n">m</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">+</span><span class="nb">sum</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
            <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">*</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># create a block of constraints for every customer</span>
    <span class="nd">@m</span><span class="o">.</span><span class="n">Block</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mccormick</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="o">&gt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">lower</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">lower</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span>
        <span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">hh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="o">&gt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">upper</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">upper</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span>
        <span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">lh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">lower</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">lower</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span>
        <span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">hl</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">upper</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">upper</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span>
        <span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">customer_demand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pool_balance</span><span class="p">(</span>
        <span class="n">m</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pool_quality</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
        <span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">customer_quality</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span>
        <span class="p">)</span> <span class="o">&gt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;min_fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="n">SOLVER_LO</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">report_solution</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="c1"># Supplier report</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
            <span class="n">S</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;Pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]()</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">S</span><span class="p">[</span><span class="s2">&quot;Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="s2">&quot;Pool&quot;</span><span class="p">]</span>
    <span class="n">S</span><span class="p">[</span><span class="s2">&quot;Expense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="s2">&quot;Amount&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span>

    <span class="c1"># Customer report</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">customers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">:</span>
            <span class="n">C</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
        <span class="n">C</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]()</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">C</span><span class="p">[</span><span class="s2">&quot;Amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="s2">&quot;Pool&quot;</span><span class="p">]</span>
    <span class="n">C</span><span class="p">[</span><span class="s2">&quot;fat delivered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="s2">&quot;Pool&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="p">()</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">C</span><span class="p">[</span><span class="s2">&quot;Amount&quot;</span><span class="p">]</span>
    <span class="n">C</span><span class="p">[</span><span class="s2">&quot;Income&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="s2">&quot;Amount&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pool composition = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">p</span><span class="p">()</span><span class="si">:</span><span class="s2">5.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profit = </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">profit</span><span class="p">()</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Supplier Report</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Customer Report</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>


<span class="n">m_convex</span> <span class="o">=</span> <span class="n">milk_pooling_convex</span><span class="p">()</span>
<span class="n">report_solution</span><span class="p">(</span><span class="n">m_convex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Milk pooling v3 (Convex approximation)&#39;

Pool composition = 0.0400
Profit = 111411.76

Supplier Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fat</th>
      <th>cost</th>
      <th>location</th>
      <th>Customer 1</th>
      <th>Customer 2</th>
      <th>Customer 3</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>Expense</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Farm A</th>
      <td>0.045</td>
      <td>45.0</td>
      <td>local</td>
      <td>2500.0</td>
      <td>0.0000</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>2500.0000</td>
      <td>112500.0000</td>
    </tr>
    <tr>
      <th>Farm B</th>
      <td>0.030</td>
      <td>42.0</td>
      <td>local</td>
      <td>0.0</td>
      <td>1029.4118</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>1029.4118</td>
      <td>43235.2941</td>
    </tr>
    <tr>
      <th>Farm C</th>
      <td>0.033</td>
      <td>37.0</td>
      <td>remote</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>0.0</td>
      <td>4852.9412</td>
      <td>4852.9412</td>
      <td>179558.8235</td>
    </tr>
    <tr>
      <th>Farm D</th>
      <td>0.050</td>
      <td>45.0</td>
      <td>remote</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>0.0</td>
      <td>4117.6471</td>
      <td>4117.6471</td>
      <td>185294.1176</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Customer Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min_fat</th>
      <th>price</th>
      <th>demand</th>
      <th>Farm A</th>
      <th>Farm B</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>fat delivered</th>
      <th>Income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Customer 1</th>
      <td>0.045</td>
      <td>52.0</td>
      <td>6000.0</td>
      <td>2500.0</td>
      <td>0.0000</td>
      <td>3500.0000</td>
      <td>6000.0</td>
      <td>0.0421</td>
      <td>312000.0</td>
    </tr>
    <tr>
      <th>Customer 2</th>
      <td>0.030</td>
      <td>48.0</td>
      <td>2500.0</td>
      <td>0.0</td>
      <td>1029.4118</td>
      <td>1470.5882</td>
      <td>2500.0</td>
      <td>0.0359</td>
      <td>120000.0</td>
    </tr>
    <tr>
      <th>Customer 3</th>
      <td>0.040</td>
      <td>50.0</td>
      <td>4000.0</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>4000.0000</td>
      <td>4000.0</td>
      <td>0.0400</td>
      <td>200000.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The convex approximation of the milk pooling model estimates an upper bound on profit of 111,412 for a pool composition <span class="math notranslate nohighlight">\(p = 0.040\)</span>. The plot below compares this solution to what was found by in an exhaustive search over values of <span class="math notranslate nohighlight">\(p\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_plot</span><span class="p">,</span> <span class="n">f_plot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pool composition p&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Profit&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_convex</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;convex approximation&quot;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_convex</span><span class="o">.</span><span class="n">profit</span><span class="p">()),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.036</span><span class="p">,</span> <span class="mi">106000</span><span class="p">),</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2954440490d02b4f7046ec50b24fb1f016d0c824ac9d7b7d283d55561497f139.png" src="../../_images/2954440490d02b4f7046ec50b24fb1f016d0c824ac9d7b7d283d55561497f139.png" />
</div>
</div>
<p>As this stage the calculations find the maximum profit for a given value of <span class="math notranslate nohighlight">\(p\)</span>. The challenge, of course, is that the optimal value of <span class="math notranslate nohighlight">\(p\)</span> is unknown. The following cell computes profits over a range of <span class="math notranslate nohighlight">\(p\)</span>.</p>
<p>The convex approximation is clearly misses the market in the estimate of profit and pool composition <span class="math notranslate nohighlight">\(p\)</span>. Without the benefit of the full scan of profit as a function of <span class="math notranslate nohighlight">\(p\)</span>, the only check on the profit estimate would be to compute the solution to model for the reported value of <span class="math notranslate nohighlight">\(p\)</span>. This is done below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_est</span> <span class="o">=</span> <span class="n">milk_pooling_bilinear</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">())</span>
<span class="n">SOLVER_LO</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m_est</span><span class="p">)</span>
<span class="n">report_solution</span><span class="p">(</span><span class="n">m_est</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_plot</span><span class="p">,</span> <span class="n">f_plot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pool composition p&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Profit&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_convex</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;convex approximation&quot;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_convex</span><span class="o">.</span><span class="n">profit</span><span class="p">()),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.036</span><span class="p">,</span> <span class="mi">106000</span><span class="p">),</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_est</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_est</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="s2">&quot;go&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">m_est</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;local max found&quot;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">m_convex</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_est</span><span class="o">.</span><span class="n">profit</span><span class="p">()),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.045</span><span class="p">,</span> <span class="mi">105000</span><span class="p">),</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Milk pooling v3 (Bilinear formulation)&#39;

Pool composition = 0.0400
Profit = 100088.24

Supplier Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fat</th>
      <th>cost</th>
      <th>location</th>
      <th>Customer 1</th>
      <th>Customer 2</th>
      <th>Customer 3</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>Expense</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Farm A</th>
      <td>0.045</td>
      <td>45.0</td>
      <td>local</td>
      <td>6000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>6000.0000</td>
      <td>270000.0000</td>
    </tr>
    <tr>
      <th>Farm B</th>
      <td>0.030</td>
      <td>42.0</td>
      <td>local</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>0.0000</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>Farm C</th>
      <td>0.033</td>
      <td>37.0</td>
      <td>remote</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3823.5294</td>
      <td>3823.5294</td>
      <td>141470.5882</td>
    </tr>
    <tr>
      <th>Farm D</th>
      <td>0.050</td>
      <td>45.0</td>
      <td>remote</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2676.4706</td>
      <td>2676.4706</td>
      <td>120441.1765</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Customer Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min_fat</th>
      <th>price</th>
      <th>demand</th>
      <th>Farm A</th>
      <th>Farm B</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>fat delivered</th>
      <th>Income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Customer 1</th>
      <td>0.045</td>
      <td>52.0</td>
      <td>6000.0</td>
      <td>6000.0</td>
      <td>0.0</td>
      <td>-0.0</td>
      <td>6000.0</td>
      <td>0.045</td>
      <td>312000.0</td>
    </tr>
    <tr>
      <th>Customer 2</th>
      <td>0.030</td>
      <td>48.0</td>
      <td>2500.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2500.0</td>
      <td>2500.0</td>
      <td>0.040</td>
      <td>120000.0</td>
    </tr>
    <tr>
      <th>Customer 3</th>
      <td>0.040</td>
      <td>50.0</td>
      <td>4000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4000.0</td>
      <td>4000.0</td>
      <td>0.040</td>
      <td>200000.0</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../../_images/6116dab8d10d9f654da837d34d8a2504f3d76dc61795a031dc36c7a5d0c9dc10.png" src="../../_images/6116dab8d10d9f654da837d34d8a2504f3d76dc61795a031dc36c7a5d0c9dc10.png" />
</div>
</div>
<p>The result shows the profit if the pooled milk transported from the remote farms has a fat content <span class="math notranslate nohighlight">\(p = 0.04\)</span> them a profit of 100,088 is realized which is better than 81,000 earned for business as usual with just local suppliers, but falls short of the 122,441 earned if the remote milk supply could be transported without pooling.</p>
<p>With regard to the practical impact, the results of using this particular convex approximation are mixed. The approximation successfully produced a value for the pool composition <span class="math notranslate nohighlight">\(p\)</span> which would produce a profit of over <span class="math notranslate nohighlight">\(100088\)</span>. However, the reported value for <span class="math notranslate nohighlight">\(p\)</span> was actually the smallest of the three local maxima for this problem. This discrepancy may have large consequences regarding the choice of suppliers.</p>
</section>
</section>
<section id="nonlinear-optimization-nlo-solution-with-ipopt">
<h2>Nonlinear Optimization (NLO) solution with ipopt<a class="headerlink" href="#nonlinear-optimization-nlo-solution-with-ipopt" title="Link to this heading">#</a></h2>
<p>The final version of this milk pooling model returns to the bilinear formulation with pool composition <span class="math notranslate nohighlight">\(p\)</span> as a decision variable. The following Pyomo implementation needs to specify a solver capable of solving the resulting problem, in this case we use the nonlinear solver <a class="reference external" href="https://github.com/coin-or/Ipopt"><code class="docutils literal notranslate"><span class="pre">ipopt</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">milk_pooling_bilinear_NLO</span><span class="p">():</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">(</span><span class="s2">&quot;Milk pooling bilinear model&quot;</span><span class="p">)</span>

    <span class="c1"># define sources</span>
    <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">m</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">initialize</span><span class="o">=</span><span class="n">suppliers</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">suppliers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;remote&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># define customers</span>
    <span class="n">m</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">customers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># define flowrates</span>
    <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">]))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">remote_suppliers</span><span class="p">[</span><span class="s2">&quot;fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">remote_suppliers</span><span class="p">[</span><span class="s2">&quot;fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">maximize</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">profit</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">+</span><span class="nb">sum</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
            <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">*</span> <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">customer_demand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;demand&quot;</span><span class="p">]</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pool_balance</span><span class="p">(</span>
        <span class="n">m</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pool_quality</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">R</span>
        <span class="p">)</span>

    <span class="nd">@m</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">customer_quality</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">suppliers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span>
        <span class="p">)</span> <span class="o">&gt;=</span> <span class="n">customers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;min_fat&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># change ipopt options to find global maximum</span>
<span class="n">SOLVER_NLO</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;bound_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="n">m_global</span> <span class="o">=</span> <span class="n">milk_pooling_bilinear_NLO</span><span class="p">()</span>
<span class="n">SOLVER_NLO</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m_global</span><span class="p">)</span>
<span class="n">report_solution</span><span class="p">(</span><span class="n">m_global</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_plot</span><span class="p">,</span> <span class="n">f_plot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pool composition p&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Profit&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_global</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_global</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="s2">&quot;go&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">m_global</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;global max found&quot;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">m_global</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_global</span><span class="o">.</span><span class="n">profit</span><span class="p">()),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.035</span><span class="p">,</span> <span class="mi">87000</span><span class="p">),</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Milk pooling bilinear model

Pool composition = 0.0330
Profit = 102833.33

Supplier Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fat</th>
      <th>cost</th>
      <th>location</th>
      <th>Customer 1</th>
      <th>Customer 2</th>
      <th>Customer 3</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>Expense</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Farm A</th>
      <td>0.045</td>
      <td>45.0</td>
      <td>local</td>
      <td>6000.0001</td>
      <td>-0.0</td>
      <td>2333.3334</td>
      <td>0.0000</td>
      <td>8333.3334</td>
      <td>375000.0037</td>
    </tr>
    <tr>
      <th>Farm B</th>
      <td>0.030</td>
      <td>42.0</td>
      <td>local</td>
      <td>-0.0000</td>
      <td>0.0</td>
      <td>-0.0000</td>
      <td>0.0000</td>
      <td>-0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>Farm C</th>
      <td>0.033</td>
      <td>37.0</td>
      <td>remote</td>
      <td>0.0000</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>4166.6667</td>
      <td>4166.6667</td>
      <td>154166.6683</td>
    </tr>
    <tr>
      <th>Farm D</th>
      <td>0.050</td>
      <td>45.0</td>
      <td>remote</td>
      <td>0.0000</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>-0.0000</td>
      <td>-0.0000</td>
      <td>-0.0000</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Customer Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min_fat</th>
      <th>price</th>
      <th>demand</th>
      <th>Farm A</th>
      <th>Farm B</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>fat delivered</th>
      <th>Income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Customer 1</th>
      <td>0.045</td>
      <td>52.0</td>
      <td>6000.0</td>
      <td>6000.0001</td>
      <td>-0.0</td>
      <td>0.0000</td>
      <td>6000.0001</td>
      <td>0.045</td>
      <td>312000.0031</td>
    </tr>
    <tr>
      <th>Customer 2</th>
      <td>0.030</td>
      <td>48.0</td>
      <td>2500.0</td>
      <td>-0.0000</td>
      <td>0.0</td>
      <td>2500.0000</td>
      <td>2500.0000</td>
      <td>0.033</td>
      <td>120000.0012</td>
    </tr>
    <tr>
      <th>Customer 3</th>
      <td>0.040</td>
      <td>50.0</td>
      <td>4000.0</td>
      <td>2333.3334</td>
      <td>-0.0</td>
      <td>1666.6667</td>
      <td>4000.0000</td>
      <td>0.040</td>
      <td>200000.0020</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../../_images/f61d8b2df984b3da38d2ff21c70d7be49ca11aafd6289008a05d37d4ddc8807b.png" src="../../_images/f61d8b2df984b3da38d2ff21c70d7be49ca11aafd6289008a05d37d4ddc8807b.png" />
</div>
</div>
<p>In this case, the convergence to the global optimum was pure luck. The way general non-linear optimization solvers work is that they begin from an initial solution and improve from then on, stopping when a set of conditions, known as the <strong>KKT conditions</strong>, is met. If we change the <code class="docutils literal notranslate"><span class="pre">ipopt</span></code> settings for how to pick the initial point, we can end up in one of the suboptimal local minima.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># change ipopt options to find local maximum instead of the global one</span>
<span class="n">SOLVER_NLO</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;bound_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">m_global2</span> <span class="o">=</span> <span class="n">milk_pooling_bilinear_NLO</span><span class="p">()</span>
<span class="n">SOLVER_NLO</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m_global2</span><span class="p">)</span>
<span class="n">report_solution</span><span class="p">(</span><span class="n">m_global2</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_plot</span><span class="p">,</span> <span class="n">f_plot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pool composition p&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Profit&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_global</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_global</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="s2">&quot;bo&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">m_global</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;global max&quot;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">m_global</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_global</span><span class="o">.</span><span class="n">profit</span><span class="p">()),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0245</span><span class="p">,</span> <span class="mi">96000</span><span class="p">),</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_global2</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_global2</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="s2">&quot;go&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">m_global2</span><span class="o">.</span><span class="n">profit</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="s2">&quot;local max found&quot;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">m_global2</span><span class="o">.</span><span class="n">p</span><span class="p">(),</span> <span class="n">m_global2</span><span class="o">.</span><span class="n">profit</span><span class="p">()),</span>
    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0495</span><span class="p">,</span> <span class="mi">93000</span><span class="p">),</span>
    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Milk pooling bilinear model

Pool composition = 0.0450
Profit = 101392.16

Supplier Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fat</th>
      <th>cost</th>
      <th>location</th>
      <th>Customer 1</th>
      <th>Customer 2</th>
      <th>Customer 3</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>Expense</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Farm A</th>
      <td>0.045</td>
      <td>45.0</td>
      <td>local</td>
      <td>0.0</td>
      <td>-0.0</td>
      <td>-0.0000</td>
      <td>0.0000</td>
      <td>-0.0000</td>
      <td>-0.0000</td>
    </tr>
    <tr>
      <th>Farm B</th>
      <td>0.030</td>
      <td>42.0</td>
      <td>local</td>
      <td>-0.0</td>
      <td>2500.0</td>
      <td>1333.3333</td>
      <td>0.0000</td>
      <td>3833.3334</td>
      <td>161000.0016</td>
    </tr>
    <tr>
      <th>Farm C</th>
      <td>0.033</td>
      <td>37.0</td>
      <td>remote</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>2549.0196</td>
      <td>2549.0196</td>
      <td>94313.7265</td>
    </tr>
    <tr>
      <th>Farm D</th>
      <td>0.050</td>
      <td>45.0</td>
      <td>remote</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0000</td>
      <td>6117.6471</td>
      <td>6117.6471</td>
      <td>275294.1203</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Customer Report
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min_fat</th>
      <th>price</th>
      <th>demand</th>
      <th>Farm A</th>
      <th>Farm B</th>
      <th>Pool</th>
      <th>Amount</th>
      <th>fat delivered</th>
      <th>Income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Customer 1</th>
      <td>0.045</td>
      <td>52.0</td>
      <td>6000.0</td>
      <td>0.0</td>
      <td>-0.0000</td>
      <td>6000.0001</td>
      <td>6000.0001</td>
      <td>0.045</td>
      <td>312000.0031</td>
    </tr>
    <tr>
      <th>Customer 2</th>
      <td>0.030</td>
      <td>48.0</td>
      <td>2500.0</td>
      <td>-0.0</td>
      <td>2500.0000</td>
      <td>-0.0000</td>
      <td>2500.0000</td>
      <td>0.030</td>
      <td>120000.0012</td>
    </tr>
    <tr>
      <th>Customer 3</th>
      <td>0.040</td>
      <td>50.0</td>
      <td>4000.0</td>
      <td>-0.0</td>
      <td>1333.3333</td>
      <td>2666.6667</td>
      <td>4000.0000</td>
      <td>0.040</td>
      <td>200000.0020</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../../_images/7346548ca836b3fe2a0c613dbf13977da2713409b403f79174246d2c4ae573b6.png" src="../../_images/7346548ca836b3fe2a0c613dbf13977da2713409b403f79174246d2c4ae573b6.png" />
</div>
</div>
</section>
<section id="concluding-remarks">
<h2>Concluding Remarks<a class="headerlink" href="#concluding-remarks" title="Link to this heading">#</a></h2>
<p>The solution for the bilinear pooling model reveals several features of the problem.</p>
<ul class="simple">
<li><p>For the given parameters, pooling raw materials for shipment from remote suppliers yields the most profitable solution, but that solution is only possible because there are local suppliers to augment the pool blend to meet individual customer requirements.</p></li>
<li><p>Customer 2 receives a blend that is 3.3% exceeding the requirement of 3%. This results in some “give away” of product quality in return for the economic benefits of pooling.</p></li>
</ul>
</section>
<section id="bibliographic-notes">
<h2>Bibliographic Notes<a class="headerlink" href="#bibliographic-notes" title="Link to this heading">#</a></h2>
<p>The pooling and blending is a large scale, high value, fundamental problem of logistics for the process and refining industries. The prototypical examples are the pooling and blending crude oils to meet the feed stock constraints of refineries, and for the pooling of refinery products for pipeline delivery to distribution terminals. Un</p>
<p>Haverly (1978) is a commonly cited small benchmark problem for the pooling and blending of sulfurous fuels.</p>
<blockquote>
<div><p>Haverly, C. A. (1978). Studies of the behavior of recursion for the pooling problem. Acm sigmap bulletin, (25), 19-28. <a class="reference external" href="https://dl.acm.org/doi/pdf/10.1145/1111237.1111238">https://dl.acm.org/doi/pdf/10.1145/1111237.1111238</a></p>
</div></blockquote>
<p>There is an extensive literature on pooling and blending. The following encyclopedia entry explains the history of the pooling problem, how it leads to multiple local minima and other pathological behaviors, and approaches to finding practical solutions.</p>
<blockquote>
<div><p>Visweswaran, V. (2009). MINLP: Applications in Blending and Pooling Problems. <a class="reference external" href="https://link.springer.com/referenceworkentry/10.1007/978-0-387-74759-0_375">https://link.springer.com/referenceworkentry/10.1007/978-0-387-74759-0_375</a></p>
</div></blockquote>
<p>Recent research overviews include</p>
<blockquote>
<div><p>Misener, R., &amp; Floudas, C. A. (2009). Advances for the pooling problem: Modeling, global optimization, and computational studies. Applied and Computational Mathematics, 8(1), 3-22. <a class="reference external" href="https://www.researchgate.net/profile/Ruth-Misener/publication/242290955_Advances_for_the_pooling_problem_Modeling_global_optimization_and_computational_studies_Survey/links/0046352e7d1dfeb40f000000/Advances-for-the-pooling-problem-Modeling-global-optimization-and-computational-studies-Survey.pdf">https://www.researchgate.net/profile/Ruth-Misener/publication/242290955_Advances_for_the_pooling_problem_Modeling_global_optimization_and_computational_studies_Survey/links/0046352e7d1dfeb40f000000/Advances-for-the-pooling-problem-Modeling-global-optimization-and-computational-studies-Survey.pdf</a></p>
</div></blockquote>
<blockquote>
<div><p>Gupte, A., Ahmed, S., Dey, S. S., &amp; Cheon, M. S. (2013). Pooling problems: relaxations and discretizations. School of Industrial and Systems Engineering, Georgia Institute of Technology, Atlanta, GA. and ExxonMobil Research and Engineering Company, Annandale, NJ. <a class="reference external" href="http://www.optimization-online.org/DB_FILE/2012/10/3658.pdf">http://www.optimization-online.org/DB_FILE/2012/10/3658.pdf</a></p>
</div></blockquote>
<p>The current state-of-the-art appears to be a formulation of the pooling problem is a mixed-integer quadratically-constrained quadratic optimization on a given network.</p>
<blockquote>
<div><p>Ceccon, F., &amp; Misener, R. (2022). Solving the pooling problem at scale with extensible solver GALINI. Computers &amp; Chemical Engineering, 107660. <a class="reference external" href="https://arxiv.org/pdf/2105.01687.pdf">https://arxiv.org/pdf/2105.01687.pdf</a></p>
</div></blockquote>
<p>Applications for pooling and blending are probably underappreciated. In particular, what role might pooling and blending problems have in projects like the World Food Programme (WFP)?</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/05"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="05.00.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">5. Convex Optimization</p>
      </div>
    </a>
    <a class="right-next"
       href="02-ols-regression.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">5.2 Ordinary Least Squares (OLS) Regression</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble-install-pyomo-and-a-solver">Preamble: Install Pyomo and a solver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-description-pooling-milk-for-wholesale-blending-and-distribution">Problem description: Pooling milk for wholesale blending and distribution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-business-as-usual">Option 1. Business as usual</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-buy-an-additional-truck">Option 2. Buy an additional truck</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-pool-delivery-from-remote-suppliers">Option 3. Pool delivery from remote suppliers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pooling-problem">Pooling problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-are-bilinear-problems-hard">Why are bilinear problems hard?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convex-approximation">Convex Approximation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-optimization-nlo-solution-with-ipopt">Nonlinear Optimization (NLO) solution with ipopt</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concluding-remarks">Concluding Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bibliographic-notes">Bibliographic Notes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The MO Book Group
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>